<?php $stopwatch=microtime(); define('IGNORE_VERSION_MISMATCH',false); define('E2_VERSION',3254); define('E2_RELEASE','2.7'); define('E2_UA_STRING','E2 (v'. E2_VERSION .'; Aegea)'); define('E2_MINIMUM_PHP','5.3.9'); define('RSS_AS_TEXT',0); define('BUILDER_OBFUSCATE',1); define('BUILDER_FLATTEN',1); header('X-Powered-By: E2 Aegea v'. E2_VERSION); if(version_compare(PHP_VERSION,E2_MINIMUM_PHP) < 0){ die ('PHP version must be '. E2_MINIMUM_PHP .' or later, you are running '. PHP_VERSION); } define('OUTPUT_CHARSET','UTF-8'); setlocale(LC_CTYPE,'ru_RU.UTF'); mb_internal_encoding('UTF-8'); define('HSC_ENC','UTF-8'); if(function_exists('date_default_timezone_set'))date_default_timezone_set('GMT'); error_reporting(E_ALL); define('RUN_ID',chr(rand(65,90))); define('DEV_TRACK_TIME',false); define('DEV_HOST','e2'); define('SECONDS_IN_A_MINUTE',60); define('SECONDS_IN_AN_HOUR',3600); define('SECONDS_IN_A_DAY',86400); define('SECONDS_IN_A_MONTH',2592000); define('SECONDS_IN_A_YEAR',31536000); define('YEAR_DISPLAY_THRESH',7884000); define('KILO_THRESH',768); define('BYTES_DECIMALS',1); define('FILE_READ_BUFFER',64*1024); define('KEYWORDS_MANY_THRESH',50); if(defined('JSON_PRETTY_PRINT')) { define('E2_JSON_STYLE',JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE); } else { define('E2_JSON_STYLE',0); } define('NEW_FILES_RIGHTS',0777); if(is_file('multiuser')) { define('USER_MODE','multi'); } else { define('USER_MODE','single'); } if(is_file('superconfig.php')) { include 'superconfig.php'; } $_protocol=( !empty ($_SERVER['HTTPS']) && $_SERVER['HTTPS']!=='off' or $_SERVER['SERVER_PORT']==443 or isset ($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO']=='https' or isset ($_SERVER['HTTP_X_HTTPS']) && ($_SERVER['HTTP_X_HTTPS']) ) ? 'https':'http'; if(is_file('force-https')) { $_protocol='https'; } $aa57c1=substr( $_SERVER['PHP_SELF'],0,strpos($_SERVER['PHP_SELF'],'/index.php') ); list ($x57de2, ) = explode(':',$_SERVER['HTTP_HOST']); $full_blog_url=$_protocol. '://'. $x57de2.$aa57c1; $_user_folder_name=str_replace('/','--',$x57de2.$aa57c1); if(substr($_user_folder_name,0,4)=='www.'){ $_user_folder_name=substr($_user_folder_name,4); } if(USER_MODE=='multi'){ if (@array_key_exists($_user_folder_name,$_superconfig['rewrites'])) { $_user_folder_name=$_superconfig['rewrites'][$_user_folder_name]; } define('USER_FOLDER','users/'. $_user_folder_name .'/'); } else { define('USER_FOLDER', @$__E2_FOLDER_PREFIX__.'user/'); } if(@$_superconfig['store_files_by_users']) { define('MEDIA_ROOT_FOLDER',USER_FOLDER .'files/'); } else { define('MEDIA_ROOT_FOLDER',''); } define('EXTRAS_FOLDER',USER_FOLDER.'extras/'); define('BACKUP_FOLDER',USER_FOLDER.'backup/'); define('CACHES_FOLDER',USER_FOLDER.'caches/'); define('USER_LIBRARY_FOLDER',USER_FOLDER.'library/'); define('LOG_FILE',USER_FOLDER.'log.txt'); define('LOG_SPECIAL_FILE',USER_FOLDER.'log-special.txt'); define('PICTURES_FOLDER','pictures/'); define('THUMBNAILS_FOLDER','pictures/thumbs/'); define('AUDIO_FOLDER','audio/'); define('TEMPLATES_FOLDER','themes/'); define('SYSTEM_FOLDER','system/'); define('SCRIPTS_FOLDER','system/js/'); define('SYSTEM_LIBRARY_FOLDER','system/library/'); define('SYSTEM_TEMPLATE_FOLDER','system/theme/'); define('DEFAULT_USERPIC_FILENAME','system/theme/images/userpic.svg'); define('DEFAULT_USERPIC_PLACEHOLDER_FILENAME','system/theme/images/userpic-placeholder.svg'); define('AUDIO_ICON_IMAGE','system/theme/images/audio.svg'); define('AUDIO_ICON_WIDTH',64); define('AUDIO_ICON_HEIGHT',64); define('LANGUAGES_FOLDER','system/languages/'); define('DEFAULTS_FOLDER','system/default/'); define('MTMPL_FOLDER','system/default/mail/'); define('DEFAULT_TEMPLATE','plain'); if(substr(@$_SERVER['HTTP_ACCEPT_LANGUAGE'],0,2)=='ru'){ define('DEFAULT_LANGUAGE','ru'); } else { define('DEFAULT_LANGUAGE','en'); } @include DEFAULTS_FOLDER. 'config.php'; $_default_config=$_config; @include USER_FOLDER. 'config.php'; $_config=array_merge($_default_config,$_config); if( $_config['write_log'] and ($_config['write_log_create'] or is_file(LOG_FILE)) )define('__LOG',1); else define('__LOG',0); if(@$_config['write_log_limit'] and is_file(LOG_FILE)) { $gbc7b3=@stat(LOG_FILE); $gbc7b3=$gbc7b3['size']; if ($gbc7b3 > $_config['write_log_limit']) { @rename(LOG_FILE,LOG_FILE .'.bak'); @chmod(LOG_FILE .'.bak',NEW_FILES_RIGHTS); @file_put_contents(LOG_FILE,''); } } define('CACHE',true); define('CACHE_NOTES',CACHE and true); define('CACHE_NOTES_COMMENTS',CACHE and true); define('CACHE_POPULAR',CACHE and true); define('CACHE_HOT',CACHE and true); define('CACHE_FAVS',CACHE and true); define('CACHE_TAGS',CACHE and true); define('CACHE_FAVTAGS',CACHE and true); define('CACHE_NOTES_COUNTS',CACHE and true); define('CACHE_EDGE_TIMEINFO',CACHE and true); define('CACHE_FRONTPAGE',CACHE and true); define('CACHE_FRONTPAGE_FEED',CACHE and true); define('CACHE_FULLLIST',CACHE and true); define('CACHE_DRAFTS',CACHE and true); define('CACHE_DRAFTS_ALIAS_USE_COUNTS',CACHE and true); define('CACHE_LASTMODIFIEDS',CACHE and true); define('CACHE_FILENAMES_NOTES',CACHES_FOLDER.'note-*.ctree.psa'); define('CACHE_FILENAMES_NOTES_COMMENTS', CACHES_FOLDER.'note-*-comments.ctree.psa' ); define('CACHE_FILENAMES_NOTES_COUNTS',CACHES_FOLDER.'notes-count-*.txt'); define('CACHE_FILENAMES_EDGE_TIMEINFO',CACHES_FOLDER.'*.e2time.psa'); define('CACHE_FILENAME_POPULAR',CACHES_FOLDER.'popular.ctree.psa'); define('CACHE_FILENAME_POPULAR_EXPIRES',CACHES_FOLDER.'popular-expires.txt'); define('CACHE_FILENAME_HOT',CACHES_FOLDER.'hot.ctree.psa'); define('CACHE_FILENAME_HOT_EXPIRES',CACHES_FOLDER.'hot-expires.txt'); define('CACHE_FILENAME_FAVS',CACHES_FOLDER.'favourites.ctree.psa'); define('CACHE_FILENAME_TAGS',CACHES_FOLDER.'tags.ctree.psa'); define('CACHE_FILENAME_TAGS_AUTHOR',CACHES_FOLDER.'tags-author.ctree.psa'); define('CACHE_FILENAME_FAVTAGS',CACHES_FOLDER.'favtags.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE',CACHES_FOLDER.'frontpage.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_AUTHOR',CACHES_FOLDER.'frontpage-author.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_FEED',CACHES_FOLDER.'frontpage-feed.psa'); define('CACHE_FILENAME_FULLLIST',CACHES_FOLDER.'notes-list.ctree.psa'); define('CACHE_FILENAME_DRAFTS',CACHES_FOLDER.'drafts.psa'); define('CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS',CACHES_FOLDER.'drafts-auc.psa'); define('CACHE_FILENAME_LASTMODIFIEDS',CACHES_FOLDER.'last-modifieds-by-id.psa'); define('E2E_STRANGE_ERROR',10); define('E2E_USER_ERROR',20); define('E2E_PERMISSIONS_ERROR',30); define('E2E_DATABASE_ERROR',40); define('E2E_MESSAGE',100); define('E2E_DIAGNOSTICS_MESSAGE',110); define('DB_PASSWORD_RECOVER_AND_SHOW',false); define('DEFAULT_ITEMS_PER_PAGE',10); define('MAX_ITEMS_PER_PAGE',100); define('DB_OK',0); define('DB_CANNOT_FIND', -1); define('DB_CANNOT_CONNECT', -2); define('DB_DB_QUERY_ERROR', -3); define('FP_NO_ID_OR_NEW', -1); define('FP_INSERT_ERROR', -10); define('FP_UPDATE_ERROR', -11); define('FP_EMPTY_FIELD', -20); define('FP_TITLE_OR_TEXT_EMPTY', -21); define('FP_NOT_COMMENTABLE', -30); define('FP_COMMENT_DOUBLE_POST', -101); define('FP_COMMENT_TOO_LONG', -102); define('FP_COMMENT_SPAM_SUSPECT', -103); define('NOTE_COMMENTABLE_NOW', -1); define('NOTE_COMMENTABLE_NOW_CONDITIONALLY', -2); define('ENTITY_TYPE_UNSPECIFIED',''); define('ENTITY_TYPE_NOTE','n'); define('ENTITY_TYPE_TAG','t'); define('THUMB_WIDTH',200); define('THUMB_HEIGHT',160); define('THUMB_JPG_QUALITY',90); define('SCALED_IMAGE_JPG_QUALITY',80); define('USERPIC_WIDTH',80); define('USERPIC_HEIGHT',80); define('USERPIC_JPG_QUALITY',90); define('RESOURCES_ALL',0); define('RESOURCES_LOCAL',1); $r5269f=@$_SERVER['HTTP_USER_AGENT'] or $r5269f=''; $_ios=strstr($r5269f,'iPhone') || strstr($r5269f,'iPad'); $_macintosh=strstr($r5269f,'Macintosh'); error_reporting(E_ALL); $_db_error=false; $_fp_error=false; $f589b3=true; if(strstr(__FILE__,'all.php'))$f589b3=false; function __log($h1cb25,$xc9e9a=0){ global$stopwatch,$_log_depth; if ($h1cb25===null){ if(function_exists('file_put_contents')) { @file_put_contents(LOG_FILE,''); @chmod(LOG_FILE,NEW_FILES_RIGHTS); } return; } $v605ac=''; $jaf240=str_pad(round(w7f78()-$stopwatch,5),10,' ',STR_PAD_RIGHT); if ($h1cb25[0]=='}'){ -- $_log_depth; if($_log_depth < 0)$_log_depth=0; } $f8e13f=( RUN_ID .' '. $v605ac .''. $jaf240 .' '. str_repeat(' ',$_log_depth*2). $h1cb25."\n" ); if ($h1cb25[strlen($h1cb25)-1]=='{'){ ++ $_log_depth; } $t15d61=FILE_APPEND; if(function_exists('file_put_contents')) { @file_put_contents(LOG_FILE,$f8e13f,$t15d61); @chmod(LOG_FILE,NEW_FILES_RIGHTS); if ($h1cb25[0]=='#'){ @file_put_contents(LOG_SPECIAL_FILE,$f8e13f,$t15d61); @chmod(LOG_SPECIAL_FILE,NEW_FILES_RIGHTS); } } } function e2_go_to($k56790=''){ global$_protocol,$errors,$x57de2,$aa57c1; @session_start(); $_SESSION['errors']=$errors; if(substr($k56790,0,strlen($_protocol)+3)!=$_protocol .'://'){ header('Location: '. $_protocol .'://'. $x57de2.$aa57c1 .'/'. $k56790); } else { header('Location: '. $k56790); } flush(); return true; } function v4930(){ $a469bb=$_SERVER['HTTP_REFERER']; return e2_go_to($a469bb); } function z4924($k56790){ if($_SERVER['HTTP_REFERER'])$k56790=$_SERVER['HTTP_REFERER']; return e2_go_to($k56790); } function e8c3b($mb2145=''){ $i9dd4e=substr_count($_SERVER['HTTP_HOST'],'.'); $i2cb9d=@str_repeat('_',$i9dd4e).$mb2145; return $i2cb9d; } function nc64a($mb2145,$g2063c='',$jb0b70=true){ $mcd91e=$jb0b70? (time()+3600*24*365) : (0); $oad5f8=$_SERVER['HTTP_HOST']; $we9c6c=substr_count($oad5f8,'.'); if ($we9c6c < 3)$oad5f8=str_repeat('.',3-$we9c6c).$oad5f8; $i9dd4e=setcookie(e8c3b($mb2145),$g2063c,$mcd91e,'/'); } function v163d($r183d6,$jb45cf,$pcadc8=''){ if(trim($jb45cf)!=''){ $jb45cf=explode($r183d6,$jb45cf); foreach ($jb45cf as $q865c0 => $c8ce4b)$jb45cf[$q865c0]=trim($c8ce4b); foreach ($jb45cf as $q865c0 => $c8ce4b) if ($c8ce4b=='') unset ($jb45cf[$q865c0]); $q7b774=array_unique($jb45cf); if ('sort'==$pcadc8)sort($q7b774); return $q7b774; } else return array (); } function ae1e7($jcdaee,$action,$w4a202){ if (!is_array($jcdaee))$jcdaee=array(); if($action=='add'){ $jcdaee=array_unique(array_merge($jcdaee,$w4a202)); } if($action=='remove'){ unset ($jcdaee[array_search($w4a202,$jcdaee)]); } if (!is_array($jcdaee))$jcdaee=array(); return $jcdaee; } function kbb8d($jb45cf){ global$_macintosh,$_ios; if($_ios) return ''; if ($jb45cf=='submit'){ if($_macintosh){ return '&#x2303; &#x21a9;'; } else { return 'Ctrl + Enter'; } } if ($jb45cf=='livesave'){ if($_macintosh){ return '&#x2318; S'; } else { return 'Ctrl + S'; } } if ($jb45cf=='navigation'){ if($_macintosh){ return '&#x2325;'; } else { return 'Ctrl'; } } if ($jb45cf=='navigation-later'){ if($_macintosh){ return '&#x2325; &uarr;'; } else { return 'Ctrl + &uarr;'; } } if ($jb45cf=='navigation-earlier'){ if($_macintosh){ return '&#x2325; &darr;'; } else { return 'Ctrl + &darr;'; } } } function u7b91($h1cb25){ $h1cb25=str_replace('<','&lt;',$h1cb25); $h1cb25=str_replace('>','&gt;',$h1cb25); return $h1cb25; } function rc4b6($h1cb25){ $h1cb25=str_replace('"','&quot;',$h1cb25); return $h1cb25; } function sd056($g2063c,$z5d6db){ return str_replace('.',',',round($g2063c,$z5d6db)); } function e2_stripslashes_array($of1f71){ return is_array($of1f71)?array_map('e2_stripslashes_array',$of1f71):stripslashes($of1f71); } function x269a(){ if(get_magic_quotes_runtime()) { set_magic_quotes_runtime(0); } if(get_magic_quotes_gpc()) { $_GET=e2_stripslashes_array($_GET); $_POST=e2_stripslashes_array($_POST); $_COOKIE=e2_stripslashes_array($_COOKIE); $_REQUEST=e2_stripslashes_array($_REQUEST); } } function m0786($a957b5){ return sprintf('%u',ip2long($a957b5)); } function s7c85($zb1bc2){ return long2ip(sprintf('%d',$zb1bc2)); } function e2_decline_for_number($h1cb25,$zb1bc2=null){ $g2f713=$h1cb25; if ($zb1bc2===null){ $zb1bc2=substr($h1cb25,0,strpos($h1cb25,' ')); $g2f713=substr($h1cb25,strpos($h1cb25,' ')+1); } $cf07c9=strpos($g2f713,'('); $j46901=strpos($g2f713,')'); if ($j46901 > $cf07c9)$r22b9f=substr($g2f713,$cf07c9,$j46901-$cf07c9+1); $y93da6=explode(',',trim(@$r22b9f,'()')); if(count($y93da6)==2)array_unshift($y93da6,''); $hc78bd=array (2,0,1,1,1,2,2,2,2,2); if ($zb1bc2%100 > 10 and $zb1bc2%100 < 20)$zcd14c=2; else $zcd14c=$hc78bd[$zb1bc2%10]; $sef3e3=$y93da6[$zcd14c]; $h1cb25=str_replace($r22b9f,$sef3e3,$h1cb25); if(strstr($h1cb25,'(') and strstr($h1cb25,')')) { return e2_decline_for_number($h1cb25,$zb1bc2); } else { return $h1cb25; } } function nc5a6($cf2ce1){ $p87e9e=glob($cf2ce1,GLOB_NOSORT); if(is_array($p87e9e)) { foreach ($p87e9e as $n435ed){ @unlink($n435ed); } } } function s74dc($m73600){ $p87e9e=glob($m73600 .'*',GLOB_NOSORT); if(is_array($p87e9e)) { foreach ($p87e9e as $n435ed){ if(basename($n435ed)!='.' and basename($n435ed)!='..'){ if(is_dir($n435ed)) { if (s74dc($n435ed .'/')) { if (!rmdir($n435ed)) { return false; } } else { return false; } } else { @unlink($n435ed); } } } return true; } else { return false; } } function maf42($fd6fe1){ $fd6fe1=trim($fd6fe1,'/'); $fd6fe1=explode('/',$fd6fe1); $m73600=''; foreach ($fd6fe1 as $p83878){ $m73600=$m73600.$p83878; if (!is_dir($m73600)) { if (@mkdir($m73600)) { @chmod($m73600,NEW_FILES_RIGHTS); } else { return false; } } $m73600=$m73600.'/'; } return true; } function w4d36($fd6fe1){ return preg_replace('/\/([^\/]+?)\/\.\./','',$fd6fe1); } function jce9b($jb45cf){ $scee6f=get_html_translation_table(HTML_ENTITIES); $scee6f=array_flip($scee6f); return strtr($jb45cf,$scee6f); } function w7f78($m32c11=NULL){ if(NULL==$m32c11)$m32c11=microtime(); list ($m6021b,$p74459)=explode(' ',$m32c11); return ((float)$m6021b + (float)$p74459); } $stopwatch=w7f78($stopwatch); function o3aa5($i9dd4e){ global$_e2utf8__unformat_htmlentity_neasden; if($_e2utf8__unformat_htmlentity_neasden){ return $i9dd4e; } else { return '((html '. $i9dd4e .'))'; } } function pedd9($ie98a6,$z98df3=false){ $l80a41=''; $ef5a8e=strlen($ie98a6); for ($q865c0=0; $q865c0 < 256; ++ $q865c0){ $of3d13[$q865c0]=0; $n0fc3c=$q865c0; while ($n0fc3c & 0x00000080){ $n0fc3c <<= 1; ++ $of3d13[$q865c0]; } } for ($q865c0=0xd090; $q865c0 <= 0xd0bf; $q865c0++)$r84a26[$q865c0]=chr(($q865c0 & 0x000000ff)+48); for ($q865c0=0xd180; $q865c0 <= 0xd18f; $q865c0++)$r84a26[$q865c0]=chr(($q865c0 & 0x000000ff)+112); $r84a26[0xd081]="\xa8"; $r84a26[0xd191]="\xb8"; $r84a26[0xc299]="\x99"; $r84a26[0xc2a9]="\xa9"; $r84a26[0xc2ae]="\xae"; $r84a26[0xc2ab]="\xab"; $r84a26[0xc2bb]="\xbb"; $r84a26[0xc2a0]="\xa0"; $q865c0=0; while ($q865c0 < $ef5a8e){ $uac558=$ie98a6{$q865c0}; $qc267c=ord($uac558); if ($of3d13[$qc267c]==0){ $l80a41.=$uac558; ++ $q865c0; } elseif ($of3d13[$qc267c]==2){ $p06214=$r84a26[($qc267c << 8) | ord($ie98a6{$q865c0+1})]; $l80a41 .= ($p06214!=null)? $p06214 : ( $z98df3? (o3aa5( iebe5(substr($ie98a6,$q865c0,2)) )) : '?' ); $q865c0+=2; } else { $idfbc9=substr($ie98a6,$q865c0,$of3d13[$qc267c]); if ($idfbc9=="\xe2\x84\x96")$l80a41.="\xb9"; elseif ($idfbc9=="\xe2\x80\x93")$l80a41.="\x96"; elseif ($idfbc9=="\xe2\x80\x94")$l80a41.="\x97"; elseif ($idfbc9=="\xe2\x80\x98")$l80a41.="\x91"; elseif ($idfbc9=="\xe2\x80\x99")$l80a41.="\x92"; elseif ($idfbc9=="\xe2\x80\x9a")$l80a41.="\x82"; elseif ($idfbc9=="\xe2\x80\x9c")$l80a41.="\x93"; elseif ($idfbc9=="\xe2\x80\x9d")$l80a41.="\x94"; elseif ($idfbc9=="\xe2\x80\x9e")$l80a41.="\x84"; elseif ($idfbc9=="\xe2\x80\xa6")$l80a41.="\x85"; elseif ($idfbc9=="\xe2\x80\xb9")$l80a41.="\x8b"; elseif ($idfbc9=="\xe2\x80\xba")$l80a41.="\x9b"; elseif ($idfbc9=="\xe2\x82\xac")$l80a41.="\x88"; elseif ($idfbc9=="\xe2\x84\xa2")$l80a41.="\x99"; else $l80a41.=$z98df3? (o3aa5( iebe5($idfbc9) )) : '?'; $q865c0+=$of3d13[$qc267c]; } } return $l80a41; } function iebe5($y4a8a0){ $kcc411=''; $ef5a8e=strlen($y4a8a0); for ($q865c0=0; $q865c0 < $ef5a8e; ++ $q865c0){ $kcc411.=preg_replace('/^1*0/','',decbin(ord($y4a8a0{$q865c0}))); } return '&#'. bindec($kcc411) .';'; } function ofd97($d341be) { $i2cb9d=$d341be; $i2cb9d=preg_replace_callback('/([\x80-\xFF])/','e2_utf_from_windows_1251_char',$i2cb9d); return $i2cb9d; } function e2_utf_from_windows_1251_char($y4a8a0){ list (, $y4a8a0)=$y4a8a0; if ($y4a8a0=="\xa8") return "\xd0\x81"; if ($y4a8a0=="\xb8") return "\xd1\x91"; if ($y4a8a0 >= "\xc0" && $y4a8a0 <= "\xef") return "\xd0".chr(ord($y4a8a0)-48); if ($y4a8a0 >= "\xf0") return "\xd1".chr(ord($y4a8a0)-112); if ($y4a8a0=="\x85") return "\xe2\x80\xa6"; if ($y4a8a0=="\x96") return "\xe2\x80\x93"; if ($y4a8a0=="\x97") return "\xe2\x80\x94"; if ($y4a8a0=="\xab") return "\xc2\xab"; if ($y4a8a0=="\xbb") return "\xc2\xbb"; if ($y4a8a0=="\x91") return "\xe2\x80\x98"; if ($y4a8a0=="\x92") return "\xe2\x80\x99"; if ($y4a8a0=="\x93") return "\xe2\x80\x9c"; if ($y4a8a0=="\x94") return "\xe2\x80\x9d"; if ($y4a8a0=="\x84") return "\xe2\x80\x9e"; if ($y4a8a0=="\x99") return "\xe2\x84\xa2"; if ($y4a8a0=="\xb9") return "\xe2\x84\x96"; if ($y4a8a0=="\xa0") return "\xc2\xa0"; return '?'; }; function e2_utf8_version_of_array_($of1f71){ foreach ($of1f71 as $c8ce4b => $l9e366){ if (!array_key_exists($c8ce4b.'.u?',$of1f71)) { if(is_string($of1f71[$c8ce4b])) { $of1f71[$c8ce4b]=ofd97($of1f71[$c8ce4b]); } elseif(is_array($of1f71[$c8ce4b])) { $of1f71[$c8ce4b]=e2_utf8_version_of_array_($of1f71[$c8ce4b]); } } } return $of1f71; } function rff7c($d341be){ return preg_replace('/[\x{10000}-\x{fffff}]/u','?',$d341be); } $_folders_written=array ( '.', USER_FOLDER, CACHES_FOLDER, BACKUP_FOLDER, MEDIA_ROOT_FOLDER.PICTURES_FOLDER, MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER, MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'remote/', MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER .'remote/', MEDIA_ROOT_FOLDER.AUDIO_FOLDER, ); $_files_written=array ( USER_FOLDER.'password-hash.psa', USER_FOLDER.'password-wait.psa', USER_FOLDER.'last-comment.psa', USER_FOLDER.'new-uploads.psa', USER_FOLDER.'settings.json', USER_FOLDER.'indexing.psa', USER_FOLDER.'auth.psa', USER_FOLDER.'log.txt', ); define('CROP_NONE',0); define('CROP_SQUARE',1); define('PROVIDE_DATA_SPAWN',10); define('PROVIDE_DATA_NOW',20); function lea70(){ global$_folders_written,$_files_written; clearstatcache(); $w10ae9=array(); foreach($_folders_written as $b8fa14){ if(is_dir($b8fa14) and !is_writable($b8fa14)) { $w10ae9[] = $b8fa14; } } foreach($_files_written as $b8fa14){ if(is_file($b8fa14) and !is_writable($b8fa14)) { $w10ae9[] = $b8fa14; } } return $w10ae9; } function t6e52($m8c7dd,$jb45cf){ if (!@file_put_contents($m8c7dd,$jb45cf,LOCK_EX)) { return false; } @chmod($m8c7dd,NEW_FILES_RIGHTS); return true; } function n25cb($n435ed,$m3dbb8){ if ($m3dbb8){ $z80127=explode('/',$n435ed); $r954eb=array_pop($z80127); $m35b88=explode('.',$r954eb); if(count($m35b88) < 2)$m35b88[] = ''; $iabf77=array_pop($m35b88); $m35b88[] = $m3dbb8; if ($iabf77)$m35b88[] = $iabf77; $r954eb=implode('.',$m35b88); $z80127[] = $r954eb; $n435ed=implode('/',$z80127); } return $n435ed; } function g291d($n435ed,$m6890f=false){ $jd1789=array ( 'w' => THUMB_WIDTH, 'h' => THUMB_HEIGHT, 'q' => THUMB_JPG_QUALITY ); if(preg_match('/^https?\:\/\//iu',$n435ed)) { $laf721=$n435ed; $u6efa1=$n435ed; $u6efa1=preg_replace('/^https?\:\/\//iu','',$u6efa1); $u6efa1=str_replace('/','--',$u6efa1); $u6efa1=MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER.$u6efa1; } else { $laf721=MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$n435ed; $u6efa1=MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER.$n435ed; } $u6efa1=n25cb($u6efa1,'thumb@2x'); $ze70c4=w8611( $laf721, $u6efa1, $jd1789, CROP_NONE, $m6890f ); $ef5a8e=strlen(MEDIA_ROOT_FOLDER); if(substr($ze70c4,0,$ef5a8e)==MEDIA_ROOT_FOLDER){ $ze70c4=substr($ze70c4,$ef5a8e); } return $ze70c4; } function b30f2($laf721){ $i8743c=pathinfo($laf721); $iabf77=$i8743c['extension']; return (in_array(strtolower($iabf77), array ('jpg','jpeg','gif','png','svg'))); } function pb6c5($laf721){ $i8743c=pathinfo($laf721); $iabf77=$i8743c['extension']; return (in_array(strtolower($iabf77), array ('jpg','jpeg','gif','png'))); } function oef67($laf721){ $i8743c=pathinfo($laf721); $iabf77=$i8743c['extension']; if ($iabf77=='png') return IMAGETYPE_PNG; if ($iabf77=='gif') return IMAGETYPE_GIF; if ($iabf77=='jpg' or $iabf77=='jpeg') return IMAGETYPE_JPEG; } function w19a4($n435ed){ if (pb6c5($n435ed)) { list ($ieaae2,$cb435e)=getimagesize($n435ed); } else { $fe2da9=simplexml_load_string(file_get_contents($n435ed)); if ($fe2da9){ $fd0a5e=$fe2da9->attributes(); list ($ieaae2,$cb435e) = array ((string)$fd0a5e -> width, (string)$fd0a5e -> height); } else { return false; } } if(substr($n435ed,strrpos($n435ed,'.')-3,3)=='@2x'){ $ieaae2=(int)floor($ieaae2/2); $cb435e=(int)floor($cb435e/2); } return array ($ieaae2,$cb435e); } function e2s_retrieve($parameters){ $p36cd3=urldecode(base64_decode($parameters['source'])); if(__LOG)__log('Retrieve: '. $p36cd3); n1066($p36cd3,PROVIDE_DATA_NOW); } function jbcd0($f447b7){ global$full_blog_url; $e78f08=parse_url($f447b7); if (isset ($e78f08['scheme'])) { if (b30f2($e78f08['path'])) { return array ( 'type' => 'remote-image', 'is-local?' => false, ); } elseif ($e78f08['host']=='www.youtube.com'){ $xb80bb=basename($e78f08['path']); $l15ba8='remote/youtube-'. $xb80bb .'-cover.jpg'; return array ( 'type' => 'online-video', 'is-local?' => false, 'video-service' => 'youtube', 'video-id' => $xb80bb, 'local-cover-name' => $l15ba8, 'local-cover-href' => $full_blog_url .'/'. PICTURES_FOLDER.$l15ba8, 'local-full-filename' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$l15ba8, 'local-full-failname' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$l15ba8.'.failed', ); } elseif ($e78f08['host']=='player.vimeo.com'){ $xb80bb=basename($e78f08['path']); $l15ba8='remote/vimeo-'. $xb80bb .'-cover.jpg'; return array ( 'type' => 'online-video', 'is-local?' => false, 'video-service' => 'vimeo', 'video-id' => $xb80bb, 'local-cover-name' => $l15ba8, 'local-cover-href' => $full_blog_url .'/'. PICTURES_FOLDER.$l15ba8, 'local-full-filename' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$l15ba8, 'local-full-failname' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$l15ba8.'.failed', ); } } else { if (b30f2($e78f08['path'])) { return array ( 'type' => 'local-image', 'is-local?' => true, 'local-href' => $full_blog_url .'/'. PICTURES_FOLDER.$e78f08['path'], 'local-full-filename' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$e78f08['path'] ); } else { return array ( 'type' => 'local-non-image', 'is-local?' => true, ); } } } function n1066($f447b7,$cdb88a){ $w1c149=jbcd0($f447b7); if ($w1c149['type']=='remote-image'){ } elseif ($w1c149['type']=='online-video'){ if(is_file($w1c149['local-full-filename'])) { if(__LOG)__log('Already exists: '. $w1c149['local-full-filename']); } elseif(is_file($w1c149['local-full-failname'])) { if(__LOG)__log('Already tried and failed: '. $w1c149['local-full-filename']); } else { if(__LOG)__log($f447b7.' is missing a cover, retrieving'); if ($cdb88a==PROVIDE_DATA_SPAWN){ ucc38(y83c8('e2s_retrieve', array ( 'source' => urlencode(base64_encode($f447b7)), ))); } if ($cdb88a==PROVIDE_DATA_NOW){ if ($w1c149['video-service']=='youtube') { $e5f89d=array ( 'maxresdefault','hqdefault','mqdefault','sddefault','default' ); foreach ($e5f89d as $zd7d16){ $j572d4='http://img.youtube.com/vi/'. $w1c149['video-id'] .'/'. $zd7d16 .'.jpg'; if(__LOG)__log('Getting '.$j572d4 .' as '. $w1c149['local-full-filename']); $e6c43d=file_get_contents($j572d4); if ($e6c43d!==false) break; } } if ($w1c149['video-service']=='vimeo') { $oc4a72=unserialize( file_get_contents('http://vimeo.com/api/v2/video/'. $w1c149['video-id'] .'.php') ); if (isset ($oc4a72[0]['thumbnail_large'])) { $e6c43d=file_get_contents($oc4a72[0]['thumbnail_large']); } } if ($e6c43d!==false){ t6e52($w1c149['local-full-filename'],$e6c43d); } else { t6e52($w1c149['local-full-failname'],''); } } } if ($cdb88a==PROVIDE_DATA_NOW){ if(is_file($w1c149['local-full-filename'])) { g291d($w1c149['local-cover-name']); } } } elseif ($w1c149['type']=='local-image'){ if(__LOG)__log($f447b7.' is a local image'); g291d($f447b7); } elseif ($w1c149['type']=='local-non-image'){ if(__LOG)__log($f447b7.' is a local non-image'); } } function w6be4($w10ae9){ if (!is_array($w10ae9)) return; if(__LOG)__log('Provide data for resources {'); foreach ($w10ae9 as $f447b7){ n1066($f447b7,PROVIDE_DATA_SPAWN); } if(__LOG)__log('}'); } function gf898($u89111,$gdffc4,$re449c){ $z5128f=nfb75($u89111,$gdffc4); $o55b55=array_merge($z5128f,$re449c); $o55b55=array_reverse($o55b55); $o55b55=array_unique($o55b55); $o55b55=array_reverse($o55b55); return g2e82($o55b55,RESOURCES_LOCAL); } function hfc4d($jd430b,$m2bfe4){ $j84841=array(); if(is_array($m2bfe4['meta']['resources-detected'])) { $re449c=$m2bfe4['meta']['resources-detected']; $j84841=sdc5a($re449c); } $l16137=@unserialize( $jd430b['Uploads'] ) or $l16137=array(); $k08204=array_diff($j84841,$l16137); g4ae9('note',$jd430b['ID'],'add',$k08204); return $k08204; } function sdc5a($yd7f81){ $w10ae9=array(); foreach ($yd7f81 as $c1993e){ $w1c149=jbcd0($c1993e); if ($w1c149['is-local?'])$w10ae9[] = $c1993e; } return $w10ae9; } function g2e82($o55b55,$g8b7af=RESOURCES_ALL){ global$full_blog_url; $sef067=array(); $f59b51=array(); if (!is_array($o55b55)) return $f59b51; w6be4($o55b55); foreach ($o55b55 as $v96ab4){ $w1c149=jbcd0($v96ab4); if ($g8b7af==RESOURCES_LOCAL and !$w1c149['is-local?']) continue; if ($w1c149['type']=='remote-image'){ } elseif ($w1c149['type']=='online-video'){ if ($z742c4=g291d($w1c149['local-cover-name'])) { $size=w19a4(MEDIA_ROOT_FOLDER.$z742c4); list ($ieaae2,$cb435e)=$size; if (!in_array($v96ab4,$sef067)) { $sef067[] = $v96ab4; $f59b51[] = array ( 'original-filename' => $v96ab4, 'href' => $full_blog_url .'/'. $z742c4, 'width' => $ieaae2, 'height' => $cb435e, ); } } } elseif ($w1c149['type']=='local-image'){ if ($z742c4=g291d($v96ab4)) { $size=w19a4(MEDIA_ROOT_FOLDER.$z742c4); list ($ieaae2,$cb435e)=$size; if (!$ieaae2)$ieaae2=THUMB_WIDTH/2; if (!$cb435e)$cb435e=THUMB_HEIGHT/2; if (!in_array($v96ab4,$sef067)) { $sef067[] = $v96ab4; $f59b51[] = array ( 'original-filename' => $v96ab4, 'href' => $full_blog_url .'/'. $z742c4, 'width' => $ieaae2, 'height' => $cb435e, ); } } } elseif ($w1c149['type']=='local-non-image'){ if(is_file(MEDIA_ROOT_FOLDER.AUDIO_FOLDER.$v96ab4)) { if (!in_array($v96ab4,$sef067)) { $sef067[] = $v96ab4; $f59b51[] = array ( 'original-filename' => $v96ab4, 'href' => $full_blog_url .'/'. AUDIO_ICON_IMAGE, 'width' => AUDIO_ICON_WIDTH, 'height' => AUDIO_ICON_HEIGHT, ); } } } } return $f59b51; } function kdbcc($u89111,$gdffc4,$o55b55){ global$full_blog_url; $w10ae9=array(); if(is_array($o55b55)) { $w10ae9=e2files__list_og_images_for_resources_($o55b55); } $z5128f=nfb75($u89111,$gdffc4); if(is_array($z5128f)) { foreach ($z5128f as $c8ce4b => $l9e366){ if(is_file(MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$l9e366)) { $z5128f[$c8ce4b]=$full_blog_url .'/'. PICTURES_FOLDER.$l9e366; } else { unset ($z5128f[$c8ce4b]); } } $w10ae9=array_merge($z5128f,$w10ae9); } $w10ae9=array_reverse($w10ae9); $w10ae9=array_unique($w10ae9); $w10ae9=array_reverse($w10ae9); return $w10ae9; } function e2files__list_og_images_for_resources_($o55b55){ $f59b51=array(); w6be4($o55b55); foreach ($o55b55 as $v96ab4){ $w1c149=jbcd0($v96ab4); if ($w1c149['type']=='remote-image'){ } elseif ($w1c149['type']=='online-video'){ if(is_file($w1c149['local-full-filename'])) { $f59b51[] = $w1c149['local-cover-href']; } } elseif ($w1c149['type']=='local-image'){ if(is_file($w1c149['local-full-filename'])) { $f59b51[] = $w1c149['local-href']; } } elseif ($w1c149['type']=='local-non-image'){ } } return $f59b51; } function w8611($laf721,$u6efa1,$v93a57,$kcff96,$m6890f){ global$_config; if(__LOG)__log('Scale image: <'. $laf721 .'>'); if ($m6890f){ if(__LOG)__log('Scale image: recreate requested'); } $s7ae08=pathinfo($u6efa1); if(__LOG)__log('Scale image: source_name <'. $laf721 .'>'); if(__LOG)__log('Scale image: dest_name <'. $u6efa1 .'>'); if(is_file($laf721)) { if (pb6c5($laf721)) { if ($v93a57['h'] == -1)$v93a57['h']=999999; if (!is_file($u6efa1) or $m6890f){ if (@maf42($s7ae08['dirname'])) { y6b7f( $laf721, $v93a57['w'],$v93a57['h'],$v93a57['q'], $u6efa1, $kcff96 ); if(is_file($u6efa1)) { if(__LOG)__log('Scale image: done'); chmod($u6efa1,$_config['uploaded_files_mode']); } else { if(__LOG)__log('Scale image: error'); return false; } } else { if(__LOG)__log('Scale image: couldn’t create directory <'. $s7ae08['dirname'] .'>'); } } else { if(__LOG)__log('Scale image: already exists'); } return $u6efa1; } else { if(__LOG)__log('Scale image: SVG, no need to make thumbnail'); return $laf721; } } return false; } function j9c0a($ib0689,$d12e09){ if(preg_match('//u',$ib0689))$ib0689=pedd9($ib0689,false); if ($d12e09=='image'){ $j85114=MEDIA_ROOT_FOLDER.PICTURES_FOLDER; } elseif ($d12e09=='audio'){ $j85114=MEDIA_ROOT_FOLDER.AUDIO_FOLDER; } else { return false; } $p96704=''; for ($q865c0=0; $q865c0 < strlen($ib0689); $q865c0++) { if ($ib0689[$q865c0]=='?'){ $p96704.=''; } elseif ($ib0689[$q865c0]==' '){ $p96704.='-'; } elseif(ord($ib0689[$q865c0]) <= 127){ $p96704.=$ib0689[$q865c0]; } } if ($p96704=='')$p96704=$d12e09; if ($p96704[0]=='.')$p96704=$d12e09.$p96704; return $p96704; } function df0fb($r76ee3){ global$_config; if(__LOG)__log('Count refereces for upload <'. $r76ee3 .'>'); $e7cd94=$cbe270=$w6ae44=array(); if(is_file(USER_FOLDER.'new-uploads.psa')) { $e7cd94=@unserialize(file_get_contents(USER_FOLDER.'new-uploads.psa')); if (!is_array($e7cd94))$e7cd94=array(); } $w5a976='%'. str_replace('%','#%',$r76ee3) .'%'; if (o0738( "SELECT `ID`, `Text`, `FormatterID`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `Text` LIKE '". $w5a976 ."' ESCAPE '#' ". "OR `Uploads` LIKE '". $w5a976 ."' ESCAPE '#'" )) { $result=r0d6b(); $cbe270=@unserialize($result[0]['Uploads']); if (!is_array($cbe270)) { foreach($result as $f39a37){ $m2bfe4=a154e( $f39a37['FormatterID'], @$f39a37['Text'],'full-rss' ); $cbe270=hfc4d($f39a37,$m2bfe4); } } } if (o0738( "SELECT `ID`, `Description`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `Description` LIKE '". $w5a976 ."' ESCAPE '#' ". "WHERE `Uploads` LIKE '". $w5a976 ."' ESCAPE '#'" )) { $result=r0d6b(); $w6ae44=@unserialize($result[0]['Uploads']); if (!is_array($w6ae44)) { foreach($result as $pb19ad){ $m2bfe4=pb7f1( @$pb19ad['Description'],'full-rss' ); $w6ae44=hfc4d($pb19ad,$m2bfe4); } } } $z5128f=array_merge($e7cd94,$cbe270,$w6ae44); if(__LOG)__log('References found in relevant entries: '. var_export($z5128f,true)); if(in_array($r76ee3,$z5128f)) { if(__LOG)__log('Still referenced, do not delete file'); return true; } return false; } function nfb75($wf5e63,$xb80bb){ global$_config; if ($wf5e63=='note' and $xb80bb=='new'){ if(is_file(USER_FOLDER.'new-uploads.psa')) { $z5128f=@unserialize(file_get_contents(USER_FOLDER.'new-uploads.psa')); } } elseif ($wf5e63=='note'){ if (o0738( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `ID`=". $xb80bb )) { $result=r0d6b(); $z5128f=@unserialize($result[0]['Uploads']); } } elseif ($wf5e63=='tag'){ if (o0738( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `ID`=". $xb80bb )) { $result=r0d6b(); $z5128f=@unserialize($result[0]['Uploads']); } } if (!is_array($z5128f))$z5128f=array(); return $z5128f; } function cbc90($wf5e63,$xb80bb,$z5128f){ global$_config; if ($wf5e63=='note' and $xb80bb=='new'){ if (!@t6e52(USER_FOLDER.'new-uploads.psa',serialize($z5128f))) { y8a40('ERROR',E2E_PERMISSIONS_ERROR); } } elseif ($wf5e63=='note'){ o0738( "UPDATE `". $_config['db_table_prefix']."Notes` ". "SET `Uploads`='". serialize($z5128f) ."' ". "WHERE `ID`=". $xb80bb ); } elseif ($wf5e63=='tag'){ o0738( "UPDATE `". $_config['db_table_prefix']."Keywords` ". "SET `Uploads`='". serialize($z5128f) ."' ". "WHERE `ID`=". $xb80bb ); } else { return false; } if (!is_array($z5128f))$z5128f=array(); return $z5128f; } function g4ae9($wf5e63,$xb80bb,$action,$w4a202){ global$_config; $z5128f=array(); if(__LOG)__log('Register upload: <'. $wf5e63.', '. $xb80bb.', '. $action.', '. $w4a202 .'>'); $z5128f=nfb75($wf5e63,$xb80bb); $z5128f=ae1e7($z5128f,$action,$w4a202); cbc90($wf5e63,$xb80bb,$z5128f); } function n2f83($f4b27b,$jde17f,$re449c){ $l16137=@unserialize($jde17f['Uploads']) or $l16137=array(); $p28a47=sdc5a($re449c); $z5128f=ae1e7($l16137,'add',$p28a47); $z5128f=serialize($z5128f); if ($z5128f!=$jde17f['Uploads']) { $jde17f['Uploads']=$z5128f; eaa79($f4b27b,$jde17f); } } function e2j_file_upload($parameters=array ()) { global$_config,$full_blog_url; @maf42(MEDIA_ROOT_FOLDER.PICTURES_FOLDER); @chmod(MEDIA_ROOT_FOLDER.PICTURES_FOLDER,$_config['uploaded_files_mode']); @maf42(MEDIA_ROOT_FOLDER.AUDIO_FOLDER); @chmod(MEDIA_ROOT_FOLDER.AUDIO_FOLDER,$_config['uploaded_files_mode']); $rd1fc8=array(); $rd1fc8['success']=0; if(count($_FILES) > 0){ foreach($_FILES as $m8c7dd){ if (!$m8c7dd['error']) { if(__LOG)__log('Ajax file upload: <'. $m8c7dd['name'].'>'); $rd1fc8['file-kind']='image'; $j85114=MEDIA_ROOT_FOLDER.PICTURES_FOLDER; if(substr($m8c7dd['name'],strrpos($m8c7dd['name'],'.')) == '.mp3'){ $rd1fc8['file-kind']='audio'; $j85114=MEDIA_ROOT_FOLDER.AUDIO_FOLDER; } $b77dce=( array_key_exists('overwrite',$_GET) and is_file($j85114.$m8c7dd['name']) ); $g6f4b5=false; $rd1fc8['overwrite'] = (int)$b77dce; if(__LOG)__log('Ajax file upload: Overwrite is resolved to <'. (int)$b77dce.'>'); $p96704=j9c0a($m8c7dd['name'],$rd1fc8['file-kind']); if(__LOG)__log('Ajax file upload: Safe name is <'. $p96704.'>'); if(is_file($j85114.$p96704)) { if(file_get_contents($j85114.$p96704)==file_get_contents($m8c7dd['tmp_name'])) { if(__LOG)__log('Ajax file upload: Existing file is the same'); $g6f4b5=true; } else { if (!$b77dce){ $m5c917=substr($p96704,0,strrpos($p96704,'.')); $iabf77=substr($p96704,strrpos($p96704,'.')); $q865c0=0; while (is_file($j85114.$m5c917 .'_'. (++$q865c0).$iabf77)); $p96704=$m5c917 .'_'. $q865c0.$iabf77; } } } if (!$g6f4b5){ move_uploaded_file($m8c7dd['tmp_name'],$j85114.$p96704); @chmod($z9f57c,$_config['uploaded_files_mode']); } if(__LOG)__log('Ajax file upload: File kind is <'. $rd1fc8['file-kind'].'>'); if ($rd1fc8['file-kind']=='image'){ if($_config['fit_uploaded_images']) { w8611( MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$p96704, MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$p96704, array ( 'w' => $_config['fit_uploaded_images'], 'h' => $_config['fit_uploaded_images'], 'q' => SCALED_IMAGE_JPG_QUALITY, ), CROP_NONE, true ); } if ($z742c4=g291d($p96704,$b77dce)) { if(__LOG)__log('Ajax file upload: thumbnail, done'); list ($ieaae2,$cb435e)=w19a4(MEDIA_ROOT_FOLDER.$z742c4); $rd1fc8['success']=1; $rd1fc8['new-name']=$p96704; $rd1fc8['thumb']=$full_blog_url .'/'. $z742c4; $rd1fc8['width']=$ieaae2; $rd1fc8['height']=$cb435e; g4ae9($parameters['entity'],$parameters['entity-id'],'add', array ($p96704)); } else { if(__LOG)__log('Ajax file upload: couldn’t create thumbnail'); @unlink($j85114.$p96704); $rd1fc8['error']='could-not-create-thumbnail'; } } if ($rd1fc8['file-kind']=='audio'){ if(__LOG)__log('Ajax file upload: audio, done'); $rd1fc8['success']=1; $rd1fc8['new-name']=$p96704; $rd1fc8['thumb']=AUDIO_ICON_IMAGE; $rd1fc8['width']=AUDIO_ICON_WIDTH; $rd1fc8['height']=AUDIO_ICON_HEIGHT; } } elseif(4!=$m8c7dd['error']) { if ($m8c7dd['error']==1){ $rd1fc8['error']='too-big'; } elseif ($m8c7dd['error']==2){ $rd1fc8['error']='too-big'; } elseif ($m8c7dd['error']==3){ $rd1fc8['error']='partial'; } else { $rd1fc8['error']=$m8c7dd['error']; } } } } else { if(__LOG)__log('Ajax file upload error: no files'); $rd1fc8['error']='no-files'; } $rd1fc8=json_encode($rd1fc8); die ($rd1fc8); } function e2j_userpic_upload(){ global$_config; if(count($_FILES)==1){ $m8c7dd=array_pop($_FILES); if (!$m8c7dd['error']) { if(__LOG)__log('Ajax userpic upload: <'. $m8c7dd['name'].'>'); $aa93b8=pathinfo($m8c7dd['name']); $iabf77=strtolower($aa93b8['extension']); if ($iabf77!='png')$iabf77='jpg'; $n435ed='userpic.original.'. $iabf77; move_uploaded_file($m8c7dd['tmp_name'],USER_FOLDER.$n435ed); @chmod(USER_FOLDER.$n435ed,$_config['uploaded_files_mode']); $jd1789=array ( 'w' => USERPIC_WIDTH, 'h' => USERPIC_HEIGHT, 'q' => USERPIC_JPG_QUALITY ); @unlink(USER_FOLDER.'userpic@2x.png'); @unlink(USER_FOLDER.'userpic@2x.jpg'); $xf1210=w8611( USER_FOLDER.$n435ed, USER_FOLDER .'userpic@2x.jpg', $jd1789, CROP_SQUARE, true ); @unlink(USER_FOLDER.$n435ed); if ($xf1210){ if(__LOG)__log('Ajax userpic upload: userpic, done'); die ('image|'. $xf1210); } else { die ('image|'.DEFAULT_USERPIC_FILENAME); } } elseif(4!=$m8c7dd['error']) { if ($m8c7dd['error']==1){ die ('error|too-big'); } elseif ($m8c7dd['error']==2){ die ('error|too-big'); } elseif ($m8c7dd['error']==3){ die ('error|partial'); } else { die ('error|'. $m8c7dd['error']); } } } else { if(__LOG)__log('Ajax userpic upload error: no or too many files'); die ('error|no-or-too-many-files'); } die ('error|uncatched-error'); } function e2j_file_remove($parameters){ $m8c7dd=$xf1210=''; if(array_key_exists('file',$_POST))$m8c7dd=$_POST['file']; g4ae9($parameters['entity'],$parameters['entity-id'],'remove',$m8c7dd); if (df0fb($m8c7dd)) { die ('nothing'); } else { if(substr($m8c7dd,strrpos($m8c7dd,'.')) == '.mp3'){ @unlink(MEDIA_ROOT_FOLDER.AUDIO_FOLDER.$m8c7dd); die ('nothing'); } else { $xf1210=n25cb($m8c7dd,'thumb@2x'); $fd911a=n25cb($m8c7dd,'scaled'); if ($m8c7dd){ $ff6347=@unlink(MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$m8c7dd); $v8f458=@unlink(MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER.$xf1210); die ('nothing'); } } } die ('error|no-filename-passed'); } function y6b7f($qfce75,$yc69cd,$md35fb,$sd6663,$z1c925,$kcff96){ if (!extension_loaded('gd')) { if (!dl('gd.so')) { header('Content-type: image/gif'); return false; } } $tcaf9b=@getimagesize($qfce75); if (!$tcaf9b or $tcaf9b[2] > 3) return; $x599dc=$tcaf9b[2]; $h73beb=null; if ($x599dc==IMAGETYPE_GIF and function_exists('imagecreatefromgif')) { $h73beb=imagecreatefromgif($qfce75); } if ($x599dc==IMAGETYPE_JPEG and function_exists('imagecreatefromjpeg')) { $h73beb=imagecreatefromjpeg($qfce75); } if ($x599dc==IMAGETYPE_PNG and function_exists('imagecreatefrompng')) { $h73beb=imagecreatefrompng($qfce75); } if(function_exists('exif_read_data')) { $b9beff=exif_read_data($qfce75); if ($b9beff['Orientation']==3)$l5ffec=imagerotate($h73beb,180,0); if ($b9beff['Orientation']==6)$l5ffec=imagerotate($h73beb,270,0); if ($b9beff['Orientation']==8)$l5ffec=imagerotate($h73beb,90,0); if ($l5ffec){ imagedestroy($h73beb); $h73beb=$l5ffec; } } if (!$h73beb){ if(__LOG)__log('Could not create image object'); return false; } $ieaae2=imagesx($h73beb); $cb435e=imagesy($h73beb); $x0cb47=min($yc69cd/$ieaae2,$md35fb/$cb435e); if ($x0cb47 < 1){ $yc69cd=round($ieaae2*$x0cb47); $md35fb=round($cb435e*$x0cb47); } else { $yc69cd=$ieaae2; $md35fb=$cb435e; } $c08c38=$f480e9=$eb710b=$iee920=0; if ($kcff96==CROP_SQUARE){ if ($yc69cd > $md35fb){ $eb710b=$ieaae2-$cb435e; $c08c38=floor($eb710b/2); $md35fb=$yc69cd; } else { $iee920=$cb435e-$ieaae2; $f480e9=floor($eb710b/2); $yc69cd=$md35fb; } if(__LOG)__log('Files: '.'$crop_l='. $i6c5abд .' '.'$crop_t='. $f480e9 .' '.'$crop_hor='. $eb710b .' '.'$crop_ver='. $iee920 .' '); } $k28e3d=imagecreatetruecolor($yc69cd,$md35fb); if ($x599dc==IMAGETYPE_PNG){ imagefill($k28e3d,0,0,imagecolorallocate($k28e3d,255,255,255)); imagealphablending($k28e3d,true); } if (empty ($z1c925)) { $z19229=stat($qfce75); $z19229=date('r',$z19229['mtime']); header('Last-Modified: '.$z19229); } imagecopyresampled( $k28e3d, $h73beb, 0,0, 0+$c08c38,0+$f480e9, $yc69cd,$md35fb, $ieaae2-$eb710b,$cb435e-$iee920 ); imageinterlace($k28e3d,1); imagejpeg($k28e3d,$z1c925,$sd6663); return true; } function cd10e(){ global$_config; if (!$_config['files_total_size_limit']) return false; $l70a36=0; foreach(glob(MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'/*') as $m8c7dd){ $i9dd4e=stat($m8c7dd); $l70a36+=$i9dd4e['size']; } foreach(glob(MEDIA_ROOT_FOLDER.AUDIO_FOLDER .'/*') as $m8c7dd){ $i9dd4e=stat($m8c7dd); $l70a36+=$i9dd4e['size']; } $pd515a=$_config['files_total_size_limit']; $t354f0=round($l70a36/$pd515a*100); if ($l70a36 > 0 and $t354f0==0)$t354f0=1; if ($l70a36 < $pd515a and $t354f0==100)$t354f0=99; return array ($l70a36,$pd515a,$t354f0); } function r1363($xc999b){ $t85faf=true; if (list ($l70a36,$pd515a,$t354f0)=$xc999b){ $t85faf=($pd515a-$l70a36) > 0; } return $t85faf; } function vaf64($xc999b,$bf9f90=false){ $jf3ecb=''; if (list ($l70a36,$pd515a,$t354f0)=$xc999b){ $xc999b=array ( 'used' => round($l70a36/1024/1024), 'total' => round($pd515a/1024/1024), 'percent' => $t354f0 ); if ($bf9f90 or ($pd515a-$l70a36) < 1024*1024*10){ if ($l70a36 < $pd515a){ $jf3ecb=e2l_get_string('gs--used',$xc999b); } else { $jf3ecb=e2l_get_string('gs--used-all',$xc999b); } } } return $jf3ecb; } function e74e0(){ global$settings; if (!isset ($settings))$settings=array(); $wfa816=array(); if(is_file(USER_FOLDER.'settings.json')) { $wfa816=json_decode(file_get_contents(USER_FOLDER.'settings.json'),true); $h098f6=13; } elseif(is_file(USER_FOLDER.'settings.psa')) { $wfa816=unserialize(file_get_contents(USER_FOLDER.'settings.psa')); } if (!is_array($wfa816))$wfa816=array(); $settings=array_merge($settings,$wfa816); if ( !is_numeric(@$settings['appearance']['notes_per_page']) or @$settings['appearance']['notes_per_page'] < 1 ){ $settings['appearance']['notes_per_page']=DEFAULT_ITEMS_PER_PAGE; } if ( @$settings['appearance']['notes_per_page'] > MAX_ITEMS_PER_PAGE ){ $settings['appearance']['notes_per_page']=MAX_ITEMS_PER_PAGE; } if ( !array_key_exists('comments',$settings) or !array_key_exists('default_on', @$settings['comments']) ) { $settings['comments']['default_on']=false; } return true; } function e2m_settings(){ global$settings,$_template,$_strings; $wf3e33=array(); $n5e107=@$settings['language']? $settings['language']:DEFAULT_LANGUAGE; foreach(glob(LANGUAGES_FOLDER. '*.php') as $n435ed){ $q5b54c=substr(basename($n435ed),0,2); $m98bf7=file_get_contents($n435ed); if(preg_match( '/^ *\/\/ *display_name *\= *(.*?) *$/ismu',$m98bf7,$b9c28d )) { $tc2657=$b9c28d[1]; } else { $tc2657=$q5b54c; } $wf3e33[$q5b54c] = array ( 'selected?' => (bool) ($n5e107==$q5b54c), 'display-name' => $tc2657, ); } $i2cb9d['title']=$_strings['pt--settings']; $i2cb9d['heading']=$_strings['pt--settings']; $i2cb9d['form']='form-preferences'; $i2cb9d['form-preferences'] = array ( 'blog-title-default' => htmlspecialchars($_strings['e2--default-blog-title'],ENT_COMPAT,HSC_ENC), 'blog-title' => htmlspecialchars(s6f51(),ENT_COMPAT,HSC_ENC), 'blog-description' => htmlspecialchars(@$settings['description'],ENT_COMPAT,HSC_ENC), 'blog-author-default' => htmlspecialchars($_strings['e2--default-blog-author'],ENT_COMPAT,HSC_ENC), 'blog-author' => htmlspecialchars(@$settings['author'],ENT_COMPAT,HSC_ENC), 'languages' => $wf3e33, 'language' => $n5e107, 'form-action' => y83c8('e2s_settings_save'), 'notes-per-page' => $settings['appearance']['notes_per_page'], 'email-notify?' => (bool) @$settings['notifications']['new_comments'], 'email' => htmlspecialchars(@$settings['user']['email'],ENT_NOQUOTES,HSC_ENC), 'comments-default-on?' => (bool) @$settings['comments']['default_on'], 'comments-fresh-only?' => (bool) @$settings['comments']['fresh_only'], 'show-sharing-buttons?' => (bool)$settings['appearance']['show_sharing_buttons'], 'includes-google-analytics?' => false, 'includes-yandex-metrika?' => false, 'template-name' => $_template['name'], 'templates' => i94dd(), 'submit-text' => $_strings['fb--save-changes'], 'space-usage' => vaf64(cd10e(),true), ); return $i2cb9d; } function e2s_settings_save(){ global$settings,$_strings; if($_SERVER['REQUEST_METHOD']!='POST') return e2_go_to(y83c8('e2m_settings')); $a05df2=$c67daf=''; if(array_key_exists('blog-title',$_POST)) { $a05df2=trim($_POST['blog-title']); } if(array_key_exists('blog-description',$_POST)) { $c67daf=trim($_POST['blog-description']); } if(array_key_exists('blog-author',$_POST)) { $e02bd9=trim($_POST['blog-author']); } if(array_key_exists('language',$_POST)) $b8512a=$_POST['language']; if(array_key_exists('email',$_POST)) $c0c83f=trim($_POST['email']); $o0c2bd=(int)$_POST['notes-per-page']; $settings['site_title']=$a05df2; $settings['site_title']=s6f51(); $settings['description']=$c67daf; $settings['author']=$e02bd9; $settings['user']['email']=$c0c83f; $settings['notifications']['new_comments'] = isset ($_POST['email-notify']); if(array_key_exists('template',$_POST)) { $settings['template']=trim($_POST['template']); } $settings['comments']['default_on'] = isset ($_POST['comments-default-on']); if ( $settings['language']!=$b8512a or $settings['appearance']['notes_per_page']!=$o0c2bd or $settings['appearance']['show_sharing_buttons'] != isset ($_POST['show-sharing-buttons']) or $settings['comments']['fresh_only'] != isset ($_POST['comments-fresh-only']) ) { @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); $settings['language']=$b8512a; $settings['appearance']['notes_per_page']=$o0c2bd; $settings['appearance']['show_sharing_buttons'] = isset ($_POST['show-sharing-buttons']); $settings['comments']['fresh_only'] = isset ($_POST['comments-fresh-only']); } if(E2_EDITION){ if(array_key_exists('google-analytics',$_POST)) { $settings['embed']['google-analytics']=trim($_POST['google-analytics']); } if(array_key_exists('yandex-metrika',$_POST)) { $settings['embed']['yandex-metrika']=trim($_POST['yandex-metrika']); } } nc5a6(CACHE_FILENAMES_NOTES_COMMENTS); if (!@t6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { y8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(y83c8('e2m_settings')); die; } e2_go_to(y83c8('e2m_frontpage', array ('page' => 1))); die; } function e2m_database(){ global$settings,$_strings,$_superconfig; if (@$_superconfig['disallow_db_config']) { return e2_error404_mode(); } $i2cb9d['title']=$_strings['pt--database']; $i2cb9d['heading']=$_strings['pt--database']; $i2cb9d['form']='form-database'; $i2cb9d['form-database'] = array ( 'form-action' => y83c8('e2s_database_save'), 'db-server' => htmlspecialchars(@$settings['db']['server']? $settings['db']['server']:'localhost'), 'db-user' => htmlspecialchars(@$settings['db']['user_name']? $settings['db']['user_name']:'root'), 'db-password' => htmlspecialchars(uee85(@$settings['db']['passw'])), 'db-database' => htmlspecialchars(@$settings['db']['name']), 'submit-text' => $_strings['fb--connect-to-this-db'], ); return $i2cb9d; } function e2s_database_save(){ global$settings,$_db,$_superconfig,$_strings,$_config; if($_SERVER['REQUEST_METHOD']!='POST') return e2_go_to(y83c8('e2m_database')); if (@$_superconfig['disallow_db_config']) { return e2_error404_mode(); } $l0ba44=n55fd(); if ($l0ba44=='bingo-data-exists'){ $settings['db']['server'] = @$_POST['db-server']; $settings['db']['user_name'] = @$_POST['db-user']; $settings['db']['passw']=b1305(@$_POST['db-password']); $settings['db']['name'] = @$_POST['db-database']; if (!@t6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { y8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(y83c8('e2m_database')); die; } e2_drop_all_kinds_of_cache(); jbb8d(); if (!$_config['retain_search_indexes_on_db_switch']) { $uddece=f476c(); $uddece -> erase(); g198f(); } ucc38(y83c8('e2s_bsi_step')); e2_go_to(y83c8('e2m_settings')); } else { y8a40($_strings['er--double-check-db-params']); e2_go_to(y83c8('e2m_database')); } die; } function sda67(){ return class_exists('ZipArchive'); } function e2m_get_backup(){ if (sda67()) { $ufbade=new ZipArchive(); $m979eb=BACKUP_FOLDER .'backup.zip'; if ($ufbade -> open($m979eb,ZIPARCHIVE::CREATE)) { @ $ufbade -> addFile(USER_FOLDER.'userpic@2x.jpg','userpic@2x.jpg'); @ $ufbade -> addFile(USER_FOLDER.'userpic@2x.png','userpic@2x.png'); foreach(glob(BACKUP_FOLDER .'backup-*.sql') as $m8c7dd); $ufbade -> addFile($m8c7dd,basename($m8c7dd)); $ufbade -> close(); } header('Content-Type: application/zip'); header('Content-Disposition: attachment; filename="backup.zip"'); readfile($m979eb); unlink($m979eb); die; } else { die ('Cannot get backup'); } } e74e0(); function y8a40($c67daf,$x599dc=E2E_STRANGE_ERROR){ global$errors,$settings, $_config, $_strings, $_diagnose; $z1897a=(!ve852()+1 <= (int)$_config['show_call_stack']); if ($c67daf){ if ($c67daf[0]!='<')$c67daf='<p>'.$c67daf .'</p>'; $zcd1dd=array ( 'description' => $c67daf, 'type' => $x599dc, ); if ( $x599dc==E2E_STRANGE_ERROR and $z1897a and function_exists('debug_backtrace') ) { $zcd1dd['backtrace']=debug_backtrace(); } $errors[] = $zcd1dd; } if ($x599dc==E2E_PERMISSIONS_ERROR){ $_diagnose['need?']=true; nc64a('diagnose','1'); } if ($x599dc==E2E_DATABASE_ERROR){ } return true; } function y8739(){ global$errors,$c1c0b7,$_strings,$_diagnose; $j7287a=lea70(); if(count($j7287a)==0){ nc64a('diagnose',''); unset($_COOKIE['diagnose']); $_diagnose['need?']=false; $_diagnose['ok?']=true; return true; } else { $q6e2ba=''; $q6e2ba.='<p>'. $_strings['gs--enable-write-permissions-for-the-following'] .'</p>'; $q6e2ba.='<ul>'; foreach ($j7287a as $b8fa14){ if ($b8fa14=='.')$b8fa14=''; $q6e2ba.='<li><tt>.../'. $b8fa14 .'</tt></li>'; if(__LOG)__log('Diagnostics: cannot write <'. $b8fa14 .'>'); } $q6e2ba.='</ul>'; $zcd1dd=array ( 'title' => $_strings['et--fix-permissions-on-server'], 'description' => $q6e2ba, 'type' => E2E_DIAGNOSTICS_MESSAGE, 'class' => 'serious', ); $errors[] = $zcd1dd; $_diagnose['ok?']=false; return false; } } function ze1c4($dc1336,$c67daf,$w1407f,$yc2d4b,$v4f62c){ global$errors; if(0==error_reporting() or ($dc1336 & 8)) return; $w1407f=str_replace(__DIR__,'',$w1407f); y8a40($w1407f .', line '. $yc2d4b .'<br />Error '. $dc1336 .': '. $c67daf); $errors[count($errors)-1]['phpcode']=$dc1336; } function fec07(){ global$errors,$settings,$_config; @session_start(); if(is_array(@$_SESSION['errors'])) { $be1671=array_merge(@$_SESSION['errors'],$errors); } else { $be1671=$errors; } $z1897a=(!ve852()+1 <= (int)$_config['show_call_stack']); if (@$_config['store_backtrace'] and $z1897a and $be1671!=NULL){ @t6e52('backtrace.psa',serialize($be1671)); } else { @unlink('backtrace.psa'); } if (isset ($_SESSION['errors'])) unset($_SESSION['errors']); $i2cb9d=array(); $bb8735=false; if(count($be1671) > 0){ foreach ($be1671 as $q865c0 => $u08a44){ if ($u08a44['type']==E2E_STRANGE_ERROR){ $u08a44['class']='serious'; $bb8735=true; if ($z1897a){ $u08a44['backtrace']=a2616($u08a44['backtrace']); } } if ($u08a44['type']==E2E_MESSAGE){ $u08a44['class']='info'; } $be1671[$q865c0]=$u08a44; } $i2cb9d['each']=$be1671; if ( $bb8735 and @$_config['store_backtrace'] and $z1897a and is_file('debug.php') ) { $i2cb9d['debug-link']='debug.php'; } } return $i2cb9d; } function v4006(){ $errors=fec07(); foreach($errors['each'] as $scb5e1){ echo '<p>'. $scb5e1['description'] .'</p>'; } die; } function a2616($d69206){ global $aa57c1; if (!is_array($d69206)) return 'No backtrace info'; $d69206=array_reverse($d69206); $d69206=array_splice($d69206,0,count($d69206)-1); $be1671='<p style="background: #fea; padding: .25em .5em; line-height: 1em; overflow: hidden">'; foreach ($d69206 as $q865c0 => $ye358e){ $t195df=@$ye358e['args'] or $t195df=array(); $qa956a=array(); foreach ($t195df as $i5919c){ $qa956a[] = var_export($i5919c,true); } $m8c7dd=@$ye358e['file']; $m8c7dd=str_replace($_SERVER['DOCUMENT_ROOT'],'',$m8c7dd); $q6438c=(@$ye358e['line']? (' #'. $ye358e['line']) : '?'); $be1671.='<div style="margin: .25em 0 .5em '. $q865c0*3 .'em">'; $be1671.='<span style="float: right; color: #666"> '. $m8c7dd.$q6438c .'</span>'; $be1671.='<tt><b>'. @$ye358e['function'] .' (</b>'; if(count($qa956a)) { $veb84a=str_replace("array (\n)",'array ()',$qa956a); $veb84a=implode(', ',$veb84a); if(0){ $veb84a=highlight_string('<?'. $veb84a .'?'.'>',true); $veb84a=substr($veb84a,77, -28); } $veb84a=str_replace('&nbsp;',' ',$veb84a); $veb84a=nl2br($veb84a); $be1671.='<div style="margin: 0 0 0 1.12em">'. $veb84a .'</div>'; } $be1671.='<b>)</b> &rarr;</tt></div>'; } $be1671.='</p>'; return $be1671; } set_error_handler('ze1c4'); function e2_error404_mode(){ global$_config,$_strings; if($_config['try_redirect_to_all']) { $y4a7dc='all/'. urldecode($_GET['go']); gb7e9($y4a7dc); } header('HTTP/1.1 404 Not found'); $ze70c4['heading']=$_strings['pt--page-not-found']; $ze70c4['title']=$_strings['pt--page-not-found']; return $ze70c4; } include_once 'neasden/neasden.php'; function g6f10($h1cb25){ $Nn=new Neasden; $Nn->profile_name='kavychki'; return$Nn->format($h1cb25); } function yc0c4($vf2ffc,$h1cb25,$r5c18e){ if ($h1cb25==='') return array (); if ($vf2ffc=='calliope'){ preg_match_all('/\(\(([^ ]*)( |\)\))/',$h1cb25,$b9c28d); return $b9c28d[1]; } elseif ($vf2ffc=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$r5c18e; $Nn->format($h1cb25); return$Nn->resources_detected; } else { return array (); } } function a154e($vf2ffc,$h1cb25,$r5c18e){ if(__LOG)__log('Format: format with formatter "'. $vf2ffc .'" in context "'. $r5c18e.'"'); if ($vf2ffc=='calliope'){ $h1cb25=pedd9($h1cb25); $h1cb25=f5599($h1cb25,$r5c18e); $meta=array(); $h1cb25=ofd97($h1cb25); $h1cb25='<div class="e2-text-calliope-formatted">'. g6f10($h1cb25) .'</div>'; } elseif ($vf2ffc=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$r5c18e; $h1cb25=$Nn->format($h1cb25); $meta=array ( 'links-required' => $Nn->links_required, 'resources-detected' => $Nn->resources_detected ); } return array ( 'text-final' => $h1cb25, 'meta' => $meta, ); } function pb7f1($h1cb25,$r5c18e){ global$_config; return a154e($_config['default_formatter'],$h1cb25,$r5c18e); } function f5599($h1cb25,$r5c18e){ global$_config,$settings,$full_blog_url,$_template; @ (list ($r5c18e,$qe8fab)=explode('|',$r5c18e)); require_once 'calliope/WikiFormatter.php'; if ('full'==$r5c18e)$iad910=WF_FULL_MODE; elseif ('full-rss'==$r5c18e)$iad910=WF_FULL_MODE; elseif ('simple'==$r5c18e)$iad910=WF_SIMPLE_MODE; elseif ('simple-rss'==$r5c18e)$iad910=WF_SIMPLE_MODE; else return $h1cb25; $v0a1d3=new WikiFormatter(); $v0a1d3 -> replace=array ( '/' => 'i', '+' => 'small', '-' => 's', '*' => 'b', '^' => 'sup', 'v' => 'sub', '#' => 'tt', '!' => 'blockquote', ); $v0a1d3 -> settings=array ( 'hrefSize' => 100, 'localImgDir' => $full_blog_url .'/'. PICTURES_FOLDER, 'maxImgWidth' => $_template['max_image_width'], 'mode' => $iad910, 'enableShrinkLongHref' => 1, 'enableHr' => 0, 'enableBr' => 1, 'enableHeaders' => 1, 'headersStartWith' => 1, 'enableTables' => 1, 'simpleTableCSSClass' => 'e2-text-table', 'enableAutoAcronymEngine' => 0, 'enableAcronym' => 0, 'acronymBase' => '', 'enableList' => 1, 'mailSafe' => "<a href=\"\" onmouseover=\"this.href='mailto:'+{email}\">{icon}<script language=\"JavaScript\">document.write({name});</script></a>", 'ljUserTag' => '<a href="http://livejournal.com/users/{name}/">{name}</a>', 'fullVersionURL' => $qe8fab, 'enableTagIcons' => 0, 'outerUrlInNewWindow' => 0, 'lineBreak' => "\n", 'extLinkHrefPrefix' => '', ); $h1cb25=$v0a1d3 -> Wiki2HTML($h1cb25); return $h1cb25; } function ucc38($j572d4){ if(__LOG)__log('Spawn: Curl '. $j572d4 .'...'); if(function_exists('curl_init')) { $nf6e57=curl_init(); $i80e25=!ini_get('open_basedir'); curl_setopt_array($nf6e57, array ( CURLOPT_URL => $j572d4, CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => ic3fb(), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $i80e25, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content=curl_exec($nf6e57); $m70106=curl_errno($nf6e57); $x809b1=curl_error($nf6e57); $i099fb=curl_getinfo($nf6e57); curl_close($nf6e57); if(__LOG)__log('Spawn: Curl returns: ['. print_r($i099fb,true) .'] ['. $content .'], (errno='. $m70106 .', errstr='. $x809b1 .')...'); } else { if(__LOG)__log('Spawn: Curl functions are not available'); } } function l5b68($bea59a){ global$_config; if (@$_config['broadcast_url'] and !$bea59a['IsExternal']) { if(__LOG)__log('Broadcast-async note: '. $bea59a['Title']); $j572d4=y83c8('e2m_note_broadcast', array ('*note' => $bea59a)); if(__LOG)__log('Broadcast will spawn url: '. $j572d4); ucc38($j572d4); } } function ieb3b($bea59a){ global$_config; $wcffbb=y83c8('e2m_note_json', array ('*note' => $bea59a)); $j572d4=$_config['broadcast_url']; $j572d4.='?src='. urlencode($wcffbb); if(__LOG)__log('Broadcast: Curl '. $j572d4 .'...'); if(function_exists('curl_init')) { $nf6e57=curl_init(); $i80e25=!ini_get('open_basedir'); curl_setopt_array($nf6e57, array ( CURLOPT_URL => $j572d4, CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => ic3fb(), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $i80e25, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content=curl_exec($nf6e57); $m70106=curl_errno($nf6e57); $x809b1=curl_error($nf6e57); $i099fb=curl_getinfo($nf6e57); curl_close($nf6e57); if(__LOG)__log('Broadcast: Curl returns: ['. print_r($i099fb,true) .'] ['. $content .'], (errno='. $m70106 .', errstr='. $x809b1 .')...'); } else { if(__LOG)__log('Spawn: Curl functions are not available'); } } function e2m_note_broadcast($parameters=array ()) { global$_config; if (@$_config['broadcast_url']) { ieb3b($parameters['*note']); die ('Broadcasted.'); } else { return e2_error404_mode(); } } function e2m_timezone(){ global$_strings,$settings; $qde2fd=array ( 'form-action' => y83c8('e2s_select_timezone'), 'submit-text' => $_strings['fb--select'], 'timezone-selector' => m9fe5($settings['timezone']['offset'],1), 'dst?' => $settings['timezone']['is_dst'], ); return array ( 'title' => $_strings['pt--default-timezone'], 'heading' => $_strings['pt--default-timezone'], 'form' => 'form-timezone', 'form-timezone' => $qde2fd, ); } function y4c37(){ global$_strings; $g5cacd=array ( -720 => '', -660 => '', -600 => '', -540 => '', -480 => $_strings['tt--zone-pt'], -420 => $_strings['tt--zone-mt'], -360 => $_strings['tt--zone-ct'], -300 => $_strings['tt--zone-et'], -240 => '', -210 => '', -180 => '', -120 => '', -60 => '', 0 => $_strings['tt--zone-gmt'], 60 => $_strings['tt--zone-cet'], 120 => $_strings['tt--zone-eet'], 180 => '', 210 => '', 240 => $_strings['tt--zone-msk'], 270 => '', 300 => '', 330 => '', 345 => '', 360 => $_strings['tt--zone-ekt'], 390 => '', 420 => '', 480 => '', 540 => '', 570 => '', 600 => '', 660 => '', 720 => '', 780 => '', 840 => '', ); return $g5cacd; } function k82a3($m7a86c){ $g5cacd=y4c37(); return @$g5cacd[(int)$m7a86c/SECONDS_IN_A_MINUTE]; } function k9515($m7a86c){ $w04b29='+'; if ($m7a86c < 0)$w04b29='&ndash;'; $j73cdd=str_pad((int) (abs($m7a86c)/3600),2,'0',STR_PAD_LEFT); $z640fd=str_pad(abs($m7a86c)/60 % 60,2,'0',STR_PAD_LEFT); return 'GMT'. $w04b29.$j73cdd .':'. $z640fd; } function m9fe5($b0743a,$y5784d=''){ global$_strings; $g5cacd=y4c37(); $i2cb9d=''; if (!$y5784d)$y5784d=count($g5cacd); $i2cb9d.='<select name="offset" size="'. $y5784d .'">'; foreach ($g5cacd as $m7a86c => $q83bce){ $rc03a8=''; if ($m7a86c*SECONDS_IN_A_MINUTE==$b0743a)$rc03a8=' selected="selected"'; $i2cb9d.='<option'. $rc03a8 .' value="'.$m7a86c.'">'; $w04b29=''; if ($m7a86c < 0)$w04b29='−'; if ($m7a86c > 0)$w04b29='+'; $j73cdd=(int) (abs($m7a86c*SECONDS_IN_A_MINUTE)/3600); $z640fd=(int) (abs($m7a86c*SECONDS_IN_A_MINUTE)/60 % 60); if ($j73cdd){ $i2cb9d .= ( $w04b29 .' '. $j73cdd .' '. $_strings['gs--timezone-offset-hours'] .' '. ($z640fd? ($z640fd .' '. $_strings['gs--timezone-offset-minutes']) : '') ); if ($q83bce){ $i2cb9d .= ' ('. $q83bce. ')'; } } else { $i2cb9d .= $q83bce; } $i2cb9d.='</option>'; } $i2cb9d.='</select>'; return $i2cb9d; } function e2s_select_timezone(){ global$settings,$_strings; if (@$_POST['offset'] >= -720 and @$_POST['offset'] <= 780){ $settings['timezone']['offset'] = @$_POST['offset']*SECONDS_IN_A_MINUTE; $settings['timezone']['is_dst'] = isset ($_POST['is_dst']); } if (!@t6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { y8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(y83c8('e2m_timezone')); die; } e2_go_to(y83c8('e2m_settings')) and die (); } function y0923($uaad65){ return array ( 'offset' => (int)$uaad65['Offset'], 'is_dst' => (bool)$uaad65['IsDST'], ); } function i3211(){ return array ( 'offset' => 0, 'is_dst' => false, ); } function s5c05(){ global$settings; return$settings['timezone']; } function y7770($eb2c6c,$edf491){ if (@$eb2c6c['is_dst']) { $k30481=(int)date('I',$edf491); $g6b7ea=date('Z',$edf491)-$k30481*SECONDS_IN_AN_HOUR; $b3e61a=$eb2c6c['offset']; $z178ae=$b3e61a-$g6b7ea; $e75b02=date('I',$edf491+$z178ae); return $e75b02; } else { return 0; } } function xb2bf($eb2c6c,$edf491){ global$settings; if ($eb2c6c and is_array($eb2c6c)) { return ( $eb2c6c['offset'] + y7770($eb2c6c,$edf491)*SECONDS_IN_AN_HOUR ); } } function h8afe($edf491){ return xb2bf(s5c05(),$edf491); } function a5a2f($t1ddcb,$w4a202,$eb2c6c){ return gmdate($t1ddcb,$w4a202+xb2bf($eb2c6c,$w4a202)); } function da846($t1ddcb,$w4a202){ return a5a2f($t1ddcb,$w4a202,s5c05()); } function b66cd($z41529,$w6f8f5=false,$d8277e=false){ if(is_numeric($d8277e)) { $tea2b2=gmmktime(0,0,0,$w6f8f5,$d8277e,$z41529); $q7f021=gmmktime(0,0,0,$w6f8f5,$d8277e+1,$z41529)-1; } elseif(is_numeric($w6f8f5)) { $tea2b2=gmmktime(0,0,0,$w6f8f5,1,$z41529); $q7f021=gmmktime(0,0,0,$w6f8f5+1,1,$z41529)-1; } else { $tea2b2=gmmktime(0,0,0,1,1,$z41529); $q7f021=gmmktime(0,0,0,1,1,$z41529+1)-1; } return array ($tea2b2,$q7f021); } function g2143($eb2c6c,$z41529,$w6f8f5=false,$d8277e=false){ list ($tea2b2,$q7f021)=b66cd($z41529,$w6f8f5,$d8277e); $tea2b2 -= xb2bf($eb2c6c,$tea2b2); $q7f021 -= xb2bf($eb2c6c,$q7f021); return array ($tea2b2,$q7f021); } function tac5b($z41529,$w6f8f5=false,$d8277e=false){ return g2143(s5c05(),$z41529,$w6f8f5,$d8277e); } function p5273($z41529,$w6f8f5=false,$d8277e=false){ $t32038=13; $eda4f0=-12; $t32038+=1; $eda4f0 -= 1; list ($tea2b2,$q7f021)=b66cd($z41529,$w6f8f5,$d8277e); $tea2b2 -= $t32038*3600; $q7f021 -= $eda4f0*3600; return array ($tea2b2,$q7f021); } function yd17a($m7a86c){ if ((int) @$m7a86c > 0) return (string)'+'.abs(@$m7a86c); elseif ((int) @$m7a86c < 0) return (string)'-'.abs(@$m7a86c); else return ''; } function wd536($edf491,$sa0f0b=''){ $l2ab64=h8afe($edf491); $w04b29=($l2ab64 >= 0)?'+':'-'; $l2ab64=abs($l2ab64); $v03c7c=$l2ab64 % 60; $l2ab64 -= $v03c7c; $w6f8f5=$l2ab64 % 3600/60; $l2ab64 -= $w6f8f5*60; $y2510c=$l2ab64/3600; if ($y2510c < 10)$y2510c='0'.$y2510c; if ($w6f8f5 < 10)$w6f8f5='0'.$w6f8f5; return $w04b29.$y2510c.$sa0f0b.$w6f8f5; } function ta618($laa759){ global$settings; if(is_numeric($laa759)) { $result['offset']=SECONDS_IN_A_MINUTE*$laa759; $result['is_dst']=false; $yd8935=SECONDS_IN_A_MINUTE*$laa759-SECONDS_IN_AN_HOUR; $ya6cfc=array ('offset' => $yd8935,'is_dst' => true); $ya6cfc=(int)xb2bf($ya6cfc,time()); if($result['offset']==$ya6cfc){ $result['offset']=$yd8935; $result['is_dst']=true; } } else { if(array_key_exists('timezone',$settings)) { $result=$settings['timezone']; } else { $result['offset']=0; $result['is_dst']=false; } } return$result; } function m692f($e96b8c){ $y2510c=da846('H',$e96b8c); if ($y2510c <= 4) return 4; elseif ($y2510c <= 10) return 1; elseif ($y2510c <= 16) return 2; elseif ($y2510c <= 22) return 3; else return 4; } function i7a0b($r0e524,$yb65f7=null){ global$_strings; if ($yb65f7===null)$yb65f7=s5c05(); $zdb42a=a5a2f('d.m.Y',$b97bc5,$yb65f7); $u33284=a5a2f('d.m.Y',$r0e524,$yb65f7); $ced79a=SECONDS_IN_A_MINUTE; $u77cbc=SECONDS_IN_AN_HOUR; $b97bc5=time(); $l0b375=m692f($b97bc5); $l3dfda=m692f($r0e524); $p74459=$b97bc5-$r0e524; if ($p74459 < 0) return$_strings['tt--from-the-future']; if ($p74459 >= 0 and $p74459 < 54) return$_strings['tt--just-now']; if ($p74459 >= 54 and $p74459 < 108) return$_strings['tt--one-minute-ago']; $z7eccb=$p74459+12; $e7828e=floor($z7eccb/$ced79a); if ($p74459 >= 108 and $p74459 < 54*$ced79a) return e2l_get_string( 'tt--minutes-ago', array ('minutes' => $e7828e) ); if ($p74459 >= 54*$ced79a and $p74459 < 108*$ced79a) return$_strings['tt--one-hour-ago']; $z7eccb=$p74459+12*$ced79a; $r6b497=floor($z7eccb/$u77cbc); if ($p74459 >= 108*$ced79a and $p74459 < 4*$u77cbc) return e2l_get_string( 'tt--hours-ago', array ('hours' => $r6b497) ); $o07cc6=a5a2f('G:i',$r0e524,$yb65f7); if ($p74459 >= 4*$u77cbc and $l0b375 > $l3dfda and $zdb42a==$u33284){ return$_strings['tt--today']; } if ((($b97bc5-$r0e524) <= YEAR_DISPLAY_THRESH)) { return e2l_get_string( 'tt--date', array ( 'day' => a5a2f('j',$r0e524,$yb65f7), 'month' => a5a2f('m',$r0e524,$yb65f7), ) ); } return a5a2f('Y',$r0e524,$yb65f7); } $_model_contractions=array ( 'key' => "INT UNSIGNED AUTO_INCREMENT PRIMARY KEY", 'pkey' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'int' => "INT DEFAULT '0' NOT NULL", 'uint' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'time' => "INT UNSIGNED DEFAULT '0' NOT NULL", '0' => "TINYINT(1) DEFAULT '0' NOT NULL", '1' => "TINYINT(1) DEFAULT '1' NOT NULL", 'v1' => "VARCHAR(1) DEFAULT '' NOT NULL", 'v8' => "VARCHAR(8) DEFAULT '' NOT NULL", 'v15' => "VARCHAR(15) DEFAULT '' NOT NULL", 'v32' => "VARCHAR(32) DEFAULT '' NOT NULL", 'v64' => "VARCHAR(64) DEFAULT '' NOT NULL", 'fid' => "VARCHAR(32) DEFAULT '". $_config['default_formatter'] ."' NOT NULL", 'v255' => "VARCHAR(255) DEFAULT '' NOT NULL", 'text' => "MEDIUMTEXT", ); $_model=array ( 'Actions' => array ( array ('ID', 'key'), array ('EntityID', 'pkey'), array ('Stamp', 'time'), array ('HitCount', 'int'), ), 'Aliases' => array ( array ('ID', 'key'), array ('EntityType', 'v1'), array ('EntityID', 'pkey'), array ('Alias', 'v64'), array ('Stamp', 'time'), ), 'Comments' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('AuthorName', 'v255'), array ('AuthorEmail', 'v255'), array ('Text', 'text'), array ('Reply', 'text'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('IsReplyVisible', '0'), array ('IsReplyFavourite', '0'), array ('IsAnswerAware', '1'), array ('IsSubscriber', '0'), array ('IsSpamSuspect', '0'), array ('IsNew', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('ReplyStamp', 'time'), array ('ReplyLastModified', 'time'), array ('IP', 'v15'), ), 'Keywords' => array ( array ('ID', 'key'), array ('Keyword', 'v255'), array ('OriginalAlias', 'v64'), array ('Description', 'text'), array ('Uploads', 'text'), array ('IsFavourite', '0'), ), 'Notes' => array ( array ('ID', 'key'), array ('Title', 'v255'), array ('Text', 'text'), array ('FormatterID', 'fid'), array ('OriginalAlias', 'v64'), array ('Uploads', 'text'), array ('IsPublished', '0'), array ('IsCommentable', '0'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('Offset', 'int'), array ('IsDST', '0'), array ('IsIndexed', '0'), array ('IsExternal', '0'), array ('SourceID', 'pkey'), array ('SourceNoteID', 'pkey'), array ('SourceNoteURL', 'v255'), array ('SourceNoteJSONURL', 'v255'), array ('SourceNoteData', 'text'), ), 'NotesKeywords' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('KeywordID', 'pkey'), ), 'Sources' => array ( array ('ID', 'key'), array ('TrueID', 'pkey'), array ('Title', 'v255'), array ('AuthorName', 'v255'), array ('URL', 'v255'), array ('PictureURL', 'v255'), array ('IsWhiteListed', '0'), array ('IsTrusted', '0'), ), ); $_model_indexes=array ( 'Actions' => array ( "UNIQUE INDEX (`EntityID`, `Stamp`)", ), 'Aliases' => array ( "INDEX (`Alias`)", "INDEX (`EntityID`)", ), 'Comments' => array ( "INDEX (`NoteID`)", ), 'Keywords' => array (), 'Notes' => array ( "FULLTEXT (`Title`, `Text`)", "INDEX (`Stamp`)", ), 'NotesKeywords' => array ( "INDEX (`NoteID`)", ), ); $_model_minimal_table_list=array ( 'Comments', 'Keywords', 'Notes', 'NotesKeywords', ); function e2_model_data_check($f2a304,$p11e0e){ global$_model,$_model_minimal_table_list,$_config; $w08cfc=false; $n35f9b=array(); $mac5c7='SHOW TABLES FROM `'. mysqli_real_escape_string($f2a304,$p11e0e). '`'; $result=mysqli_query($f2a304,$mac5c7); if($result){ while ($zf1965=mysqli_fetch_row($result)) { foreach(array_keys($_model) as $td2ffa){ if(strcasecmp($zf1965[0],$_config['db_table_prefix'].$td2ffa)===0){ $w08cfc=true; $n35f9b[] = $td2ffa; } } } } $fd9a22=true; foreach(array_keys($_model) as $td2ffa){ if (!in_array($td2ffa,$n35f9b)) { $fd9a22=false; } } $s7ec6f=true; foreach($_model_minimal_table_list as $td2ffa){ if (!in_array($td2ffa,$n35f9b)) { $s7ec6f=false; } } return array ( 'occupied' => $w08cfc, 'complete' => $fd9a22, 'migrateable' => $s7ec6f, ); } function zb154($acf1e8,$kee11c,$z5f4dc){ $g32e95=array(); if (($f2a304=mysqli_connect($acf1e8,$kee11c,$z5f4dc)) !== false){ $result=mysqli_query($f2a304,"SHOW DATABASES"); while ($zf1965=mysqli_fetch_row($result)) { if ( mysqli_select_db($f2a304,$zf1965[0]) and !in_array($zf1965[0], array ('information_schema','mysql')) ) { $g32e95[] = $zf1965[0]; } } } return $g32e95; } function n55fd(){ global$_model,$_config; $acf1e8=$kee11c=$z5f4dc=$p11e0e=''; if(array_key_exists('db-server',$_POST)) $acf1e8= $_POST['db-server']; if(array_key_exists('db-user',$_POST)) $kee11c= $_POST['db-user']; if(array_key_exists('db-password',$_POST))$z5f4dc=$_POST['db-password']; if(array_key_exists('db-database',$_POST))$p11e0e=$_POST['db-database']; if (($f2a304=mysqli_connect($acf1e8,$kee11c,$z5f4dc)) === false){ if(mysqli_connect_errno()==1045){ return 'server-responding'; } else { return 'no-connect'; } } else { if (!$p11e0e){ $g32e95=zb154($acf1e8,$kee11c,$z5f4dc); $p11e0e=$g32e95[0]; } if(mysqli_select_db($f2a304,$p11e0e)===false){ return 'server-lets-in'; } else { $maae42=e2_model_data_check($f2a304,$p11e0e); if ($maae42['occupied'] and $maae42['migrateable']) { return 'bingo-data-exists'; } elseif ($maae42['occupied']) { return 'data-incomplete'; } else { return 'bingo'; } } } } function ua0f9($paab9e){ global$_config; $h7694f=( "SHOW TABLES LIKE '". $_config['db_table_prefix'].$paab9e . "'" ); o0738($h7694f); $c9b207=r0d6b(); return count($c9b207) > 0; } function if1ac($paab9e){ global$_model,$_model_contractions,$_model_indexes,$_config; if (ua0f9($paab9e)) { return true; } $k851f5=$_config['db_table_prefix']; if(array_key_exists($paab9e,$_model)) { $a54ca8=array(); foreach($_model[$paab9e] as $x1afd3){ list ($ib0689,$x599dc)=$x1afd3; $a54ca8[] = "`". $ib0689 ."` ". $_model_contractions[$x599dc]; } $q1b1cc=( "CREATE TABLE `". $k851f5.$paab9e ."` ". "(". implode(" ,",$a54ca8) .") ". "ENGINE=MyISAM DEFAULT CHARSET=utf8" ); $s260ca=o0738($q1b1cc); if(is_array(@$_model_indexes[$paab9e])) { foreach($_model_indexes[$paab9e] as $b6a992){ $q1b1cc=( "ALTER TABLE `". $k851f5.$paab9e ."` ". "ADD ". $b6a992 ); o0738($q1b1cc); } } if ($s260ca) return true; } } function m9943($paab9e,$jde17f,$ub512d='INSERT',$q07ccf=''){ global$_config,$_db; foreach ($jde17f as $c8ce4b => $l9e366){ $f10249=u7928($l9e366); if ($f10249[0]=='`'){ $qbcf11=$f10249; } else { $qbcf11="'". $f10249 ."'"; } $x8688e[$c8ce4b]=$qbcf11; } $dd05b6="`". implode("`, `",array_keys($x8688e)). "`"; $cf09cc=implode(", ",array_values($x8688e)); $q1b1cc=( $ub512d ." INTO `". $_config['db_table_prefix'].$paab9e ."` ". "(".$dd05b6 .") VALUES (". $cf09cc .")". ($q07ccf? (' '. $q07ccf):'') ); if (o0738($q1b1cc)) { $jde17f['ID']=mysqli_insert_id($_db['link']); return $jde17f; } } function eaa79($paab9e,$jde17f,$z7692d=false,$d0f543=false){ global$_config; if(__LOG)__log('Model: update record, table <'. $paab9e .'>'); $o6a7f2=array(); foreach(e2model__soft_fields_for_table_($paab9e) as $y06e3d){ if(array_key_exists($y06e3d,$jde17f)) { $f10249=u7928($jde17f[$y06e3d]); if ($f10249[0]=='`'){ $qbcf11=$f10249; } else { $qbcf11="'". $f10249 ."'"; } $o6a7f2[] = '`'. $y06e3d .'`'."=". $qbcf11 .""; } } $ib5b39=array(); if(is_array($z7692d)) { foreach(e2model__soft_fields_for_table_($paab9e) as $y06e3d){ if(array_key_exists($y06e3d,$z7692d)) { $ib5b39[] = '`'. $y06e3d .'`'."='". u7928($z7692d[$y06e3d]) ."'"; } } } if(count($ib5b39)) { $k56790=implode(" AND ",$ib5b39); } else { if (!array_key_exists('ID',$jde17f) or !is_numeric($jde17f['ID'])) { die ('API MISUSE: e2_update_record must be called with an ID field in $record when updating single row'); } $k56790="`ID`=". $jde17f['ID']; } if(count($o6a7f2) > 0){ $p91179=$d0f543? 'LOW_PRIORITY ':''; $q1b1cc=( "UPDATE ". $p91179 ."`". $_config['db_table_prefix'].$paab9e ."` ". "SET ". implode(', ',$o6a7f2) ." WHERE ". $k56790 ); if (o0738($q1b1cc)) return true; } } function e2model__soft_fields_for_table_($paab9e){ global$_model; $i2cb9d=array(); if(array_key_exists($paab9e,$_model)) { foreach($_model[$paab9e] as $y06e3d){ if (!in_array($y06e3d[1], array ('key'))) { $i2cb9d[] = $y06e3d[0]; } } } return $i2cb9d; } function e2m_install(){ global$_strings,$_superconfig,$_files_written,$_folders_written,$_diagnose; $i2cb9d=array(); if(e2_is_installed()) { e2_go_to(''); } else { if($_superconfig['disallow_installer']) { die ('Installer disabled by superconfig'); } if(__LOG)__log('Installer: not installed, present user with form'); $i2cb9d['title']=$_strings['pt--install']; $i2cb9d['heading']=$_strings['pt--install']; $mc50d0=$_strings['fb--begin']; $yd77d5['server'] = @$_COOKIE[e8c3b('install_db_server')]; $yd77d5['user_name'] = @$_COOKIE[e8c3b('install_db_user_name')]; $yd77d5['passw']=uee85(@$_COOKIE[e8c3b('install_db_passw')]); $yd77d5['name'] = @$_COOKIE[e8c3b('install_db_name')]; $i2cb9d['form-install'] = array ( 'form-action' => y83c8('e2s_install'), 'form-check-db-config-action' => y83c8('e2j_check_db_config'), 'form-list-databases-action' => y83c8('e2j_list_databases'), 'submit-text' => $mc50d0, 'retry-text' => $_strings['fb--retry'], 'db-server' => htmlspecialchars(@$yd77d5['server']? $yd77d5['server']:'localhost'), 'db-user' => htmlspecialchars(@$yd77d5['user_name']? $yd77d5['user_name']:'root'), 'db-password' => htmlspecialchars(DB_PASSWORD_RECOVER_AND_SHOW? (@$yd77d5['passw']) : ''), 'db-database' => htmlspecialchars(@$yd77d5['name']), ); $i2cb9d['form-install']['installation-possible?']=true; if(__LOG)__log('Installer: force directories'); foreach($_folders_written as $h45684){ @maf42($h45684); } if (!@isset ($_diagnose['ok?']))y8739(); if($_diagnose['ok?']) { if(__LOG)__log('Installer: everything is fine'); } else { if(__LOG)__log('Installer: problems, tell user'); $i2cb9d['form-install']['installation-possible?']=false; } } if(__LOG)__log('Installer: return'); return $i2cb9d; } function e2_instantiate($x2af72){ global$_instance; $_instance['version']=$x2af72; if (t6e52(USER_FOLDER. '/instance.psa',serialize($_instance))) { return true; } else { die ('Cannot instantiate v'. $x2af72 .': probably permission denied'); } } function e2s_instantiate($parameters){ global$_strings; if(e2_is_installed()) { die ('Remove the file "'. USER_FOLDER .'instance.psa" first'); } else { if(is_numeric($parameters['version'])) { if(e2_instantiate($parameters['version'])) { y8a40($_strings['gs--instantiated-version'] .' v'. $parameters['version'],E2E_MESSAGE); e2_go_to(y83c8('e2m_frontpage', array ('page' => 1))); die; } } } die ('Could not create instance of engine'); } function e2s_install(){ global$settings,$_strings,$_instance,$_config,$afd6b1; if(e2_is_installed()) { e2_go_to(y83c8('e2m_install')); die; } else { e2_drop_all_kinds_of_cache(); $yd77d5['server'] = @$_POST['db-server']; $yd77d5['user_name'] = @$_POST['db-user']; $yd77d5['passw'] = b1305(@$_POST['db-password']); $yd77d5['name'] = @$_POST['db-database']; if ( ($f2a304=mysqli_connect( $yd77d5['server'],$yd77d5['user_name'],$_POST['db-password'] )) === false ){ y8a40($_strings['er--cannot-connect-to-db'],E2E_DATABASE_ERROR); e2_go_to(y83c8('e2m_install')); die; } $maae42=e2_model_data_check($f2a304,$yd77d5['name']); $h0e88b=false; if ($maae42['occupied'] and $maae42['migrateable']) { if(__LOG)__log('Installer: DB data exists and migrateable'); $h0e88b=true; } elseif ($maae42['occupied']) { if(__LOG)__log('Installer: DB data exists, but incomplete'); y8a40($_strings['er--db-data-incomplete'],E2E_DATABASE_ERROR); e2_go_to(y83c8('e2m_install')); die; } $eb2c6c=ta618(@$_POST['gmt-offset']); foreach ($yd77d5 as $c8ce4b => $l9e366){ nc64a('install_db_' .$c8ce4b,$l9e366); } @session_start(); if (!array_key_exists('password',$_POST) or trim($_POST['password']) == ''){ y8a40($_strings['er--no-password-entered'],E2E_USER_ERROR); e2_go_to(y83c8('e2m_install')); die; } $d88162=trim($_POST['password']); $b2d6d8['sessions'] = array (array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => de8ed(true), 'ua' => $_SERVER['HTTP_USER_AGENT'], )); $z444bc=true; if (!k1d21($b2d6d8)) { y8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); $z444bc=false; } if (!@t6e52(USER_FOLDER.'password-hash.psa',serialize(r4c49($d88162)))) { y8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); $z444bc=false; } if (!$h0e88b){ $settings=array(); } $settings['db']=$yd77d5; $settings['timezone']=$eb2c6c; $settings['template']=DEFAULT_TEMPLATE; $settings['language']=DEFAULT_LANGUAGE; if (!@t6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { y8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); $z444bc=false; } if ($z444bc){ if ($h0e88b){ if(__LOG)__log('Installer: No need to create DB'); $pba46b=u0f7c(); if ($pba46b){ if(__LOG)__log('Installer: Migrate'); jbb8d(); } else { if(__LOG)__log('Installer: DB not OK'); y8a40($_strings['er--double-check-db-params']); } } else { if(__LOG)__log('Installer: Creating DB...'); $pba46b=( if1ac('Notes') and if1ac('Comments') and if1ac('Keywords') and if1ac('NotesKeywords') and if1ac('Aliases') and if1ac('Actions') and if1ac('Sources') ); if (!$pba46b){ if(__LOG)__log('Installer: DB not OK'); y8a40($_strings['er--double-check-db-params']); } } if ($pba46b){ if(__LOG)__log('Installer: Search index...'); $uddece=f476c(); $uddece -> erase(); g198f(); if(__LOG)__log('Installer: DB OK, instantiating...'); e2_instantiate(E2_VERSION); if(__LOG)__log('Installer: Done'); if(__LOG)__log('Installer: Complete'); } ucc38(y83c8('e2s_bsi_step', array ())); e2_go_to(); die; } else { e2_go_to(y83c8('e2m_install')); die; } } } function e2_is_installed(){ global$_instance; return (bool)$_instance; } function e2_make_sure_that_installed(){ global $x57de2,$aa57c1,$_instance,$_superconfig; if(e2_is_installed()) { if(E2_VERSION < $_instance ['version']) { if(IGNORE_VERSION_MISMATCH) return; if(__LOG)__log('Installer: cannot downdate'); header('HTTP/1.1 503 Service Unavailable'); die ('E2 does not support automatic downgrade.'); } elseif(E2_VERSION > $_instance ['version']) { if(__LOG)__log('Installer: need to update'); header('Location: http://'. $x57de2.$aa57c1 .'/perform_update/'); header('Location: '. y83c8('e2s_update_perform')); die; } else { if(__LOG)__log('Installer: no job for me'); return; } } if(__LOG)__log('Installer: not installed {'); if ((strpos($_SERVER['SERVER_SOFTWARE'],'Apache')===0)) { if(__LOG)__log('Installer: running on Apache'); $kefe79=DEFAULTS_FOLDER.'default.htaccess'; $nd5c54=false; if (!is_file($kefe79)) { echo 'File not found: '.$kefe79. '. Please use the full E2 installation package.'; die; } if(is_file('.htaccess')) { if(__LOG)__log('Installer: there is a .htaccess file in the installation directory'); $se6f97=file_get_contents($kefe79); $sc6680=file_get_contents('.htaccess'); if ($sc6680!=$se6f97){ $nd5c54=true; $h6a9d4=$cd1813='.htaccess.old'; $z3c549=1; while (is_file($cd1813)) { $cd1813=$h6a9d4 .'.'. $z3c549 ++; } if(__LOG)__log('Installer: existing .htaccess wrong, backing up as <'. $cd1813 .'>'); if (!@rename('.htaccess',$cd1813)) { if(__LOG)__log('Installer: fuck'); echo 'Looks like you are using Apache and have put an incorrect ".htaccess" file in the installation directory. Additionally, the installer was not able to back up your existing ".htaccess" file in order to replace it with the correct one. Please use the full E2 installation package and grant write access on the installation target directory, all the files and subdirectories.'; die; } } } else { $nd5c54=true; } if ($nd5c54){ if(__LOG)__log('Installer: writing a correct .htaccess file'); if (!@copy($kefe79,'.htaccess')) { if(__LOG)__log('Installer: fuck'); echo 'The installer was not able to create a correct ".htaccess" file. Please grant write access on the installation target directory.'; die; } } } if($_superconfig['disallow_installer']) { die ('Not installed'); } else { $w601f0=y83c8('e2m_install'); if(__LOG)__log('Installer: will need to install, going to '. $w601f0); if(__LOG)__log('}'); e2_go_to($w601f0); die; } } function e2j_check_db_config(){ echo n55fd(); die; } function e2j_list_databases(){ $acf1e8=$kee11c=$z5f4dc=''; if(array_key_exists('db-server',$_POST)) $acf1e8= $_POST['db-server']; if(array_key_exists('db-user',$_POST)) $kee11c= $_POST['db-user']; if(array_key_exists('db-password',$_POST))$z5f4dc=$_POST['db-password']; $g32e95=zb154($acf1e8,$kee11c,$z5f4dc); if ($g32e95) die (implode('|',$g32e95)); die; } function jbb8d(){ global$_db,$_db_error,$_config,$_model; $k851f5=$_config['db_table_prefix']; if(__LOG)__log('Migrate: start'); uc1ed($k851f5); o0738('SET sql_quote_show_create=1'); foreach(array_keys($_model) as $paab9e){ if1ac($paab9e); $h7694f="SHOW CREATE TABLE `". $k851f5.$paab9e ."`"; if(__LOG)__log('Migrate: '. $h7694f); if (o0738($h7694f)) { $d4fded[$paab9e]=r0d6b(); $d4fded[$paab9e]=$d4fded[$paab9e][0]['Create Table']; } else { die ('Database table "'. $k851f5 .$paab9e .'" not accessible during migration. Check your database availability'); } if(__LOG)__log('Migrate: '. print_r($d4fded,true)); } if (!strstr($d4fded['Notes'],'`FormatterID`')) { o0738( "ALTER TABLE `". $k851f5."Notes` ". "ADD `FormatterID` VARCHAR( 32 ) DEFAULT 'calliope' NOT NULL AFTER `Text`" ); } if (!strstr($d4fded['Notes'],'`OriginalAlias`')) { o0738( "ALTER TABLE `". $k851f5."Notes` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `FormatterID`" ); } if (!strstr($d4fded['Notes'],'KEY `Stamp` (`Stamp`)')) { o0738( "ALTER TABLE `". $k851f5."Notes` ". "ADD INDEX (`Stamp`);" ); } if(strstr($d4fded['Notes'],'`IP`')) { o0738( "ALTER TABLE `". $k851f5."Notes` ". "DROP `IP`" ); } o0738( "ALTER TABLE `". $k851f5."Notes` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); if (!strstr($d4fded['Notes'],'`IsIndexed`')) { o0738( "ALTER TABLE `". $k851f5."Notes` ". "ADD `IsIndexed` TINYINT( 1 ) DEFAULT '0' NOT NULL AFTER `IsDST`" ); } if (!strstr($d4fded['Notes'],'`Uploads`')) { o0738( "ALTER TABLE `". $k851f5."Notes` ". "ADD `Uploads` MEDIUMTEXT AFTER `OriginalAlias`" ); } o0738( "ALTER TABLE `". $k851f5."Notes` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); if (!strstr($d4fded['Notes'],'`IsExternal`')) { o0738( "ALTER TABLE `". $k851f5."Notes` ". "ADD `IsExternal` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IsIndexed`" ); } if (!strstr($d4fded['Notes'],'`SourceID`')) { o0738( "ALTER TABLE `". $k851f5."Notes` ". "ADD `SourceID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `IsExternal`" ); } if (!strstr($d4fded['Notes'],'`SourceNoteID`')) { o0738( "ALTER TABLE `". $k851f5."Notes` ". "ADD `SourceNoteID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `SourceID`" ); } if (!strstr($d4fded['Notes'],'`SourceNoteURL`')) { o0738( "ALTER TABLE `". $k851f5."Notes` ". "ADD `SourceNoteURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteID`" ); } if (!strstr($d4fded['Notes'],'`SourceNoteData`')) { o0738( "ALTER TABLE `". $k851f5."Notes` ". "ADD `SourceNoteData` MEDIUMTEXT AFTER `SourceNoteURL`" ); } if (!strstr($d4fded['Notes'],'`SourceNoteJSONURL`')) { o0738( "ALTER TABLE `". $k851f5."Notes` ". "ADD `SourceNoteJSONURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteData`" ); } if(strstr($d4fded['Notes'],'`SourceMainImageURL`')) { o0738( "ALTER TABLE `". $k851f5."Notes` ". "DROP `SourceMainImageURL`" ); } if(strstr($d4fded['Notes'],'`IsIssue`')) { o0738( "ALTER TABLE `". $k851f5."Notes` ". "DROP `IsIssue`" ); } if (!strstr($d4fded['Comments'],'KEY `NoteID` (`NoteID`)')) { o0738( "ALTER TABLE `". $k851f5."Comments` ". "ADD INDEX (`NoteID`);" ); } o0738( "ALTER TABLE `". $k851f5."Comments` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); o0738( "ALTER TABLE `". $k851f5."Comments` ". "CHANGE `Reply` `Reply` MEDIUMTEXT" ); if (!strstr($d4fded['Keywords'],'`OriginalAlias`')) { o0738( "ALTER TABLE `". $k851f5."Keywords` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `Keyword`" ); } o0738( "ALTER TABLE `". $k851f5."Keywords` ". "CHANGE `Description` `Description` MEDIUMTEXT" ); if (!strstr($d4fded['Keywords'],'`Uploads`')) { o0738( "ALTER TABLE `". $k851f5."Keywords` ". "ADD `Uploads` MEDIUMTEXT AFTER `Description`" ); } o0738( "ALTER TABLE `". $k851f5."Keywords` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); if(strstr($d4fded['Keywords'],'`ParentKeywordID`')) { o0738( "ALTER TABLE `". $k851f5."Keywords` ". "DROP `ParentKeywordID`" ); } if (!strstr($d4fded['Comments'],'`SocialType`')) { o0738( "ALTER TABLE `". $k851f5."Comments` ". "ADD `SocialType` VARCHAR(15) NULL AFTER `IP`" ); } if (!strstr($d4fded['Comments'],'`SocialID`')) { o0738( "ALTER TABLE `". $k851f5."Comments` ". "ADD `SocialID` VARCHAR(64) NULL AFTER `SocialType`" ); } if (!strstr($d4fded['Aliases'],'KEY `Alias` (`Alias`)')) { o0738( "ALTER TABLE `". $k851f5."Aliases` ". "ADD INDEX (`Alias`);" ); } if (!strstr($d4fded['Aliases'],'KEY `EntityID` (`EntityID`)')) { o0738( "ALTER TABLE `". $k851f5."Aliases` ". "ADD INDEX (`EntityID`);" ); } if (!strstr($d4fded['Aliases'],'`EntityType`')) { o0738( "ALTER TABLE `". $k851f5."Aliases` ". "ADD `EntityType` VARCHAR( 1 ) DEFAULT '' NOT NULL AFTER `ID`" ); } o0738( "UPDATE `". $k851f5."Aliases` ". "SET `EntityType` = 'n' ". "WHERE `EntityType` = ''" ); if (!strstr($d4fded['Sources'],'`TrueID`')) { o0738( "ALTER TABLE `". $k851f5."Sources` ". "ADD `TrueID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); o0738( "UPDATE `". $k851f5."Sources` ". "SET `TrueID` = `ID`" ); } return true; } function uc1ed($k851f5){ global$_model; foreach(array_keys($_model) as $td2ffa){ o0738( "SHOW TABLE STATUS LIKE '". $k851f5.$td2ffa ."' " ); $v4b43b=r0d6b(); if(count($v4b43b) > 0){ $kd89e2=$v4b43b[0]['Collation']; if ($kd89e2!='utf8_general_ci'){ if(__LOG)__log('Migrate: Convert table '. $td2ffa. ' to UTF8'); o0738( "ALTER TABLE `". $k851f5.$td2ffa ."` ". "CONVERT TO CHARACTER SET utf8 COLLATE utf8_general_ci" ); } } } } function e2s_migrate(){ jbb8d(); die ('Database migration finished.'); } function e2s_update_perform(){ global$_instance,$_model,$settings,$_config,$_diagnose; $jd98a0=max((int) ($_instance['version']), 2285); if($_instance['version']==E2_VERSION){ v4930(); die; } if ($jd98a0 < 2587){ nc5a6('caches/*'); rmdir('caches'); } if ($jd98a0 < 2691){ $settings=e2_utf8_version_of_array_($settings); if (!@t6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { y8a40($_strings['er--cannot-save-data'],E2E_PERMISSIONS_ERROR); v4006(); } } if ($jd98a0 < 2921){ $settings['template']='plain'; } if ($jd98a0 < 3223){ $settings['v3223_rss_permalinks_before_stamp']=time(); } @unlink(USER_FOLDER. 'last-update.psa'); @unlink(CACHES_FOLDER.'index.xml'); @maf42(CACHES_FOLDER); @maf42(BACKUP_FOLDER); @maf42(MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'remote/'); @maf42(MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER .'remote/'); if (@$settings['template']=='')$settings['template']=DEFAULT_TEMPLATE; if (isset ($settings['appearance']['hot_frontpage'])) { unset($settings['appearance']['hot_frontpage']); } if (isset ($settings['db']['table_prefix'])) { if($settings['db']['table_prefix'] != @$_config['db_table_prefix']) { die ('You’ve been using a database with a table prefix “'. $settings['db']['table_prefix'] .'”. Now this should be set in the configuration. Please add the following line to the file user/config.php:<br /><br />$_config[\'db_table_prefix\'] = \''. $settings['db']['table_prefix'] .'\';<br /><br />Then refresh this page.'); } else { unset($settings['db']['table_prefix']); } } if (isset ($settings['comments']['on'])) { if (!$settings['comments']['on']) { @o0738( "UPDATE LOW_PRIORITY `". $_config['db_table_prefix']."Notes` ". "SET `IsCommentable`=0" ); } $settings['comments']['default_on'] = (bool)$settings['comments']['on']; unset($settings['comments']['on']); } if ( is_file(USER_FOLDER.'settings.json') and is_file(USER_FOLDER.'settings.psa') ) { @unlink(USER_FOLDER.'settings.psa'); } if (!@t6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { y8a40($_strings['er--cannot-save-data'],E2E_PERMISSIONS_ERROR); } e2_drop_all_kinds_of_cache(); jbb8d(); if ($jd98a0 < 3238){ if (ya521()) { $uddece=f476c(); $uddece -> erase(); } g198f(); } $_diagnose['need?']=true; nc64a('diagnose','1'); e2_instantiate(E2_VERSION); if (ve852()) { y8a40(e2l_get_string('gs--updated-successfully', array ( 'from' => 'v'. $jd98a0, 'to' => 'v'. $_instance['version'], )), E2E_MESSAGE); } e2_go_to(); die; } function u0f7c(){ global$settings,$_db,$_db_error; if (@$_db['connected']!==true){ $xd7909=$settings['db']['passw']; if ( ( $h3d801=@mysqli_connect( $settings['db']['server'], $settings['db']['user_name'], $xd7909 ) ) !== false ){ mysqli_close($h3d801); if(__LOG)__log('DB: storing password in a new way'); $xd7909=b1305($xd7909); $settings['db']['passw']=$xd7909; @t6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE)); } $xd7909=uee85($xd7909); if ( ( $_db['link'] = @mysqli_connect( $settings['db']['server'], $settings['db']['user_name'], $xd7909 ) ) !== false ){ if(mysqli_select_db($_db['link'],$settings['db']['name'])) { $_db_error=DB_OK; $_db['connected']=true; return true; } else { $_db_error=DB_CANNOT_FIND; return false; } } else { $_db_error=DB_CANNOT_CONNECT; return false; } } else { $_db_error=DB_OK; return true; } } function o0738($h7694f){ global $p11755,$_db,$_db_error,$_strings; if(__LOG)__log('DB: query <'. $h7694f .'>'); $e9b54f=w7f78(); @$p11755 ++; if (u0f7c()) { $y8e815='utf8'; if ( version_compare(mysqli_get_server_info($_db['link']), '4.1','>=') and @$_db['latest_setnames']!=$y8e815 ){ mysqli_query($_db['link'],"SET NAMES ". $y8e815); $_db['latest_setnames']=$y8e815; } if($_db['result']=mysqli_query($_db['link'],$h7694f)) { if(__LOG)__log('DB: done in '. round(w7f78()-$e9b54f,3)); $_db_error=DB_OK; return true; } else { y8a40($_strings['er--error-in-query']. ': <br /><code>'.nl2br($h7694f).'</code><br />'. mysqli_error($_db['link']), E2E_DATABASE_ERROR); $_db_error=DB_QUERY_ERROR; return false; } } else { if($_db_error==DB_CANNOT_FIND){ if(__LOG)__log('DB: cannot find db'); y8a40($_strings['er--cannot-find-db'],E2E_DATABASE_ERROR); } elseif($_db_error==DB_CANNOT_CONNECT){ if(__LOG)__log('DB: cannot connect to db'); y8a40($_strings['er--cannot-connect-to-db'],E2E_DATABASE_ERROR); } else { if(__LOG)__log('DB: db error '. $_db_error); y8a40($_strings['er--error-occurred'].' ('. $_db_error .')',E2E_DATABASE_ERROR); } return false; } } function r0d6b($x599dc=MYSQLI_ASSOC){ global$_db; $i2cb9d=array(); while ($j0cc17=@mysqli_fetch_array($_db['result'],$x599dc)) { foreach ($j0cc17 as $q865c0 => $g4921c){ if(is_string($g4921c)) { $j0cc17[$q865c0]=$g4921c; } } $i2cb9d[] = $j0cc17; } return $i2cb9d; } function u7928($jb45cf){ global$_db; u0f7c(); return mysqli_real_escape_string($_db['link'],$jb45cf); } function sb488(){ echo '<pre>'; echo 'Sifting backups...<br>'; $w10ae9=array(); foreach(glob(BACKUP_FOLDER. '*.sql') as $m8c7dd){ if(preg_match('/^backup\-(\d+)\-(\d+)\-(\d+)\-at\-(\d+)\-(\d+)\-(\d+)\.sql$/is',basename($m8c7dd),$b9c28d)) { list (, $z41529,$w6f8f5,$d8277e,$y2510c,$q865c0,$v03c7c)=$b9c28d; $e96b8c=gmmktime($y2510c,$q865c0,$v03c7c,$w6f8f5,$d8277e,$z41529); $w10ae9[$e96b8c]=$m8c7dd; } } if(count($w10ae9) > 3){ echo 'More than 3 backups, time to sift...<br>'; $c536a1=-1; $wf46c9=array (SECONDS_IN_A_MINUTE,SECONDS_IN_AN_HOUR,SECONDS_IN_A_DAY, -1); $q865c0=0; foreach(array_reverse($w10ae9,true) as $e96b8c => $m8c7dd){ echo '-> '. $m8c7dd .' ('. gmdate('r',$e96b8c) .')<br>'; if ($c536a1 == -1){ echo '   latest, leave<br>'; $c536a1=$e96b8c; } elseif ($wf46c9[$q865c0] == -1){ echo '   too old, remove<br>'; unlink($m8c7dd); } else { if ($c536a1-$e96b8c < $wf46c9[$q865c0]) { echo '   no need (not long ago), remove<br>'; unlink($m8c7dd); } else { $q865c0 ++; echo '   ok, leave, set interval to '. $wf46c9[$q865c0] .'<br>'; $c536a1=$e96b8c; } } } } else { echo 'No need to sift<br>'; } echo '</pre>'; return; } function e2s_dump(){ global$_model,$_db,$_config; if (u0f7c()) { if($_db['link']) { $b68720=time() - (SECONDS_IN_A_DAY); o0738( "DELETE FROM `". $_config['db_table_prefix']."Actions` ". "WHERE (`Stamp` < ". (time() - (SECONDS_IN_A_DAY*7)) ." AND `HitCount` <= 1) ". "OR (`Stamp` < ". (time() - (SECONDS_IN_A_MONTH)) ." AND `HitCount` <= 5)". "OR (`Stamp` < ". (time() - (SECONDS_IN_A_YEAR)) ." AND `HitCount` <= 10)" ); $a9ab2e=array(); foreach(array_keys($_model) as $paab9e){ $a9ab2e[] = $_config['db_table_prefix'].$paab9e; } $o07cc6=time(); $n435ed=BACKUP_FOLDER .'backup-'.gmdate('Y-m-d-\a\t-H-i-s',$o07cc6).'.sql'; e2_backup( $_db['link'], $a9ab2e, $n435ed ); sb488(); die ('Backed up.'); } } die ('Could not backup.'); } define('ALIAS_MAX_LENGTH',64); function e2ali__alias_from_title_($p36cd3){ global$_config; $e3e891=$p36cd3; if(array_key_exists('autoreplace_for_aliases',$_config)) { $e3e891=strtr( $e3e891, $_config['autoreplace_for_aliases'] ); } $e3e891=e2l_transliterate($e3e891); $e3e891=str_replace('\'','',$e3e891); $e3e891=str_replace('’','',$e3e891); $e3e891=str_replace(chr(146),'',$e3e891); $q17901=''; for ($q865c0=0; $q865c0 < strlen($e3e891); ++ $q865c0){ if ( (ord($e3e891[$q865c0]) >= 48 and ord($e3e891[$q865c0]) <= 57) or (ord($e3e891[$q865c0]) >= 65 and ord($e3e891[$q865c0]) <= 90) or (ord($e3e891[$q865c0]) >= 97 and ord($e3e891[$q865c0]) <= 122) or 0 ){ $q17901.=$e3e891[$q865c0]; } else { $q17901.='-'; } } $q17901=preg_replace('/\-+/','-',$q17901); $q17901=trim($q17901,'-'); $q17901=strtolower($q17901); if ($q17901=='-')$q17901=''; $q17901=substr($q17901,0,ALIAS_MAX_LENGTH); return $q17901; } function e2_aliasrec_of_alias_($l72487){ global$_config; if (!$l72487) return false; if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `Alias` = '" .$l72487. "' ". "ORDER BY Stamp LIMIT 1" )) { $result=r0d6b(); if(count($result)==1){ return$result[0]; } } } function e2_active_alias_for_page_($u89111,$gdffc4){ global$_config,$_e2_active_aliases; if ($gdffc4){ if ( is_array($_e2_active_aliases) and array_key_exists($u89111.$gdffc4,$_e2_active_aliases) ) { return @$_e2_active_aliases[$u89111.$gdffc4]; } else { if (o0738( "SELECT `Alias` ". "FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `EntityType` = '". $u89111 ."' ". "AND `EntityID` = ". $gdffc4 ." ". "ORDER BY `Stamp` DESC LIMIT 1" )) { $result=r0d6b(); $l72487=$result[0]['Alias']; } if (!$l72487 and $u89111==ENTITY_TYPE_TAG){ if (o0738( "SELECT OriginalAlias FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE ID = '". ((int)$gdffc4)."'") ) { $result=r0d6b(); $l72487=$result[0]['OriginalAlias']; } } $_e2_active_aliases[$u89111.$gdffc4]=$l72487; } return @$_e2_active_aliases[$u89111.$gdffc4]; } } function dd712($t15d61,$u89111,$gdffc4,$p36cd3,$ffb873=1){ global$_e2_active_aliases; if ($t15d61=='set' and (!$u89111 or !$gdffc4)) return false; $q17901=e2ali__alias_from_title_($p36cd3); if ($ffb873 > 1){ $p9f626='-'. $ffb873; $q17901=substr($q17901,0,ALIAS_MAX_LENGTH-strlen($p9f626)) . $p9f626; } if ( $q17901!='' and $gc45dd=e2_aliasrec_of_alias_($q17901) ) { $d6bae4=$gc45dd['EntityType']; $n1123c=$gc45dd['EntityID']; if ( (($gdffc4 and $n1123c==$gdffc4) and ($u89111 and $d6bae4==$u89111)) or $q17901!=e2_active_alias_for_page_($d6bae4,$n1123c) ) { if ($t15d61=='find'){ return $q17901; } if ($t15d61=='set'){ if (eaa79('Aliases', array ( 'ID' => $gc45dd['ID'], 'EntityType' => $u89111, 'EntityID' => $gdffc4, 'Alias' => $q17901, 'Stamp' => time(), ))) { return$_e2_active_aliases[$u89111.$gdffc4]=$q17901; } } } else { return dd712($t15d61,$u89111,$gdffc4,$p36cd3,$ffb873+1); } } else { if ($u89111 and $gdffc4 and $q17901==''){ if(e2_active_alias_for_page_($u89111,$gdffc4)==''){ return ''; } } if ( $u89111==ENTITY_TYPE_TAG and $rd62e3=h8770($q17901) ) { if ($rd62e3['ID']!=$gdffc4){ return dd712($t15d61,$u89111,$gdffc4,$p36cd3,$ffb873+1); } } if ($t15d61=='find'){ return $q17901; } if ($t15d61=='set'){ if (m9943('Aliases', array ( 'EntityType' => $u89111, 'EntityID' => $gdffc4, 'Alias' => $q17901, 'Stamp' => time(), ))) { return$_e2_active_aliases[$u89111.$gdffc4]=$q17901; } } } return ''; } function e2m_note($parameters=array ()) { global $settings, $x57de2, $_config, $_superconfig, $_strings; if(__LOG)__log('Note {'); $uaad65=$parameters['*note']; if($_config['note_url_slidedown']) { $e229c3=$parameters['day-number']; $l80791=-1; if(__LOG)__log('Slidedown {'); while (1){ if ( $uaad65==false or !($uaad65['IsVisible'] or ve852()) ) { if ($l80791 == -1){ $l80791=jf9fb( $parameters['year'],$parameters['month'],$parameters['day'] ); } if ($e229c3 > 1){ -- $e229c3; $uaad65=@$l80791[$e229c3-1]; continue; } return e2_error404_mode(); } else { break; } } if(__LOG)__log('redirect if necessary'); if ($e229c3!=$parameters['day-number']) { $parameters['day-number']=$e229c3; e2_go_to(y83c8('e2m_note',$parameters)); } if(__LOG)__log('} // Slidedown'); } if ($uaad65==false){ return e2_error404_mode(); } $od58c0=y83c8('e2m_note',$parameters); if(__LOG)__log('Navigation {'); $jfcb08=scca7($uaad65,'prev'); $gd0cab=scca7($uaad65,'next'); if ($jfcb08){ $ab3b32['prev-href']=y83c8('e2m_note', array ('*note' => $jfcb08)); $ab3b32['prev-title']=g6f10(htmlspecialchars($jfcb08['Title'],ENT_NOQUOTES,HSC_ENC)); } if ($gd0cab){ $ab3b32['next-href']=y83c8('e2m_note', array ('*note' => $gd0cab)); $ab3b32['next-title']=g6f10(htmlspecialchars($gd0cab['Title'],ENT_NOQUOTES,HSC_ENC)); } $ab3b32['title']=$_strings['nm--posts']; $ab3b32['timeline?']=false; $ab3b32['this-title']=g6f10(htmlspecialchars($uaad65['Title'],ENT_NOQUOTES,HSC_ENC)); if(__LOG)__log('}'); if(__LOG)__log('packaging...'); $uaad65['_']['_id']=$uaad65['ID']; $uaad65['_']['_ord']=0; $uaad65['_']['_ord_max']=0; $g8e4cd=j6791($uaad65); if(__LOG)__log('update read count...'); $zff089=time(); $zff089=$zff089 - ($zff089 % SECONDS_IN_AN_HOUR); m9943( 'Actions', array ( 'EntityID' => $uaad65['ID'], 'Stamp' => $zff089, 'HitCount' => 1, ), 'INSERT LOW_PRIORITY', 'ON DUPLICATE KEY UPDATE `HitCount` = `HitCount` + 1' ); $be35b1=''; $o33ff2=false; $d905f7=false; $a7bae4=array(); $nd09b4=''; if (ve852()) { $i83625=e2_note_cache_filename_with_id_($uaad65['_']['_id'] .'-comments-author'); } else { $i83625=e2_note_cache_filename_with_id_($uaad65['_']['_id'] .'-comments'); } $o1e8cc=null; if(CACHE_NOTES_COMMENTS and is_file($i83625)) { $o1e8cc=@unserialize(file_get_contents($i83625)); } if(__LOG)__log('Comments {'); if(is_array($o1e8cc)) { if(__LOG)__log('retrieve cached ctree'); $be35b1=$o1e8cc; } else { if(__LOG)__log('assemble ctree...'); $gc1fdc=m1baf($uaad65['ID'],"ORDER BY `Stamp`"); $na5d49=array(); $t04c25=true; foreach ($gc1fdc as $c8ce4b => $s4032b){ if ($s4032b['IsVisible']) { $s4032b['_']['_id']=$s4032b['ID']; $s4032b['_']['_ord']=$c8ce4b; $s4032b['_']['_ord_max']=count($gc1fdc)-1; $o06d4c=s86f8( $uaad65, $s4032b, $c8ce4b+1 ); if ($o06d4c['new?'] and $t04c25){ $o06d4c['first-new?']=true; $t04c25=false; } $na5d49[] = $o06d4c; } } $be35b1=$na5d49; if(CACHE_NOTES_COMMENTS)t6e52($i83625,serialize($be35b1)); } if(__LOG)__log('} // Comments'); if (!@$_superconfig['read_only'] and $g8e4cd['commentable-now?']) { $g80f02=u66aa($uaad65); } if (ve852() and rb387($uaad65,NOTE_COMMENTABLE_NOW_CONDITIONALLY)) { if ($uaad65['IsCommentable']) { $a7bae4['href']=y83c8('e2m_note_flag', array ( '*note' => $uaad65, 'flag' => 'IsCommentable', 'value' => 0, )); $a7bae4['text']=$_strings['bt--close-comments-to-post']; } else { $a7bae4['href']=y83c8('e2m_note_flag', array ( '*note' => $uaad65, 'flag' => 'IsCommentable', 'value' => 1, )); $a7bae4['text']=$_strings['bt--open-comments-to-post']; } } if ( ve852() and array_key_exists('new-comments-count',$g8e4cd) and $g8e4cd['new-comments-count'] ) { if(__LOG)__log('mark comments as not new'); e2_drop_caches_for_note_($y21158); eaa79('Comments', array ('IsNew' => 0), array ('NoteID' => $uaad65['_']['_id'])); } if(__LOG)__log('more work...'); $ze70c4['title']=$uaad65['Title']; $ze70c4['pages']=$ab3b32; $ze70c4['summary']=$g8e4cd['summary']; $ze70c4['notes'] = array ('only' => $g8e4cd); if ($be35b1) $ze70c4['comments']['each']=$be35b1; if ($a7bae4) $ze70c4['comments']['toggle']=$a7bae4; $ze70c4['comments']['count']=$g8e4cd['comments-count']; $ze70c4['comments']['count-text']=$g8e4cd['comments-count-text']; $ze70c4['comments']['new-count']=$g8e4cd['new-comments-count']; $ze70c4['comments']['new-count-text']=$g8e4cd['new-comments-count-text']; $ze70c4['comments']['commentable-now?']=$g8e4cd['commentable-now?']; if ($g80f02) $ze70c4['form-comment']=$g80f02; if(__LOG)__log('} // Note'); return $ze70c4; } function e2m_note_hitinfo($parameters=array ()) { global$_config; $uaad65=$parameters['*note']; echo '<table>'; echo '<tr valign="top">'; foreach ( array ('day','week','month','year','ever') as $na0acf ){ echo '<td>'; echo '<h2>'. $na0acf.' hits</h2>'; echo '<p>'; $v632a2=time()-g35c3($na0acf); if (o0738( "SELECT SUM(`HitCount`) HitCount FROM `". $_config['db_table_prefix']."Actions` ". "WHERE `EntityID` = ". $uaad65['ID'] ." ". "AND `Stamp` > ". $v632a2 ." ". "GROUP BY `EntityID`" )) { $c9b207=r0d6b(); echo $c9b207[0]['HitCount']; } echo '</p>'; if (o0738( "SELECT n.`ID`, n.`Title`, n.`IsFavourite`, a.`EntityID`, SUM(a.`HitCount`) HitCount ". "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n  ". "WHERE a.`Stamp` > ". $v632a2 ." ". "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID` ". "ORDER BY `IsFavourite` DESC, HitCount DESC ". "LIMIT 10" )) { echo mysqli_error(); $c9b207=r0d6b(); echo '<h3>Popular</h3>'; foreach ($c9b207 as $v4b43b){ echo '<p><a href="'. $v4b43b['ID']. '">'. $v4b43b['Title'] .'</a> ('. $v4b43b['HitCount'] .')</p>'; } } } die; } function e2m_note_withdraw($parameters=array ()) { global$_strings; $bea59a=$parameters['*note']; if (!$bea59a) return e2_error404_mode(); $b22db1=y83c8('e2m_note_broadcast', array ('*note' => $bea59a)); $bea59a['IsPublished']=0; $bea59a['IsCommentable']=0; $bea59a['IsVisible']=1; $bea59a['Stamp']=time(); $bea59a['IP']=$_SERVER['REMOTE_ADDR']; if($parameters['alias']) { $bea59a['OriginalAlias']=$parameters['alias']; } else { $bea59a['OriginalAlias']=dd712( 'find',ENTITY_TYPE_NOTE,$bea59a['ID'],$bea59a['Title'] ); } e2_drop_caches_for_note_($bea59a['ID']); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); if ($bea59a['IsFavourite']) { @unlink(CACHE_FILENAME_FAVS); } if (eaa79('Notes',$bea59a)) { j10fe($bea59a['ID']); ucc38($b22db1); dd712('set',ENTITY_TYPE_NOTE,$bea59a['ID'],''); e2_go_to(y83c8('e2m_draft', array ( 'draft' => $y21158, 'oalias' => $bea59a['OriginalAlias'], ))); } else { v4930(); } } function e2m_note_delete($parameters=array()) { global$_strings; $bea59a=$parameters['*note']; if (!$bea59a) return e2_error404_mode(); $ff91b2=!$bea59a['IsPublished']; if ($ff91b2){ $s72bd7=e2l_get_string('gs--draft-will-be-deleted', array ( 'draft' => htmlspecialchars($bea59a['Title'],ENT_NOQUOTES,HSC_ENC), )); } else { $s72bd7=e2l_get_string('gs--post-will-be-deleted', array ( 'post' => htmlspecialchars($bea59a['Title'],ENT_NOQUOTES,HSC_ENC), )); } $td5d3d=$ff91b2? $_strings['pt--draft-deletion']:$_strings['pt--post-deletion']; $q57529=array ( '.note-id' => $bea59a['ID'], '.is-draft' => (int)$ff91b2, 'note-title' => htmlspecialchars($bea59a['Title'],ENT_COMPAT,HSC_ENC), 'caution-text' => $s72bd7, 'form-action' => y83c8('e2s_note_delete'), 'submit-text' => $_strings['fb--delete'], 'draft?' => (int)$ff91b2, ); if ($bea59a['IsPublished']) { $q57529['withdraw-href']=y83c8( 'e2m_note_withdraw',$parameters ); } $i2cb9d=array ( 'title' => $td5d3d. ': '. htmlspecialchars($bea59a['Title'],ENT_NOQUOTES,HSC_ENC), 'heading' => $td5d3d, 'form' => 'form-note-delete', 'form-note-delete' => $q57529, ); return $i2cb9d; } function e2m_note_flag_favourite($parameters){ global$_config; $parameters['flag']='IsFavourite'; if (a7e6c($parameters)) { $m67142=$parameters; $m67142['value'] = !$parameters['value']; if($parameters['value']==1){ $t99859=y83c8('e2m_note_flag_favourite',$m67142); $h1fa03='on-rehref|'. $t99859; } else { $t99859=y83c8('e2m_note_flag_favourite',$m67142); $h1fa03='off-rehref|'. $t99859; } } else { $h1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($h1fa03); } else { e2_go_to(y83c8('e2m_note',$parameters)); die; } } function e2m_note_flag($parameters){ a7e6c($parameters); if(array_key_exists('draft',$parameters)) { e2_go_to(y83c8('e2m_draft',$parameters)); } else { e2_go_to(y83c8('e2m_note',$parameters)); } die; } function a7e6c($parameters){ $y21158=$parameters['*note']['ID']; if (!is_numeric($y21158)) { return e2_error404_mode(); } e2_drop_caches_for_note_($y21158); if($parameters['flag']=='IsFavourite'){ @unlink(CACHE_FILENAME_FAVS); } $result=eaa79('Notes', array ( 'ID' => $y21158, $parameters['flag'] => (int) ($parameters['value']==1), )); return$result; } function e2m_note_use_formatter($parameters){ $y21158=$parameters['*note']['ID']; if (!is_numeric($y21158)) { return e2_error404_mode(); } e2_drop_caches_for_note_($y21158); if (!$parameters['*note']['IsPublished']) { @unlink(CACHE_FILENAME_DRAFTS); } if(in_array($parameters['formatter'], array ('calliope','raw','neasden'))) { $result=eaa79('Notes', array ( 'ID' => $y21158, 'FormatterID' => $parameters['formatter'], )); echo 'formatter set to '. $parameters['formatter']; } else { echo 'unknown formatter'; } die; } function e2m_note_edit($parameters=array ()) { return a7dd3('edit',$parameters); } function a7dd3($i60cd8,$parameters=array ()) { global$full_blog_url,$_strings,$_config; $td5d3d=$_strings['pt--new-post']; $kf74f5=$_strings['pt--new-post']; $y21158='new'; $t9763c=$_config['default_formatter']; if ($i60cd8=='edit'){ $bea59a=$parameters['*note']; if (!$bea59a) return e2_error404_mode(); if ($bea59a){ if ($bea59a['IsPublished']) { $kf74f5=$_strings['pt--edit-post']; $g3aa13=''; $l72487=$parameters['alias']; } else { $kf74f5=$_strings['pt--edit-draft']; $g3aa13=dd712( 'find',ENTITY_TYPE_NOTE,$bea59a['ID'],$bea59a['Title'] ); if (@$bea59a['OriginalAlias']) { $l72487=$bea59a['OriginalAlias']; } else { $l72487=$g3aa13; } } } $y21158=$bea59a['ID']; $t9763c=$bea59a['FormatterID']; $td5d3d=$bea59a['Title']; } $r04868=q5d57(); $g77b75=array(); foreach ($r04868 as $od7df5){ $g77b75[] = $od7df5['tag']; } $rd2e3e=array(); if ($i60cd8=='edit' and count($g77b75)) { $r04868=ta463($bea59a['ID']); foreach ($r04868 as $od7df5){ $rd2e3e[] = htmlspecialchars($od7df5['Keyword'],ENT_NOQUOTES,HSC_ENC); } } $tc93df=array(); foreach ($g77b75 as $od7df5){ $afd2ef['name']=$od7df5; $afd2ef['selected?']=in_array($od7df5,$rd2e3e); $tc93df[] = $afd2ef; } $k9dbb8=''; $rd2e3e=implode(', ',$rd2e3e); if ($rd2e3e)$k9dbb8=$rd2e3e; if ($i60cd8=='write'){ $mc50d0=$_strings['fb--save-and-preview']; } if ($i60cd8=='edit'){ if(array_key_exists('draft',$parameters)) { $mc50d0=$_strings['fb--save-and-preview']; } else { $mc50d0=$_strings['fb--save-changes']; } } $re449c=array(); if ($i60cd8=='edit'){ $re449c=yc0c4( $bea59a['FormatterID'],$bea59a['Text'],'full' ); } $b75e1b=gf898( 'note',$y21158,$re449c ); if ($i60cd8=='edit'){ n2f83( 'Notes', $bea59a, $re449c ); } $e96b8c=min($bea59a['Stamp'],time()); $xc999b=cd10e(); $i2cb9d['title']=$td5d3d; $i2cb9d['heading']=$kf74f5; $i2cb9d['form']='form-note'; $i2cb9d['body-uploads-enabled?']=r1363($xc999b); $i2cb9d['form-note'] = array ( '.note-id' => $y21158, '.formatter-id' => $t9763c, '.from' => substr($_SERVER['HTTP_REFERER'],strlen($full_blog_url)+1), '.old-tags-hash' => md5($k9dbb8), '.action' => $i60cd8, 'form-action' => y83c8('e2s_note_process'), 'form-note-livesave-action' => y83c8('e2j_note_livesave'), 'form-file-upload-action' => y83c8('e2j_file_upload'), 'form-file-remove-action' => y83c8('e2j_file_remove'), 'create:edit?' => (bool) ($i60cd8=='write'), 'title' => htmlspecialchars($bea59a['Title'],ENT_COMPAT,HSC_ENC), 'tags' => $k9dbb8, 'tags-info' => $tc93df, 'text' => htmlspecialchars($bea59a['Text'],ENT_NOQUOTES,HSC_ENC), 'uploads' => $b75e1b, 'uploads-enabled?' => r1363($xc999b), 'all-tags' => $g77b75, 'stamp-formatted' => a5a2f('d.m.Y H:i:s',$e96b8c,y0923($bea59a)), 'time' => $bea59a['IsPublished']? array ((int)$e96b8c,y0923($bea59a)) : false, 'alias-autogenerated' => $g3aa13, 'alias' => $l72487, 'submit-text' => $mc50d0, 'space-usage' => vaf64($xc999b), ); if (!$t85faf){ } if ($i60cd8=='edit'){ $i2cb9d['related-delete-href']=y83c8( 'e2m_note_delete', array ('*note' => $bea59a) ); if (!array_key_exists('draft',$parameters)) { $bea59a['_']['_id']=$bea59a['ID']; $bea59a['_']['_ord']=0; $bea59a['_']['_ord_max']=0; $i2cb9d['form-note']['note']=j6791($bea59a); } } return $i2cb9d; } function e2m_write(){ return a7dd3('write'); } function e2s_note_process(){ global$_fp_error,$_strings; $y21158=ja21e(); if (!$y21158){ if($_fp_error==FP_TITLE_OR_TEXT_EMPTY){ y8a40($_strings['er--post-must-have-title-and-text'],E2E_USER_ERROR); } elseif($_fp_error==FP_NO_ID_OR_NEW){ } else { y8a40($_strings['er--error-occurred']); } e2_go_to(y83c8('e2m_write')); die; } $uaad65=j4627($y21158); if ($uaad65['IsPublished']) { e2_go_to(y83c8('e2m_note', array ('*note' => $uaad65))); } else { e2_go_to(y83c8('e2m_draft', array ('*note' => $uaad65))); } die; } function e2s_note_publish(){ global$_strings,$_config,$settings; $y21158=false; if(array_key_exists('note-id',$_POST)) { $y21158=$_POST['note-id']; $bea59a=j4627($y21158); $h82b30=$bea59a['OriginalAlias']; $p098ae=$bea59a['Stamp']; $pbb4fe=!$bea59a['IsExternal']; $bea59a['ID']=$y21158; $bea59a['IsPublished']=1; $bea59a['IsCommentable'] = (int)$settings['comments']['default_on']; $bea59a['IsFavourite']=0; if ($pbb4fe){ $bea59a['Stamp']=time(); } else { $bea59a['Stamp']=$p098ae; } pd2e1($bea59a); $eb2c6c=ta618(@$_POST['gmt-offset']); if ($eb2c6c){ $bea59a['Offset'] = (int)$eb2c6c['offset']; $bea59a['IsDST'] = (int)$eb2c6c['is_dst']; } e2_drop_caches_for_note_($y21158); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); if (eaa79('Notes',$bea59a)) { $l72487=''; if ($h82b30){ $l72487=dd712('set',ENTITY_TYPE_NOTE,$y21158,$h82b30); $bea59a['OriginalAlias']=$l72487; } if ($l72487!=$h82b30){ eaa79('Notes',$bea59a); } l5b68($bea59a); e2_go_to(y83c8('e2m_note', array ('*note' => $bea59a))); die; } else { v4930(); die; } } e2_go_to(); die; } function je268($y21158,$n9a92d){ global$_config; e2_drop_caches_for_note_($y21158); if ($n9a92d){ @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } else { @unlink(CACHE_FILENAME_FAVS); } if (o0738( "DELETE FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `ID` = '".((int)$y21158)."'" )) { j10fe($y21158); o0738( "DELETE FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `EntityID`=". ((int)$y21158) ); o0738( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `NoteID`=". ((int)$y21158) ); return true; } } function e2s_note_delete(){ global$_strings,$_config; $y21158=$_POST['note-id']; $n9a92d=(bool)$_POST['is-draft']; $bea59a=j4627($y21158); $b22db1=y83c8('e2m_note_broadcast', array ('*note' => $bea59a)); if (je268($y21158,$n9a92d)) { ucc38($b22db1); if ($n9a92d){ e2_go_to(y83c8('e2m_drafts')); } else { e2_go_to(); } } die; } function e2j_note_livesave(){ die (ja21e('ajaxresult')); } function j6791($uaad65,$y8698e=false){ global $settings, $_config, $_superconfig, $_candy, $_current_tag, $x57de2, $qe5564, $full_blog_url; if (!is_numeric($uaad65['_']['_id'])) return false; $zda497=e2_note_cache_filename_with_id_($uaad65['_']['_id']); $ye244c=null; if(CACHE_NOTES and is_file($zda497)) { $ye244c=@unserialize(file_get_contents($zda497)); } if(__LOG)__log('Notes: package note <'. $uaad65['_']['_id'] .'>...'); $fe919a=w7f78(); if(CACHE_NOTES and is_array($ye244c)) { if(__LOG)__log('Notes: retrieve cached ctree'); $sc6827=$ye244c; } else { if(__LOG)__log('Notes: assemle cacheable ctree...'); if(__LOG)__log('Notes: formatter ID = '. $uaad65['FormatterID']); $m2bfe4=a154e($uaad65['FormatterID'], @$uaad65['Text'],'full'); $sc6827['title'] = g6f10(htmlspecialchars($uaad65['Title'],ENT_NOQUOTES,HSC_ENC)); $sc6827['text'] = $m2bfe4['text-final']; $sc6827['summary'] = u5421($sc6827['text']); $sc6827['format-info'] = $m2bfe4['meta']; $sc6827['time'] = array ((int)min($uaad65['Stamp'],time()), y0923($uaad65)); $sc6827['last-modified'] = array ((int)min($uaad65['LastModified'],time()), y0923($uaad65)); $sc6827['last-ip'] = $uaad65['IP']; $sc6827['published?'] = (bool)$uaad65['IsPublished']; $sc6827['commentable?'] = (bool) ($uaad65['IsCommentable'] && $uaad65['IsPublished']); $sc6827['favourite?'] = (bool) ($uaad65['IsFavourite'] && $uaad65['IsPublished']); $sc6827['visible?'] = (bool) ($uaad65['IsVisible'] || !$uaad65['IsPublished']); $rd972d=@$uaad65['SourceNoteData']; $rd972d=@json_decode($rd972d,true); $sc6827['source-main-image-url'] = @$rd972d['og_images'][0]; if(is_array($m2bfe4['meta']['resources-detected'])) { w6be4($m2bfe4['meta']['resources-detected']); } if (!$sc6827['published?'])$sc6827['time']=$sc6827['last-modified']; $sc6827['og-images']=kdbcc( 'note',$uaad65['_']['_id'], $sc6827['format-info']['resources-detected'] ); $k0dff3=nce23($uaad65['ID']); $sd57ac=array(); foreach ($k0dff3 as $q865c0 => $pb19ad){ $sc6827['og-images']=array_merge( $sc6827['og-images'], kdbcc('tag',$pb19ad['ID'], array ()) ); $oe4d23['name']=htmlspecialchars($pb19ad['Keyword'],ENT_NOQUOTES,HSC_ENC); $oe4d23['href']=y83c8('e2m_tag', array ('*tag' => $pb19ad)); $sd57ac[] = $oe4d23; } $sc6827['tags']=$sd57ac; if (@in_array(SYSTEM_LIBRARY_FOLDER. 'jouele/jouele.js',$m2bfe4['meta']['links-required'])) { $sc6827['playlist?']=true; } $d905f7=p254f($uaad65['ID']); if ($sc6827['published?']) { $sc6827['comments-count']=$d905f7; $sc6827['your-comment-href'] = ( y83c8('e2m_note_comment', array ('*note' => $uaad65)) ); } $ye244c=$sc6827; if(CACHE_NOTES) @t6e52($zda497,serialize($ye244c)); } if ($y8698e){ if(__LOG)__log('Notes: short-track package for caching only'); if(__LOG)__log('Notes: package note done in '. round(w7f78()-$fe919a,3)); return $sc6827; } if(__LOG)__log('Notes: continue with the uncacheable, '. round(w7f78()-$fe919a,3) .' so far...'); $sc6827['commentable-now?']=rb387($uaad65); if(array_key_exists('comments-count',$sc6827)) { $sc6827['comments-count-text']=e2l_get_string('gs--n-comments', array ( 'number' => $sc6827['comments-count'] )); } foreach ($sc6827['tags'] as $c8ce4b => $l9e366){ $sc6827['tags'][$c8ce4b]['current?'] = (bool) ($sc6827['tags'][$c8ce4b]['name']==$_current_tag); } $y2e88c=$uaad65['IsPublished']?'e2m_note':'e2m_draft'; $sc6827['href']=y83c8($y2e88c, array ('*note' => $uaad65)); if ($uaad65['IsPublished']) { if ($uaad65['OriginalAlias']) { $sc6827['href-original']=y83c8('e2m_note', array ('alias' => $uaad65['OriginalAlias'])); } else { $u010d9=$uaad65; $u010d9['__noalias!']=true; $sc6827['href-original']=y83c8('e2m_note', array ('*note' => $u010d9)); } } $sc6827=array_merge($sc6827,o1a48($uaad65,true)); $sc6827['comments-link?'] = (bool) ( $uaad65['IsPublished'] && (rb387($uaad65) or ($sc6827['comments-count'] > 0)) && ('e2m_note'!=$_candy) ); if (ve852()) { $sc6827['hit-count']=a29c2($uaad65['ID']); $ife9e2=p254f($uaad65['ID'],'new'); $sc6827['new-comments-count']=$ife9e2; $sc6827['new-comments-count-text']=e2l_get_string('gs--comments-n-new', array ( 'number' => $ife9e2 )); if ($uaad65['IsPublished']) { if ($uaad65['IsFavourite']) { $sc6827['favourite-toggle-href']=y83c8( 'e2m_note_flag_favourite', array ('*note' => $uaad65,'value' => 0) ); } else { $sc6827['favourite-toggle-href']=y83c8( 'e2m_note_flag_favourite', array ('*note' => $uaad65,'value' => 1) ); } } $sc6827['edit-href']=y83c8( 'e2m_note_edit', array ('*note' => $uaad65) ); $l9920c=$sc6827['edit-href']; } if($settings['appearance']['show_sharing_buttons']) { $veb769=$_config['share_to']; $u21bdd='|twitter|facebook|gplus|vkontakte|telegram|linkedin|whatsapp|'; if (@$_config['share_to_twitter_via']) { $p8d777['twitter']['via']=$_config['share_to_twitter_via']; } if(count($sc6827['og-images']) > 0){ $b62933=$sc6827['og-images'][0]; $u21bdd.='pinterest|'; $p8d777['pinterest']['media']=$b62933; } $sc6827['shareable?']=false; foreach(explode(',',$veb769) as $f5a9d3){ $f5a9d3=trim($f5a9d3); if(strstr($u21bdd,'|'. $f5a9d3. '|')) { $sc6827['shareable?']=true; $sc6827['share-to'][$f5a9d3]['share?']=true; if ($p8d777[$f5a9d3]) { $sc6827['share-to'][$f5a9d3]['data']=$p8d777[$f5a9d3]; } } } } if(array_key_exists('_',$uaad65))$sc6827['_']=$uaad65['_']; if(__LOG)__log('Notes: package note done in '. round(w7f78()-$fe919a,3)); return $sc6827; } function j4627($xb80bb){ global$_strings,$_config; if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `ID` = '".$xb80bb."'" )) { $wfa816=r0d6b(); if(count($wfa816) > 0){ return $wfa816[0]; } else { return false; } } else { y8a40($_strings['er--cannot-get-post-from-db'],E2E_DATABASE_ERROR); v4930(); die; } } function a29c2($y21158){ global$_config; if (o0738( "SELECT SUM(`HitCount`) HitCount ". "FROM `". $_config['db_table_prefix']."Actions` ". "WHERE `EntityID` = ". $y21158 )) { $wfa816=r0d6b(); if(count($wfa816) > 0){ return $wfa816[0]['HitCount']; } else { return false; } } else { return false; } } function scca7($uaad65,$zb4ca4,$s8f888=1){ global$_strings,$_config; $b7ffc4=($zb4ca4=='next')?'>':'<'; $f1dee8=($zb4ca4=='next')?'':'DESC '; if (!ve852()) { $r91d12=' AND `IsVisible`=1'; } if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=". $s8f888 ." AND `Stamp` ".$b7ffc4." '".$uaad65['Stamp']."'".@$r91d12." ". "ORDER BY STAMP ".$f1dee8. "LIMIT 1" )) { $wfa816=r0d6b(); if(count($wfa816) > 0) return $wfa816[0]; else return FALSE; } else { y8a40($_strings['er--cannot-get-post-from-db'],E2E_DATABASE_ERROR); v4930(); die; } } function k82dc($z41529,$w6f8f5){ global$_config; list ($kfc6b2,$s10df4)=p5273($z41529,$w6f8f5); if (!ve852())$kf79b1="`IsVisible`=1 AND "; if (o0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND " .@$kf79b1. "`Stamp` BETWEEN '". $kfc6b2 ."' AND '". $s10df4 ."'" )) { $result=r0d6b(); $a44fde=array(); foreach($result as $n65afd){ if ( ((int)$z41529) .'/'. ((int)$w6f8f5) == a5a2f('Y/n',$n65afd['Stamp'],y0923($n65afd)) ) { $a44fde[] = (int)a5a2f('j',$n65afd['Stamp'],y0923($n65afd)); } } $a44fde=@array_unique($a44fde); sort($a44fde); return $a44fde; } else { return false; } } function sa2d8($cddf82){ global$_config; if(__LOG)__log('Lastmodifieds for Local Copier'); if(CACHE_LASTMODIFIEDS and is_file(CACHE_FILENAME_LASTMODIFIEDS)) { $s84636=@unserialize(file_get_contents(CACHE_FILENAME_LASTMODIFIEDS)); if ($s84636['ids_csv']==$cddf82){ if(__LOG)__log('Returned from cache'); return $s84636['lastmodifieds_json']; } } $k56790='WHERE `ID`='. str_replace(',',' OR `ID`=',$cddf82); $ib7d96=array(); if (o0738( "SELECT `ID`, `LastModified` ". "FROM `". $_config['db_table_prefix']."Notes` ". $k56790 )) { if(__LOG)__log('Requested from DB'); $result=r0d6b(); foreach($result as $c8ce4b => $l9e366){ $ib7d96[(int)$l9e366['ID']] = (int)$l9e366['LastModified']; } } $o08bb9=json_encode($ib7d96); if ($o08bb9=='[]')$o08bb9='{}'; $s84636=array ( 'ids_csv' => $cddf82, 'lastmodifieds_json' => $o08bb9, ); if(CACHE_LASTMODIFIEDS){ t6e52(CACHE_FILENAME_LASTMODIFIEDS,serialize($s84636)); } return $o08bb9; } function fb92c($z41529){ global$_config; list ($w5a603,$xc2b31)=p5273($z41529); if (!ve852())$kf79b1="`IsVisible`=1 AND "; if (o0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND ". @$kf79b1. "`Stamp` BETWEEN '". $w5a603. "' AND '". $xc2b31 ."'" )) { $result=r0d6b(); $xda36c=array(); foreach($result as $n65afd){ if ( ((int)$z41529) == a5a2f('Y',$n65afd['Stamp'],y0923($n65afd)) ) { $xda36c[] = (int)a5a2f('n',$n65afd['Stamp'],y0923($n65afd)); } } $xda36c=@array_unique($xda36c); sort($xda36c); return $xda36c; } else { return false; } } function dd864($p8d777){ global$settings,$e71860,$_strings; $h7694f=$p8d777['query']; if (isset ($p8d777['page']) and $p8d777['page'] < 1) return e2_error404_mode(); $sd7e5d=$settings['appearance']['notes_per_page']; $ab3b32=array(); $ffbb44=false; if (isset ($p8d777['page'])) { $e71860=$p8d777['page']; $h7694f.=' LIMIT '.($p8d777['page']-1)*$sd7e5d.', '.$sd7e5d; $s61e23=str_replace('SELECT *','SELECT count(*)',$p8d777['query']); if (o0738($s61e23)) { $result=r0d6b(); $ffbb44=$result[0]['count(*)']; $kae0fe=ceil($ffbb44/$sd7e5d); if ($e71860 > $kae0fe and $e71860!=1){ return e2_error404_mode(); } $ab3b32['count']=$kae0fe; $ab3b32['this']=$e71860; $ab3b32['timeline?']=true; $ab3b32['earlier-title']=$_strings['gs--earlier']; $ab3b32['later-title']=$_strings['gs--later']; $k920fa=$p8d777['parameters']; if ($e71860 < $kae0fe){ $k920fa['page']=$e71860+1; $ab3b32['earlier-href']=y83c8($p8d777['candy'],$k920fa); } if ($e71860 > 1){ $k920fa['page']=$e71860-1; $ab3b32['later-href']=y83c8($p8d777['candy'],$k920fa); } } else { return array (); } } $o4358b=array(); if (o0738($h7694f)) { $result=$ee5b87=r0d6b(); if (@$p8d777['query-returns-only-ids']) { $result=array(); foreach ($ee5b87 as $uaad65){ $uaad65=j4627($uaad65['ID']); if ($uaad65['IsPublished'] and ($uaad65['IsVisible'] or ve852())) { $result[] = $uaad65; } } } foreach($result as $c8ce4b => $uaad65){ $uaad65['_']['_id']=$uaad65['ID']; $uaad65['_']['_ord']=$c8ce4b; $uaad65['_']['_ord_max']=count($result)-1; $o4358b[] = j6791($uaad65); } } else { return array (); } $k05a16=$o4358b; if (!isset ($p8d777['show-all-notes']) or @$p8d777['show-all-notes']!=true){ $k05a16=array_slice($o4358b,0,$sd7e5d); } if ($ffbb44===false)$ffbb44=count($k05a16); if (!count($o4358b) and array_key_exists('nothing',$p8d777)) { $i2cb9d['nothing']=$p8d777['nothing']; } $vcd0fd=array ( 'class', 'superheading', 'heading', 'title', 'search-related-tag', ); foreach ($vcd0fd as $yf97bf){ if(array_key_exists($yf97bf,$p8d777)) { $i2cb9d[$yf97bf]=$p8d777[$yf97bf]; } } if ($ffbb44){ $x5cde2=e2l_get_string( 'pt--n-posts', array ('number' => $ffbb44) ); } else { $x5cde2=$_strings['pt--no-posts']; } if(array_key_exists('maximum-notes',$p8d777) and $ffbb44 >= $p8d777['maximum-notes']) { $x5cde2=$_strings['gs--many-posts']; } foreach (array ('title','heading','superheading') as $h4b24c){ if(strstr($p8d777[$h4b24c],'%total%')) { $i2cb9d[$h4b24c]=str_replace('%total%', $x5cde2,$p8d777[$h4b24c]); } } $i2cb9d['notes']=$k05a16; $i2cb9d['pages']=$ab3b32; return $i2cb9d; } function jf9fb($z41529,$w6f8f5,$d8277e=false){ global$_config; list ($p7b314,$ra1f20)=p5273($z41529,$w6f8f5,$d8277e); if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` AND (`Stamp` BETWEEN " .$p7b314. " AND " .$ra1f20. ")". "ORDER BY Stamp" )) { $result=r0d6b(); $zb1bc2=1; $i2cb9d=array(); foreach($result as $n65afd){ if(is_numeric($d8277e)) { $r3f917=((int)$z41529) .'/'. ((int)$w6f8f5) .'/'. ((int)$d8277e) == a5a2f('Y/n/j',$n65afd['Stamp'],y0923($n65afd)); } elseif(is_numeric($w6f8f5)) { $r3f917=((int)$z41529) .'/'. ((int)$w6f8f5) == a5a2f('Y/n',$n65afd['Stamp'],y0923($n65afd)); } else { $r3f917=((int)$z41529) == a5a2f('Y',$n65afd['Stamp'],y0923($n65afd)); } if ($r3f917){ if(is_numeric($d8277e)) { $n65afd['day_number']=$zb1bc2; } $i2cb9d[] = $n65afd; $zb1bc2 ++; } } return $i2cb9d; } else { return false; } } function e2_published_noterec_with_alias_($l72487){ if ($gc45dd=e2_aliasrec_of_alias_($l72487)) { $uaad65=j4627($gc45dd['EntityID']); if ($uaad65['IsPublished']) return $uaad65; } } function e2_published_noterec_with_parameters_($parameters=array ()) { $f39a37=e2_noterec_with_parameters_($parameters); if ($f39a37['IsPublished']) return $f39a37; } function e2_noterec_with_parameters_($parameters=array ()) { global$_config; $uaad65=false; $rb5445=false; if (@$parameters['oalias']) $rb5445=$parameters['oalias']; if ($rb5445){ if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `OriginalAlias` = '". $rb5445 ."' ". "AND `IsPublished` = 0" )) { $uaad65=r0d6b(); if(count($uaad65)==1) { $uaad65=@$uaad65[0]; if ($uaad65) return $uaad65; } } } $s67e85=false; if (@$parameters['draft']) $s67e85=$parameters['draft']; if (@$parameters['draft2'])$s67e85=$parameters['draft2']; if ($s67e85){ $uaad65=j4627($s67e85); return $uaad65; } if (@$parameters['alias']) { if ($gc45dd=e2_aliasrec_of_alias_(@$parameters['alias'])) { if ($gc45dd['EntityType']==ENTITY_TYPE_NOTE){ $uaad65=j4627($gc45dd['EntityID']); if ($uaad65['IsPublished']) return $uaad65; } } } $nc2d18=jf9fb($parameters['year'],$parameters['month'],$parameters['day']); if (@$nc2d18[$parameters['day-number']-1]) { return $nc2d18[$parameters['day-number']-1]; } } function ke56b($td5d3d,$h1cb25,$eb2c6c,$bd19c2){ global$_config; ye2f1(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); $f39a37=array ( 'Title' => $td5d3d, 'Text' => $h1cb25, 'FormatterID' => $_config['default_formatter'], 'OriginalAlias' => dd712('find',ENTITY_TYPE_UNSPECIFIED,'',$td5d3d), 'Uploads' => $bd19c2, 'Stamp' => (int)time(), 'LastModified' => (int)time(), ); if ($eb2c6c and is_array($eb2c6c)) { $f39a37['Offset'] = (int)$eb2c6c['offset']; $f39a37['IsDST'] = (int)$eb2c6c['is_dst']; } if (($f39a37=m9943('Notes',$f39a37)) !== false){ return $f39a37['ID']; } } function ja21e($r98ea6=''){ global$_fp_error,$_config,$_e2utf8__unformat_htmlentity_neasden; $_fp_error=false; $y21158=$td5d3d=$sd57ac=$h1cb25=$nb4960=''; if(array_key_exists('note-id',$_POST)) $y21158=$_POST['note-id']; if(array_key_exists('title',$_POST)) $td5d3d=trim($_POST['title']); if(array_key_exists('tags',$_POST)) $sd57ac=$_POST['tags']; if(array_key_exists('text',$_POST)) $h1cb25=trim($_POST['text'],"\r\n"); if(array_key_exists('old-tags-hash',$_POST)) $nb4960=$_POST['old-tags-hash']; if(is_array($sd57ac))$sd57ac=implode(', ',$sd57ac); $sd57ac=trim($sd57ac); if ($y21158=='new'){ $_e2utf8__unformat_htmlentity_neasden=($_config['default_formatter']=='neasden'); } else { $_e2utf8__unformat_htmlentity_neasden=($_POST['formatter-id']=='neasden'); } $td5d3d=rff7c($td5d3d); $sd57ac=rff7c($sd57ac); $h1cb25=rff7c($h1cb25); $mffa71=$h1cb25; $mffa71=str_replace("\n",'\n'."\n",$mffa71); $mffa71=str_replace("\r",'\r'."\r",$mffa71); $fa6168=v163d(',',$sd57ac,'sort'); $sd57ac=implode(', ',$fa6168); $k65f31=md5($sd57ac); if(array_key_exists('browser-offset',$_POST)) { $eb2c6c=ta618(@$_POST['browser-offset']); } else { $eb2c6c=false; } $hd17d3='/^ *(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4}) +(\d{1,2})\:(\d{1,2})\:(\d{1,2}) *$/'; $o02b37=@$_POST['old-stamp']; $haddfe=@$_POST['stamp']; $l72487=@$_POST['alias']; if ($y21158!='new'){ $p383b7=j4627($y21158); } else { $p383b7=array(); } if ($y21158){ if ($td5d3d!='' and $h1cb25!=''){ if ($y21158=='new'){ $bd19c2=''; if(is_file(USER_FOLDER.'new-uploads.psa')) { $bd19c2=@file_get_contents(USER_FOLDER.'new-uploads.psa'); } if ($y21158=ke56b($td5d3d,$h1cb25,$eb2c6c,$bd19c2)) { @unlink(USER_FOLDER.'new-uploads.psa'); $b33dd5='e2m_draft'; $c5ce5d=array ( '*note' => j4627($y21158), ); $h1fa03='{'. '"status": "created", '. '"id": "'. $y21158 .'", '. '"note-url": "'. y83c8($b33dd5,$c5ce5d) .'", '. '"note-edit-url": "'. y83c8('e2m_note_edit',$c5ce5d) .'"'. '}'; $result=(int)$y21158; } else { $h1fa03='{"status": "error", "message": "Cannot create record"}'; $result=false; } } else { e2_drop_caches_for_note_($y21158); if (!$p383b7['IsPublished']) { @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } $s71671=$p383b7; $s71671['ID']=$y21158; $s71671['Title']=$td5d3d; $s71671['Text']=$h1cb25; $s71671['FormatterID']=$p383b7['FormatterID']; $s71671['LastModified']=time(); $s71671['IsIndexed']='1'; if ($o02b37!=$haddfe){ if(preg_match($hd17d3,$haddfe,$w6f8f5)) { $e96b8c=gmmktime($w6f8f5[4],$w6f8f5[5],$w6f8f5[6],$w6f8f5[2],$w6f8f5[1],$w6f8f5[3]); $e96b8c -= xb2bf($eb2c6c,$e96b8c); $e96b8c=min($e96b8c,time()); $s71671['Stamp']=$e96b8c; } else { unset ($e96b8c); } } $q17901=$l72487; if ($l72487){ $la7ff0=$l72487; } elseif (!$p383b7['IsPublished']) { $la7ff0=$td5d3d; } else { $la7ff0=''; } if ($p383b7['IsPublished']) { $q17901=dd712( 'set',ENTITY_TYPE_NOTE,$y21158,$la7ff0 ); $b33dd5='e2m_note'; $c5ce5d=array ( '*note' => $s71671, 'alias' => $q17901, ); } else { $q926c6=true; $q17901=dd712('find',ENTITY_TYPE_NOTE,$y21158,$la7ff0); $s71671['OriginalAlias']=$q17901; $b33dd5='e2m_draft'; $c5ce5d=array ( '*note' => $s71671, 'alias' => $q17901, ); } $re449c=yc0c4( $s71671['FormatterID'],$s71671['Text'],'full' ); if(count($re449c) > 0){ w6be4($re449c); } if (eaa79('Notes',$s71671)) { if ($s71671['IsPublished']) { pd2e1($s71671); l5b68($s71671); } $h1fa03='{'. '"status": "saved", '. '"new-alias": "'. $q17901 .'", '. '"note-url": "'. y83c8($b33dd5,$c5ce5d) .'", '. '"note-edit-url": "'. y83c8('e2m_note_edit',$c5ce5d) .'"'. '}'; $result=(int)$y21158; } else { $h1fa03='{"status": "error", "message": "Cannot update record ('. mysqli_error(). ')"}'; $result=false; } } if ($k65f31!=$nb4960){ v53f1(array ('NoteID' => $y21158)); foreach ($fa6168 as $oe4d23){ $l70b77=m0188($oe4d23); if (!$l70b77){ $l70b77['ID']=z03de($oe4d23); } o0738( "INSERT INTO `". $_config['db_table_prefix']."NotesKeywords` ". "(`NoteID`, `KeywordID`) ". "VALUES (". ((int)$y21158) .", ". ((int)$l70b77['ID']). ")" ); } } if ( $r98ea6!='ajaxresult' and $result and $_POST['instant-publish']=='yes' ){ $_POST['note-id']=$y21158; e2s_note_publish(); } } else { $h1fa03='{"status":"error", "message": "Title or text is empty"}'; $_fp_error=FP_TITLE_OR_TEXT_EMPTY; $result=false; } } else { $h1fa03='{"status":"error", "message": "No note id/new specified"}'; $_fp_error=FP_NO_ID_OR_NEW; $result=false; } ucc38(y83c8('e2s_dump', array ())); if ($r98ea6=='ajaxresult') return $h1fa03; else return$result; } function pcc02($r92c58){ global$_config; $g8b7af='p1'; if (!ve852()) { $g8b7af='p1v1'; $kf79b1="AND `IsVisible`=1"; } $xd29bb=CACHES_FOLDER.$r92c58 .'-stamp-'. $g8b7af .'.e2time.psa'; if(CACHE_EDGE_TIMEINFO and is_file($xd29bb)) { $result=@unserialize(file_get_contents($xd29bb)); } if(is_array($result)) { return$result; } else { if ($r92c58=='start'){ o0738( "SELECT Stamp, Offset, IsDST FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 ". $kf79b1 ." ORDER BY Stamp LIMIT 1" ); } elseif ($r92c58=='end'){ o0738( "SELECT Stamp, Offset, IsDST FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 ". $kf79b1 ." ORDER BY Stamp DESC LIMIT 1" ); } $result=r0d6b(); if(count($result)) { $result=array ( 'stamp' => $result[0]['Stamp'], 'timezone' => y0923($result[0]), ); if(CACHE_EDGE_TIMEINFO)t6e52($xd29bb,serialize($result)); return$result; } else { return array (); } } } function c8ca0($k1653c,$d0604c){ global$_config; if (!($k1653c and $d0604c) and !ve852()) { die ('API MISUSE: e2_notes_count_general cannot be called for invisible notes or drafts unsecurely :-('); } if (!is_bool($k1653c) or !is_bool($d0604c)) { die ('API MISUSE: e2_notes_count_general must be called with bool params :-('); } if (!$k1653c and !$d0604c){ die ('API MISUSE: e2_notes_count_general called with nonsensical parameters'); } $xd29bb=CACHES_FOLDER . 'notes-count-p'. (int)$k1653c . ($k1653c ? ('v'. (int)$d0604c):'') . '.txt'; $result=false; if(CACHE_NOTES_COUNTS and is_file($xd29bb)) { $result=@file_get_contents($xd29bb); } if(is_numeric($result) and $result > 0){ return$result; } else { o0738( "SELECT COUNT(*) As NotesCount FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=". (int)$k1653c. " ". ($k1653c ? ( "AND `IsVisible`=". (int)$d0604c ):"") ); $result=r0d6b(); $result=$result[0]['NotesCount']; if($result){ if(CACHE_NOTES_COUNTS)t6e52($xd29bb,$result); return$result; } else { return null; } } } function u5421($h1cb25){ $ka80da=$h1cb25; $ka80da=preg_match( '/^(\<\/div\>)?\<p( class\=\"lead\")?\>(.*)\<\/p\>$/m', $ka80da, $b9c28d ); $ka80da=$b9c28d[3]; if (!$ka80da)$ka80da=$h1cb25; $ka80da=str_replace(array ( '<p>','<blockquote>','<ul>','<ol>','<br />', ), "\n",$ka80da); $ka80da=trim(strip_tags($ka80da)); if(strpos($ka80da,"\n")!==false){ $ka80da=substr($ka80da,0,strpos($ka80da,"\n")); $ka80da=trim($ka80da,' :.()'."\n"); } if(preg_match('/^(.{100,}?)[:.!?()]|'."\n".'/s',$ka80da,$b9c28d)) { $ka80da=trim($b9c28d[0],' :.()'."\n"); } if(preg_match('/^(.{150,}?)[:.!?(),]/s',$ka80da,$b9c28d)) { $ka80da=trim($b9c28d[0],' :.()'."\n"); } if(preg_match('/^(.{200,}?)[:.!?(), ]/s',$ka80da,$b9c28d)) { $ka80da=trim($b9c28d[0],' :.()'."\n"); } if(in_array($ka80da[strlen($ka80da)-1], array (',',' '))) { $ka80da=trim($ka80da,', '). '...'; } if(mb_strlen($ka80da) > 250){ $ka80da=mb_substr($ka80da,0,250). '...'; } if ($ka80da[-1]==':')$ka80da=mb_substr($ka80da,0, -1); return $ka80da; } define('DRAFT_PREVIEW_LENGTH',100); function e2m_drafts(){ global$_strings,$_config; if(__LOG)__log('Drafts list: working...'); $hda3ad='LastModified'; $uda48a=null; if(CACHE_DRAFTS and is_file(CACHE_FILENAME_DRAFTS)) { $uda48a=@unserialize(file_get_contents(CACHE_FILENAME_DRAFTS)); } if(CACHE_DRAFTS and is_array($uda48a)) { if(__LOG)__log('Drafts list: retrieve cached ctree'); } else { if(__LOG)__log('Drafts list: assemle cacheable ctree...'); $uda48a=array(); if(__LOG)__log('Drafts list: select by '. $hda3ad .'...'); if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=0 ". "ORDER BY `". $hda3ad ."` DESC" )) { $result=r0d6b(); $o4358b=array(); foreach($result as $c8ce4b => $f39a37){ $uaad65=array(); $uaad65['_']['_id']=$f39a37['ID']; $uaad65['_']['_ord']=k; $uaad65['_']['_ord_max']=count($result)-1; $uaad65['href']=y83c8('e2m_draft', array ('*note' => $f39a37)); $uaad65['title']=g6f10(htmlspecialchars($f39a37['Title'],ENT_NOQUOTES,HSC_ENC)); if (isset ($uaad65['image-href'])) unset ($uaad65['image-href']); $f39a37['_']['_id']=$f39a37['ID']; $f39a37['_']['_ord']=0; $f39a37['_']['_ord_max']=0; $g8e4cd=j6791($f39a37,true); $uaad65['_']['_resources']=null; if ($f39a37['FormatterID']=='neasden'){ $uaad65['_']['_resources']=$g8e4cd['format-info']['resources-detected']; } elseif ($f39a37['FormatterID']=='calliope'){ $uaad65['_']['_resources']=yc0c4( $f39a37['FormatterID'],$f39a37['Text'],'full' ); } $uaad65=array_merge($uaad65,o1a48($f39a37,false)); $uaad65['text-fragment']=strip_tags($g8e4cd['text']); $d2ab2d=false; if(mb_strlen($uaad65['text-fragment']) > DRAFT_PREVIEW_LENGTH) { $d2ab2d=mb_strpos($uaad65['text-fragment'],'.',DRAFT_PREVIEW_LENGTH); } if ($d2ab2d!==false){ $uaad65['text-fragment']=mb_substr($uaad65['text-fragment'],0,$d2ab2d+1); } $uda48a[] = $uaad65; } if(CACHE_DRAFTS)t6e52(CACHE_FILENAME_DRAFTS,serialize($uda48a)); } } if(__LOG)__log('Drafts list: put thumbnail without cache'); if ($uda48a){ foreach ($uda48a as $c8ce4b => $l9e366){ $uda48a[$c8ce4b]['thumbs']=g2e82(@$l9e366['_']['_resources']); } } if(__LOG)__log('Drafts list: done'); $i2cb9d=array ( 'title' => $_strings['pt--drafts'], 'heading' => $_strings['pt--drafts'], ); if(count($uda48a)) { $i2cb9d['drafts']=$uda48a; } else { $i2cb9d['nothing']=$_strings['gs--no-drafts']; } return $i2cb9d; } function e2m_draft($parameters=array ()) { global$_strings,$x57de2; $uaad65=e2_noterec_with_parameters_($parameters); if (!$uaad65){ $parameters['alias']=$parameters['oalias']; unset($parameters['oalias']); $uaad65=e2_noterec_with_parameters_($parameters); if ($uaad65){ $od58c0=y83c8('e2m_note', array ('*note' => $uaad65)); return e2_go_to($od58c0); } } if (!$uaad65) return e2_error404_mode(); $uaad65['_']['_id']=$uaad65['ID']; $uaad65['_']['_ord']=0; $uaad65['_']['_ord_max']=0; $g8e4cd=j6791($uaad65); $v45513=array ( '.note-id' => $uaad65['ID'], 'form-action' => y83c8('e2s_note_publish'), 'submit-text' => $_strings['fb--publish-draft'], ); return array ( 'title' => $uaad65['Title'].' ('. $_strings['wd--draft'] .')', 'notes' => array ('only' => $g8e4cd), 'form' => 'form-note-publish', 'form-note-publish' => $v45513, ); } function e2m_draft_preview($parameters=array ()) { $uaad65=e2_noterec_with_parameters_($parameters); $za2d26=e2drafts__preview_key($uaad65); if(E2_EDITION and $parameters['preview-key']==$za2d26){ $result=e2m_draft($parameters); unset($result ['notes']['only']['href']); unset($result ['form']); unset($result ['form-note-publish']); return$result; } else { return e2_error404_mode(); } } function e2_draft_alias_use_count($a176fe=''){ global$_config; if(__LOG)__log('Drafts: find duplicate OriginalAliases...'); if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_file(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)) { $vda552=@unserialize(file_get_contents(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)); } if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_array($vda552)) { if(__LOG)__log('Drafts: retrieve cached'); } else { if(__LOG)__log('Drafts: assemle cacheable...'); $vda552=array(); if (o0738( "SELECT `OriginalAlias` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=0 ". "ORDER BY `ID`" )) { $result=r0d6b(); $o4358b=array(); foreach($result as $c8ce4b => $f39a37){ @$vda552[$f39a37['OriginalAlias']] ++; } } if(CACHE_DRAFTS_ALIAS_USE_COUNTS){ t6e52(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS,serialize($vda552)); } } if ($a176fe){ return $vda552[$a176fe]; } else { return $vda552; } } function e2drafts__preview_key($uaad65){ return md5($uaad65['Text'].$uaad65['LastModified']); } $_url_map=array ( '@build' => 'e2://e2s_build', '@sync' => 'e2://e2s_sync', '@dump' => 'e2://e2s_dump', '@bsi' => 'e2://e2s_bsi_status', '@bsi/drop' => 'e2://e2s_bsi_drop', '@bsi/step' => 'e2://e2s_bsi_step', '@migrate' => 'e2://e2s_migrate', '@retrieve:source' => 'e2://e2s_retrieve', '@instantiate:version' => 'e2://e2s_instantiate', 'notify' => 'e2://e2s_notify', '@notify' => 'e2://e2s_notify', '@info' => 'e2://e2m_info', '@ajax/::' => 'e2://e2j_::', '@actions/::' => 'e2://e2s_::', '' => 'e2://e2m_frontpage?page=1', ':page' => 'e2://e2m_frontpage', 'rss' => 'e2://e2m_rss', 'json' => 'e2://e2m_json', ':year' => 'e2://e2m_year', ':year/:month' => 'e2://e2m_month', ':year/:month/:day' => 'e2://e2m_day', 'all' => 'e2://e2m_everything', ':note' => 'e2://e2m_note', ':note/comment' => 'e2://e2m_note_comment', ':note/edit' => 'e2://e2m_note_edit?is_published=1', ':note/favourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=1', ':note/unfavourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=0', ':note/show' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=1', ':note/hide' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=0', ':note/discuss' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=1', ':note/quiet' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=0', ':note/withdraw' => 'e2://e2m_note_withdraw?is_published=1', ':note/json' => 'e2://e2m_note_json', ':note/broadcast' => 'e2://e2m_note_broadcast', ':note/delete' => 'e2://e2m_note_delete?is_published=1', ':note/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=1', ':note/:unsubscr' => 'e2://e2m_unsubscribe?is_published=1', ':note/hitinfo' => 'e2://e2m_note_hitinfo?is_published=1', ':note/:comnum' => 'e2://e2m_comment', ':note/:comnum/edit' => 'e2://e2m_comment_edit', ':note/:comnum/important' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=1', ':note/:comnum/usual' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=0', ':note/:comnum/replace' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=1', ':note/:comnum/remove' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=0', ':note/:comnum/spam' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=1', ':note/:comnum/good' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=0', ':note/:comnum/wipe' => 'e2://e2m_comment_delete', ':note/:comnum/reply/edit' => 'e2://e2m_comment_reply', ':note/:comnum/reply/important' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=1', ':note/:comnum/reply/usual' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=0', ':note/:comnum/reply/replace' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=1', ':note/:comnum/reply/remove' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=0', ':note/:comnum/reply/delete' => 'e2://e2m_comment_reply_delete', 'drafts' => 'e2://e2m_drafts', 'drafts/:draft' => 'e2://e2m_draft', 'drafts/:draft/edit' => 'e2://e2m_note_edit?is_published=0', 'drafts/:draft/show' => 'e2://e2m_note_flag?is_published=0&flag=IsVisible&value=1', 'drafts/:draft/hide' => 'e2://e2m_note_flag?is_published=0&flag=IsVisible&value=0', 'drafts/:draft/delete' => 'e2://e2m_note_delete?is_published=0', 'drafts/:draft/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=0', 'drafts/:draft/:preview' => 'e2://e2m_draft_preview', 'sources/:source/trust' => 'e2://e2m_source_trust', 'sources/:source/premoderate' => 'e2://e2m_source_premoderate', 'sources/:source/ban' => 'e2://e2m_source_ban', 'sources/:source/forget' => 'e2://e2m_source_forget', 'tags' => 'e2://e2m_tags', 'tags/:tag' => 'e2://e2m_tag?page=1', 'tags/:tag/:page' => 'e2://e2m_tag', 'tags/:tag/rss' => 'e2://e2m_tag_rss', 'tags/:tag/json' => 'e2://e2m_tag_json', 'tags/:tag/edit' => 'e2://e2m_tag_edit', 'tags/:tag/delete' => 'e2://e2m_tag_delete', 'tags/:tag/pin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=1', 'tags/:tag/unpin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=0', 'untagged' => 'e2://e2m_untagged', 'hot' => 'e2://e2m_most_commented', 'selected' => 'e2://e2m_favourites?page=1', 'selected/:page' => 'e2://e2m_favourites', 'found' => 'e2://e2m_found&query=', 'found/:query' => 'e2://e2m_found', 'new' => 'e2://e2m_write', 'install' => 'e2://e2m_install', 'settings' => 'e2://e2m_settings', 'settings/name' => 'e2://e2m_name_and_author', 'settings/database' => 'e2://e2m_database', 'settings/password' => 'e2://e2m_password', 'settings/timezone' => 'e2://e2m_timezone', 'settings/sessions' => 'e2://e2m_sessions', 'settings/theme-preview' => 'e2://e2m_theme_preview?theme=', 'settings/theme-preview/:theme' => 'e2://e2m_theme_preview', 'settings/get-backup' => 'e2://e2m_get_backup', 'sign-in' => 'e2://e2m_sign_in', 'sign-out' => 'e2://e2m_sign_out', ); $_url_chunks=array ( '\:page' => 'page\-(?P<page>\d+)', '\:year' => '(?P<year>\d{4})', '\:month' => '(?P<month>\d{1,2})', '\:day' => '(?P<day>\d{1,2})', '\:note' => array ( 'all\/(?P<alias>[-a-zA-Z0-9]+)', '(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)', ), '\:draft' => array ( '(?P<oalias2>[-a-zA-Z0-9]+)\/(?P<draft2>\d+)', '(?P<oalias>[-a-zA-Z0-9]+)', '-\/(?P<draft>\d+)', ), '\:comnum' => 'comment\-(?P<comment_number>[0-9]+)', '\:file' => '(?P<file>.*?)', '\:tag' => '(?P<tag_alias>[-a-zA-Z0-9]+)', '\:query' => '(?P<query>.*?)', '\:version' => '\:(?P<version>\d+)', '\:source' => '\:(?P<source>.*?)', '\:picture' => '\:(?P<picture>.*?)', '\:unsubscr' => 'unsubscribe\:(?P<unsubscribe_email>.+?)\:(?P<unsubscribe_key>[0-9a-f]{32})', '\:formatter' => '(?P<formatter>.*?)', '\:alias' => '(?P<newalias>[-a-zA-Z0-9]+)', '\:preview' => 'preview\:(?P<preview_key>[0-9a-f]{32})', '\:theme' => '(?P<theme>[-a-zA-Z0-9]+)', '\:source' => '\:(?P<source>[a-zA-Z0-9]+\=)', ); $_url_autoredirects=array ( '/^favo(?:u?)rites(\~.+)?$/i' => 'selected\\1', '/^favo(?:u?)rites\/(.+)/i' => 'selected/\\1', '/^keywords$/i' => 'tags', '/^keywords\/(.*)/i' => 'tags/\\1', '/^everything$/i' => 'all', '/^search\/(.+)/i' => 'found/\\1', '/^(\d{4}\/\d{1,2}\/\d{1,2}\/\d+)\/comments(\/?)$/i' => '\\1', '/^\~(\d+)/i' => 'page-\\1', '/\/?\~(\d+)/i' => '/page-\\1', ); function sb6b0($j572d4){ global$_url_autoredirects,$aa57c1; $j572d4=preg_replace(array_keys($_url_autoredirects),array_values($_url_autoredirects),$j572d4); if(preg_match('/^([0-9]+)[.-]([0-9]+)[.-]([0-9]+)(.*)/',$j572d4,$b9c28d)) { if(2==strlen($b9c28d[3]))$b9c28d[3]='20'.$b9c28d[3]; return ($b9c28d[3].'/'.$b9c28d[2].'/'.$b9c28d[1].$b9c28d[4]); } if(preg_match('/^tags\-rss\/(.*?)\/?$/',$j572d4,$b9c28d)) { $oe4d23=substr($b9c28d[1],strrpos($b9c28d[1],'/')+1); return ('tags/'. $oe4d23.'/rss/'); } return $j572d4; } function w7059(){ global$__synthetic_urls,$_config,$_superconfig; $__synthetic_urls=false; if($_config['url_composition']=='auto'){ if(function_exists('apache_get_modules')) { if(in_array('mod_rewrite',apache_get_modules())) { $__synthetic_urls=true; } } } if($_config['url_composition']=='synthetic'){ $__synthetic_urls=true; } if (@$_superconfig['url_composition']=='synthetic'){ $__synthetic_urls=true; } if (@$_superconfig['url_composition']=='real'){ $__synthetic_urls=false; } } function y83c8($zc48ba,$parameters=array ()) { global$_url_map,$_url_chunks,$_config,$__synthetic_urls,$_protocol,$x57de2,$aa57c1; $rc2bd7=array_flip($_url_map); if ( @$_config['preferred_domain_name'] and $_SERVER['HTTP_HOST']!=$_config['preferred_domain_name'] ) { $x57de2=$_config['preferred_domain_name']; } $j572d4=$_protocol .'://'. $x57de2.$aa57c1 .'/'; $f9c464='e2://'. $zc48ba; if(array_key_exists('page',$parameters)) { $e71860=$parameters['page']; } else { $e71860=1; } if($parameters){ $f9c464.='?'; $n1c61f=array(); $j21711=array(); foreach($parameters as $r3c6e0 => $g2063c){ if ($r3c6e0=='*note'){ $j21711[] = $r3c6e0; $n1c61f[] = e2urls__expand_tricky_parameters_for_note_($g2063c); } if ($r3c6e0=='*tags'){ $j21711[] = $r3c6e0; $n1c61f[] = e2urls__expand_tricky_parameters_for_tags_($g2063c); } if ($r3c6e0=='*tag'){ $j21711[] = $r3c6e0; $n1c61f[] = e2urls__expand_tricky_parameters_for_tags_(array ($g2063c)); } } foreach ($j21711 as $r3c6e0) unset($parameters[$r3c6e0]); foreach ($n1c61f as $r58e2a){ $parameters=array_merge($parameters,$r58e2a); } foreach($parameters as $r3c6e0 => $g2063c){ if (@$r3c6e0[0]!='_'){ $f9c464.=$r3c6e0 .'='. urlencode($g2063c) .'&'; } } $f9c464=substr($f9c464,0, -1); } if(array_key_exists($f9c464,$rc2bd7)) { if ($rc2bd7[$f9c464]!='')$j572d4.=$rc2bd7[$f9c464] .'/'; return $j572d4; } else { $q44907=false; foreach ($rc2bd7 as $g45ea8 => $m9ea44){ $zb7365=$g45ea8; $zb7365=preg_quote($zb7365,'/'); $aed015=parse_url($g45ea8); $s2f532=$aed015['host']; $zebe09=parse_url($f9c464); if(strstr($g45ea8,'::')) { $vffd6b=$zebe09['scheme'] .'://'. $zebe09['host']; $zb7365=str_replace('\:\:','(.*)',$zb7365); $zb7365='/^'. $zb7365 .'$/s'; if(preg_match($zb7365,$vffd6b,$b9c28d)) { $fd6fe1=str_replace('::',$b9c28d[1],$m9ea44); $fd6fe1=str_replace('_','-',$fd6fe1); $q1b1cc=$zebe09['query']; if($__synthetic_urls and $q1b1cc){ $j572d4.=$fd6fe1 .'/?'. $q1b1cc; } elseif($__synthetic_urls){ $j572d4.=$fd6fe1 .'/'; } elseif ($q1b1cc){ $j572d4.='?go='. $fd6fe1 .'/&'. $q1b1cc; } else { $j572d4.='?go='. $fd6fe1 .'/'; } return $j572d4; } } $m54435=false; if ($zc48ba==$s2f532){ $q44907=true; if ($aed015['query']) { $z22c38=explode('&',$aed015['query']); foreach ($z22c38 as $l8822b){ list ($r3c6e0,$g2063c)=explode('=',$l8822b); $g2063c=urldecode($g2063c); $r3c6e0=str_replace('_','-',$r3c6e0); if ( array_key_exists($r3c6e0,$parameters) and $parameters[$r3c6e0]!=$g2063c ){ $m54435=true; break; } } } if (!$m54435){ if(preg_match_all('/\:[\-a-z]+/i',$m9ea44,$b9c28d)) { foreach ($b9c28d[0] as $vfc413){ $lb0f75=$_url_chunks['\\'. $vfc413]; if (!is_array($lb0f75)) { $lb0f75=array ($lb0f75); } $i05f62=$lb0f75[0]; foreach ($lb0f75 as $i05f62){ $geab03='/\(\?P\<(.*?)\>.*?\)/'; $x4274e=true; if (@preg_match($geab03,$i05f62,$b9c28d)) { $x4274e=true; for ($q865c0=1; $q865c0 < count($b9c28d); ++ $q865c0){ if (!$parameters[str_replace("_","-",$b9c28d[$q865c0])]) { $x4274e=false; break; } } } if (!$x4274e) continue; $kf9e1e=@preg_replace_callback( $geab03, function ($b9c28d) use ($parameters){ return$parameters[str_replace("_","-",$b9c28d[1])]; }, $i05f62 ); $kf9e1e=stripslashes($kf9e1e); $hc5d91=str_replace($vfc413,$kf9e1e,$m9ea44); break; } $m9ea44=$hc5d91; } } $k15214=array(); if ($m9ea44){ if($__synthetic_urls){ $j572d4.=$m9ea44 .'/'; } else { $k15214[] = 'go='. $m9ea44 .'/'; } } foreach($_GET as $c8ce4b => $l9e366) if(in_array($c8ce4b, array ('result','themeless'))) { $k15214[] = $c8ce4b . ($l9e366? ('='. urlencode($l9e366)) : ''); } if(count($k15214)) { $j572d4.='?'. implode('&',$k15214); } return $j572d4; } } } if ($q44907){ return $j572d4; } else { die ('Cannot compose url for candy '. $zc48ba); } } } function gb7e9($j572d4){ global$_url_map,$_url_chunks,$_config,$_current_url,$__synthetic_urls,$_protocol,$x57de2,$aa57c1; $v196c2=$j572d4; $j572d4=trim($j572d4,'/'); $j572d4=sb6b0($j572d4); if(__LOG)__log($j572d4); $parameters=array(); foreach($_url_map as $i12a24 => $g45ea8){ $nd532d=$i12a24; $nd532d=preg_quote($nd532d,'/'); if(strstr($i12a24,'::')) { $nd532d=str_replace('\:\:','(.*)',$nd532d); $nd532d='/^'. $nd532d .'$/s'; if(preg_match($nd532d,$j572d4,$b9c28d)) { $i53b9e=str_replace('-','_',$b9c28d[1]); $f9c464=str_replace('::',$i53b9e,$g45ea8); } } elseif(strstr($i12a24,':')) { $s1e380=array(); foreach($_url_chunks as $c8ce4b => $l9e366){ if(is_array($l9e366)) { $s1e380[$c8ce4b]='(?:(?:'. implode(')|(?:',$l9e366) .'))'; } else { $s1e380[$c8ce4b]=$l9e366; } } $nd532d=str_replace( array_keys($s1e380), array_values($s1e380), $nd532d ); $nd532d='/^'. $nd532d .'$/s'; if(preg_match($nd532d,$j572d4,$b9c28d)) { $f9c464=$g45ea8; foreach ($b9c28d as $r3c6e0 => $g2063c) if (!is_numeric($r3c6e0)) { $r3c6e0=str_replace('_','-',$r3c6e0); $parameters[$r3c6e0]=$g2063c; } } } else { if ($i12a24==$j572d4){ $f9c464=$g45ea8; break; } } } $jfafdd=(bool)$f9c464; if (!$f9c464)$f9c464='e2://e2m_404'; $zebe09=parse_url($f9c464); $zc48ba=$zebe09['host']; if ($zebe09['query']) { $z22c38=explode('&',$zebe09['query']); foreach ($z22c38 as $l8822b){ list ($r3c6e0,$g2063c)=explode('=',$l8822b); $g2063c=urldecode($g2063c); $r3c6e0=str_replace('_','-',$r3c6e0); $parameters[$r3c6e0]=$g2063c; } } $i2cb9d=false; $parameters=e2urls__consolidate_tricky_parameters_($parameters); if ($jfafdd){ if($_config['force_canonical_urls']) { $x95d32=y83c8($zc48ba,$parameters); list ($wa4c3a,$tab96c)=explode('?',$_SERVER['REQUEST_URI'],2); $ya37bf=$_protocol .'://'.$_SERVER['HTTP_HOST'].$wa4c3a; $v5d6ba=$_protocol .'://'.$_SERVER['HTTP_HOST'].urldecode($wa4c3a); $tab96c=explode('&',$tab96c); foreach ($tab96c as $j6c0d0){ list ($f5c5e7, ) = explode('=',$j6c0d0); if ($f5c5e7=='go'){ $ya37bf.='?'. $j6c0d0; $v5d6ba.='?'. urldecode($j6c0d0); } } $_current_url=$ya37bf; if ($ya37bf!=$x95d32 and $v5d6ba!=$x95d32){ e2_go_to($x95d32); } } if(is_callable($zc48ba)) { $i2cb9d=array ($zc48ba,$parameters); } else { $i2cb9d=array (null, array ()); } } else { $i2cb9d=array (null, array ()); } return $i2cb9d; } function e2urls__expand_tricky_parameters_for_note_($f39a37){ global $aa57c1,$_config; if (!isset ($f39a37['IsPublished'])) { return array (); } if (!$f39a37['IsPublished']) { if ($f39a37['OriginalAlias']==''){ $parameters['draft']=$f39a37['ID']; } elseif(e2_draft_alias_use_count($f39a37['OriginalAlias']) == 1){ $parameters['oalias']=$f39a37['OriginalAlias']; } else { $parameters['draft2']=$f39a37['ID']; $parameters['oalias2']=$f39a37['OriginalAlias']; } $parameters['is-published']=0; return$parameters; } $parameters['is-published']=1; $xb80bb=$f39a37['ID']; $e96b8c=$f39a37['Stamp']; $eb2c6c=y0923($f39a37); if (!isset ($f39a37['__noalias!'])) { if (isset ($f39a37['alias'])) { $parameters['alias']=$f39a37['alias']; } else { $parameters['alias']=e2_active_alias_for_page_(ENTITY_TYPE_NOTE,$f39a37['ID']); } } if($parameters['alias']) return$parameters; list ($z41529,$w6f8f5,$d8277e)=explode('/', a5a2f('Y/m/d',$e96b8c,$eb2c6c) ); $parameters['year']=$z41529; $parameters['month']=$w6f8f5; $parameters['day']=$d8277e; if (isset ($f39a37['day_number'])) { $parameters['day-number']=$f39a37['day_number']; } else { list ($zd9d0f, ) = p5273($z41529,$w6f8f5,$d8277e); if (o0738( "SELECT `ID`, `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND (`Stamp` BETWEEN " .$zd9d0f. " AND " .$e96b8c. ") ". "ORDER BY `Stamp`" )) { $result=r0d6b(); $zb1bc2=1; foreach($result as $n65afd){ if ( $z41529.'/'.$w6f8f5.'/'.$d8277e == a5a2f('Y/m/d',$n65afd['Stamp'],y0923($n65afd)) ) { if ($n65afd['ID']==$xb80bb){ $z444bc=1; break; } $zb1bc2 ++; } } if (@$z444bc!=1){ header('HTTP/1.1 503 Service Unavailable'); die ('Candidates enumeration failed.'); } } $parameters['day-number']=$zb1bc2; } return$parameters; } function e2urls__expand_tricky_parameters_for_tags_($k0dff3){ $r9299d=array(); $parameters=array(); foreach ($k0dff3 as $pb19ad){ $l72487=''; if (!isset ($pb19ad['__noalias!'])) { if (isset ($pb19ad['tag-alias'])) { $l72487=$pb19ad['tag-alias']; } else { $l72487=e2_active_alias_for_page_(ENTITY_TYPE_TAG,$pb19ad['ID']); } } $r9299d[] = $l72487? $l72487:$pb19ad['OriginalAlias']; } if(count($k0dff3)) { $parameters['tag-alias']=implode(',',$r9299d); } return$parameters; } function e2urls__consolidate_tricky_parameters_($parameters){ if ( @$parameters['alias'] or ( @$parameters['year'] and @$parameters['month'] and @$parameters['day'] and @$parameters['day-number'] ) ) { if ($uaad65=e2_published_noterec_with_parameters_($parameters)) { $parameters['*note']=$uaad65; } } if ( @$parameters['oalias'] or @$parameters['draft'] or @$parameters['oalias2'] or @$parameters['draft2'] ) { if ($uaad65=e2_noterec_with_parameters_($parameters)) { $parameters['*note']=$uaad65; } } if ( @$parameters['tag-alias'] ) { $parameters['*tags']=e2_tagrecs_with_parameters_($parameters); if(count($parameters['*tags']) == 1){ $parameters['*tag']=$parameters['*tags'][0]; } } return$parameters; } function e2m_tags(){ global$_strings; $i2cb9d['title']=$_strings['pt--tags']; $i2cb9d['heading']=$_strings['pt--tags']; $sd57ac=q5d57(); if(count($sd57ac)==0){ $i2cb9d['nothing']=$_strings['gs--no-tags']; } return $i2cb9d; } function e2m_tag($parameters=array ()) { global $settings, $_config, $_current_tag, $_strings, $e71860, $full_blog_url; if(__LOG)__log('Tag {'); if(array_key_exists('*tags',$parameters)) { $b59aeb=$parameters['*tags']; } if (!$b59aeb[0]) return e2_error404_mode(); $od7df5=$b59aeb[0]; $w7186e=$parameters['tag-alias']; if(count($b59aeb)==1){ $_current_tag=$od7df5['Keyword']; } $e71860=$parameters['page']; $vc2b7b=$_config['db_table_prefix']; $sd7e5d=$settings['appearance']['notes_per_page']; foreach ($b59aeb as $l9e366) if ($l9e366){ $k56790[] = "`". $vc2b7b."NotesKeywords`.KeywordID=". $l9e366['ID']; } $k56790=implode(' OR ',$k56790); $kf79b1='AND `IsVisible`=1'; if (ve852())$kf79b1=''; $t76595=( "COUNT(*) as KeywordsCount ". "FROM `". $vc2b7b."Notes` ". "INNER JOIN `". $vc2b7b."NotesKeywords` ". "ON `". $vc2b7b."NotesKeywords`.NoteID=`". $vc2b7b."Notes`.ID ". "WHERE `IsPublished`=1 AND (". $k56790 .") ". $kf79b1 ." ". "GROUP BY `". $vc2b7b."Notes`.`ID` ". "HAVING KeywordsCount=". count($b59aeb) ); $vd3890=( "SELECT DISTINCT `". $vc2b7b."Notes`.*, ". $t76595 ." ". "ORDER BY `". $vc2b7b."Notes`.`Stamp` DESC ". "LIMIT ". ($e71860-1)*$sd7e5d .", ". $sd7e5d ); $z1b037=( "SELECT DISTINCT `". $vc2b7b."Notes`.ID, ". $t76595 ); $ab3b32=array(); if (o0738($z1b037)) { $result=r0d6b(); $ffbb44=count($result); $kae0fe=ceil($ffbb44/$sd7e5d); $ab3b32['timeline?']=true; $ab3b32['count']=$kae0fe; $ab3b32['this']=$e71860; $ab3b32['earlier-title']=$_strings['gs--earlier']; $ab3b32['later-title']=$_strings['gs--later']; $k920fa=$parameters; if ($e71860 < $kae0fe){ $k920fa['page']=$e71860+1; $ab3b32['earlier-href']=y83c8('e2m_tag',$k920fa); } if ($e71860 > 1){ $k920fa['page']=$e71860-1; $ab3b32['later-href']=y83c8('e2m_tag',$k920fa); } } if ($ffbb44==0 and !ve852()) { return e2_error404_mode(); } if (o0738($vd3890)) { $result=r0d6b(); foreach($result as $c8ce4b => $uaad65){ $uaad65['_']['_id']=$uaad65['ID']; $uaad65['_']['_ord']=k; $uaad65['_']['_ord_max']=count($result)-1; $o4358b[] = j6791($uaad65); } if(count($result)==0){ if ($e71860!=1) return e2_error404_mode(); } } if(count($b59aeb)==1){ if (ve852()) { $s97a59['edit-href']=y83c8( 'e2m_tag_edit', array ('tag-alias' => $w7186e) ); } if (''!=$od7df5['Description']) { $m2bfe4=pb7f1($od7df5['Description'],'full'); $c67daf=$m2bfe4['text-final']; $s97a59['description']=$c67daf; $s97a59['description-format-info']=$m2bfe4['meta']; } $q3ad42=y83c8('e2m_tag_rss', array ('tag-alias' => $w7186e)); $s9d19f=y83c8('e2m_tag_json', array ('tag-alias' => $w7186e)); f3010( 'rss', s6f51() .': '. $od7df5['Keyword'], $q3ad42 ); f3010( 'json', s6f51() .': '. $od7df5['Keyword'], $s9d19f ); $s97a59['og-images']=kdbcc( 'tag',$od7df5['ID'], $s97a59['description-format-info']['resources-detected'] ); } $u96963=( e2l_get_string('pt--n-posts', array ('number' => $ffbb44)). ' '. $_strings['gs--tagged'] ); $kf74f5=array(); foreach ($b59aeb as $l9e366){ $kf74f5[] = $l9e366['Keyword']; } $kf74f5=implode(', ',$kf74f5); $i2cb9d=array ( 'title' => s6f51() .': '. $kf74f5, 'superheading' => $u96963, 'heading' => $kf74f5, 'pages' => $ab3b32, 'notes' => $o4358b, ); if ($c67daf){ $i2cb9d['summary']=u5421($c67daf); } if(count($b59aeb)==1){ $i2cb9d['tag']=$s97a59; if (ve852()) { $i2cb9d['related-edit-href']=$s97a59['edit-href']; $i2cb9d['related-edit-title']=$_strings['tt--edit-tag']; } } if(__LOG)__log('} // Tag'); return $i2cb9d; } function e2m_tag_edit($parameters=array()) { global$_strings; if(array_key_exists('*tag',$parameters)) { $od7df5=$parameters['*tag']; } if (!$od7df5) return e2_error404_mode(); $re449c=yc0c4( 'neasden',$od7df5['Description'],'full' ); $b75e1b=gf898( 'tag',$od7df5['ID'],$re449c ); n2f83( 'Keywords', $od7df5, $re449c ); $xc999b=cd10e(); $xcd831=array ( '.tag-id' => $od7df5['ID'], '.formatter-id' => 'neasden', 'form-action' => y83c8('e2s_tag_edit'), 'form-file-upload-action' => y83c8('e2j_file_upload'), 'form-file-remove-action' => y83c8('e2j_file_remove'), 'submit-text' => $_strings['fb--save-changes'], 'tag' => htmlspecialchars($od7df5['Keyword'],ENT_COMPAT,HSC_ENC), 'urlname' => htmlspecialchars($parameters['tag-alias'],ENT_COMPAT,HSC_ENC), 'description' => htmlspecialchars($od7df5['Description'],ENT_COMPAT,HSC_ENC), 'uploads' => $b75e1b, 'uploads-enabled?' => r1363($xc999b), 'favourite?' => (bool)$od7df5['IsFavourite'], 'space-usage' => vaf64($xc999b), ); $xcd831['.cache-sensitive-hash']=md5( $xcd831['tag'] . $xcd831['urlname'] ); $i2cb9d=array ( 'title' => $_strings['pt--tag-edit'] .': '. $od7df5['Keyword'], 'heading' => $_strings['pt--tag-edit'], 'form' => 'form-tag', 'form-tag' => $xcd831, 'related-delete-href' => y83c8('e2m_tag_delete', array ('*tag' => $od7df5)), ); return $i2cb9d; } function e2m_tag_flag_ajax($parameters){ if (y2e88($parameters)) { $m67142=$parameters; $m67142['value'] = !$parameters['value']; if($parameters['value']==1){ $t99859=y83c8('e2m_tag_flag_ajax',$m67142); $h1fa03='on-rehref|'. $t99859; } else { $t99859=y83c8('e2m_tag_flag_ajax',$m67142); $h1fa03='off-rehref|'. $t99859; } } else { $h1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($h1fa03); } else { e2_go_to(y83c8('e2m_tag',$parameters)); die; } } function y2e88($parameters){ if(array_key_exists('*tag',$parameters)) { $od7df5=$parameters['*tag']; } if (!$od7df5) return e2_error404_mode(); @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $result=eaa79('Keywords', array ( 'ID' => $od7df5['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); return$result; } function e2m_tag_delete($parameters=array()) { global$_strings; if(array_key_exists('*tag',$parameters)) { $od7df5=$parameters['*tag']; } if (!$od7df5) return e2_error404_mode(); $becc14=array ( '.tag-id' => $od7df5['ID'], 'caution-text' => e2l_get_string('gs--tag-will-be-deleted-notes-remain', array ( 'tag' => htmlspecialchars($od7df5['Keyword'],ENT_COMPAT,HSC_ENC) )), 'tag' => htmlspecialchars($od7df5['Keyword'],ENT_COMPAT,HSC_ENC), 'form-action' => y83c8('e2s_tag_delete'), 'submit-text' => $_strings['fb--delete'], ); $i2cb9d=array ( 'title' => $_strings['pt--tag-delete'] .': '. $od7df5['Keyword'], 'heading' => $_strings['pt--tag-delete'], 'form' => 'form-tag-delete', 'form-tag-delete' => $becc14, ); return $i2cb9d; } function e2m_untagged(){ global$_strings,$_config; $kf79b1='AND `IsVisible`=1'; if (ve852())$kf79b1=''; return dd864(array ( 'query' => "SELECT n.* FROM `". $_config['db_table_prefix']."Notes` n ". "LEFT OUTER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.NoteID = n.ID ". "WHERE `IsPublished`=1 AND nk.KeywordID IS NULL ".$kf79b1." ". "ORDER BY n.Stamp DESC", 'title' => $_strings['pt--posts-without-tags'], 'heading' => $_strings['pt--posts-without-tags'], 'nothing' => $_strings['gs--no-posts-without-tags'], 'show-all-notes' => true, )); } function e2s_tag_edit(){ global$_strings,$_config; $i76f09=$oe4d23=$c67daf=$la7ff0=''; if(array_key_exists('tag-id',$_POST)) $i76f09=$_POST['tag-id']; if(array_key_exists('tag',$_POST)) $oe4d23=$_POST['tag']; if(array_key_exists('description',$_POST)) $c67daf=trim($_POST['description'],"\r\n"); if(array_key_exists('urlname',$_POST)) $la7ff0=trim($_POST['urlname'],"\r\n"); if(array_key_exists('cache-sensitive-hash',$_POST)) { $d3c58b=$_POST['cache-sensitive-hash']; $ybb9a8=md5($oe4d23.$la7ff0); } $oe4d23=rff7c($oe4d23); $c67daf=rff7c($c67daf); if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE ID = ".((int)$i76f09)."" )) { $v53e61=r0d6b(); if(count($v53e61)!=1) die; $pb19ad=$v53e61[0]; } if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE Keyword = '". u7928($oe4d23) ."' ". "AND (ID != ".((int)$i76f09).")" )) { $v53e61=r0d6b(); if(count($v53e61)==0){ if ($ybb9a8!=$d3c58b){ r7996(); } @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $pb19ad['ID'] = ((int)$i76f09); $pb19ad['Keyword']=$oe4d23; $pb19ad['Description']=$c67daf; if (eaa79('Keywords',$pb19ad)) { $q17901=dd712( 'set',ENTITY_TYPE_TAG,$pb19ad['ID'],$la7ff0 ); e2_go_to(y83c8('e2m_tag', array ('tag-alias' => $q17901))); } else { v4930(); } } else { y8a40($_strings['er--cannot-rename-tag'],E2E_USER_ERROR); v4930(); } } else { v4930(); } die; } function e2s_tag_delete(){ global$_strings,$_config; $xb80bb=((int)$_POST['tag-id']); r7996(); @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $z444bc=( o0738( "DELETE FROM `". $_config['db_table_prefix']."Keywords` WHERE `ID`=". $xb80bb ) and o0738( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` WHERE `KeywordID`=". $xb80bb ) ); if ($z444bc){ e2_go_to(y83c8('e2m_tags')); die; } else { v4930(); die; } } function naf16($t07f25){ global$_current_tag,$_config; $b9df9d=null; if(CACHE_FAVTAGS and is_file(CACHE_FILENAME_FAVTAGS)) { $b9df9d=@unserialize(file_get_contents(CACHE_FILENAME_FAVTAGS)); } if (!is_array($b9df9d)) { o0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE IsFavourite = 1 ORDER BY `Keyword`" ); $p9cdff=r0d6b(); $b9df9d=array(); foreach ($p9cdff as $b04ff0){ $sc6827['tag']=htmlspecialchars($b04ff0['Keyword'],ENT_NOQUOTES,HSC_ENC); $sc6827['href']=y83c8( 'e2m_tag', array ('*tag' => $b04ff0) ); $b9df9d[] = $sc6827; } if(CACHE_FAVTAGS)t6e52(CACHE_FILENAME_FAVTAGS,serialize($b9df9d)); } $j8a4f1=false; foreach ($b9df9d as $c8ce4b => $l9e366){ $b9df9d[$c8ce4b]['current?'] = ( $b9df9d[$c8ce4b]['tag']==$_current_tag ); if ($b9df9d[$c8ce4b]['current?']) { $j8a4f1=true; $t08187=$t07f25; $t08187['flag']='IsFavourite'; $t08187['value']=0; if (ve852()) { $b9df9d[$c8ce4b]['pinnable?']=true; $b9df9d[$c8ce4b]['pinned?']=true; $b9df9d[$c8ce4b]['pinned-toggle-href'] = ( y83c8('e2m_tag_flag_ajax',$t08187) ); } } } if (ve852()) { if (!$j8a4f1 and array_key_exists('*tag',$t07f25)) { $wa55a9=$t07f25; $wa55a9['flag']='IsFavourite'; $wa55a9['value']=1; $kd5a7a=array ( 'tag' => htmlspecialchars($t07f25['*tag']['Keyword'],ENT_NOQUOTES,HSC_ENC), 'href' => y83c8('e2m_tag',$t07f25), 'current?' => true, 'pinnable?' => true, 'pinned?' => false, 'pinned-toggle-href' => y83c8('e2m_tag_flag_ajax',$wa55a9), ); $b9df9d[] = $kd5a7a; } } return $b9df9d; } function nce23($y21158,$parameters=''){ global$_config; $k0dff3=array(); if (o0738( "SELECT `". $_config['db_table_prefix']."Keywords`.* ". "FROM `". $_config['db_table_prefix']."Keywords`, ". "`". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `". $_config['db_table_prefix']."NotesKeywords`.NoteID=". ((int)$y21158) ." ". "AND `". $_config['db_table_prefix']."Keywords`.ID=`". $_config['db_table_prefix']."NotesKeywords`.KeywordID ". "ORDER BY `Keyword`" )) { $k0dff3=r0d6b(); } return $k0dff3; } function v53f1($leaa60){ global$_config; $q316e8=array(); foreach (array ( 'ID', 'NoteID', 'KeywordID', ) as $y06e3d) if(array_key_exists($y06e3d,$leaa60)) { $o6a7f2[] = '`'. $y06e3d .'`'."='". u7928($leaa60[$y06e3d]) ."'"; if ($y06e3d=='ID')$i729d6='tagbinging-id'; if ($y06e3d=='NoteID')$i729d6='tagbinging-note-id'; if ($y06e3d=='KeywordID')$i729d6='tagbinging-tag-id'; $q316e8[$i729d6]=$leaa60[$y06e3d]; } $q1b1cc=( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE ". implode(' AND ',$o6a7f2) ); if (o0738($q1b1cc)) { return true; } } function ycbd4($leaa60){ global$_config; if (!array_key_exists('ID',$leaa60) or !is_numeric($leaa60['ID'])) { die ('API MISUSE: e2q_update_tagbinding must be called with an ID field in $tagbinding_record'); } $o6a7f2=array(); foreach (array ( 'NoteID', 'KeywordID', ) as $y06e3d) if(array_key_exists($y06e3d,$leaa60)) { $o6a7f2[] = '`'. $y06e3d .'`'."='". u7928($leaa60[$y06e3d]) ."'"; } if(count($o6a7f2) > 0){ $q1b1cc = "UPDATE `". $_config['db_table_prefix']."NotesKeywords` ". "SET ". implode(', ',$o6a7f2) ." ". "WHERE `ID`=". $leaa60['ID']; if (o0738($q1b1cc)) { return true; } } } function z03de($oe4d23){ @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $pb19ad=array ( 'Keyword' => $oe4d23, 'OriginalAlias' => dd712('find',ENTITY_TYPE_UNSPECIFIED,'',$oe4d23), 'Description' => '', ); if (($pb19ad=m9943('Keywords',$pb19ad)) !== false){ $y419a1=dd712( 'set',ENTITY_TYPE_TAG,$pb19ad['ID'],$oe4d23 ); if ($y419a1!=$pb19ad['OriginalAlias']) { $pb19ad['OriginalAlias']=$y419a1; eaa79('Keywords',$pb19ad); } return $pb19ad['ID']; } } function q5d57(){ global$_config; $c1c0b7=ve852(); $xd29bb=CACHE_FILENAME_TAGS; if ($c1c0b7)$xd29bb=CACHE_FILENAME_TAGS_AUTHOR; $s8da94=null; if(CACHE_TAGS and is_file($xd29bb)) { $s8da94=@unserialize(file_get_contents($xd29bb)); } if (!is_array($s8da94)) { o0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "ORDER BY `Keyword`" ); $y35016=array(); foreach (r0d6b() as $pb19ad){ $oe4d23['tag']=htmlspecialchars($pb19ad['Keyword'],ENT_NOQUOTES,HSC_ENC); $oe4d23['href']=y83c8('e2m_tag', array ('*tag' => $pb19ad)); $oe4d23['favourite?'] = (bool)$pb19ad['IsFavourite']; $oe4d23['notes-count']=0; $oe4d23['last-used']=0; $oe4d23['freshness']=0; $oe4d23['weight']=0; $y35016[$pb19ad['ID']] = $oe4d23; } o0738( "SELECT nk.KeywordID, COUNT(DISTINCT n.ID) as Count, max(n.Stamp) as LastUsed ". "FROM `". $_config['db_table_prefix']."NotesKeywords` nk, ". "`". $_config['db_table_prefix']."Notes` n ". "WHERE nk.NoteID = n.ID AND n.IsPublished ". ($c1c0b7? "":"AND n.IsVisible=1 "). "GROUP BY nk.KeywordID" ); $v9fdd5=0; $d8f57c=0; $e06894=0; foreach (r0d6b() as $w28a42){ $sc6827 =& $y35016[$w28a42['KeywordID']]; $sc6827['notes-count']=$w28a42['Count']; if (@$sc6827['last-used'] < $w28a42['LastUsed']) { $sc6827['last-used']=$w28a42['LastUsed']; $l452b4=(time()-$sc6827['last-used']) / SECONDS_IN_A_YEAR; $sc6827['freshness']=pow(1/2,$l452b4); } $v9fdd5=max($v9fdd5,$sc6827['notes-count']); $d8f57c=max($d8f57c,$sc6827['freshness']); $e06894=max($e06894,$sc6827['notes-count']*$sc6827['freshness']); } $s8da94=array(); foreach ($y35016 as $q865c0 => $l9e366){ if (!$c1c0b7 and $l9e366['notes-count']==0) continue; $c95e80=mb_strtolower($l9e366['tag']); $s8da94[$c95e80]=$l9e366; if ($d8f57c!=0){ $s8da94[$c95e80]['freshness']=$l9e366['freshness']/$d8f57c; } else { $s8da94[$c95e80]['freshness']=0; } if ($e06894!=0){ $s8da94[$c95e80]['weight'] = ( $l9e366['freshness']*$l9e366['notes-count']/$e06894 ); } else { $s8da94[$c95e80]['weight']=0; } if ($s8da94[$c95e80]['favourite?'])$s8da94[$c95e80]['weight']=1; } if(CACHE_TAGS)t6e52($xd29bb,serialize($s8da94)); } return $s8da94; } function ta463($y21158,$hda3ad='Keyword'){ global$_config; if (o0738( "SELECT `". $_config['db_table_prefix']."Keywords`.* ". "FROM `". $_config['db_table_prefix']."Keywords`, ". "`". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `". $_config['db_table_prefix']."NotesKeywords`.NoteID=".((int)$y21158)." AND ". "`". $_config['db_table_prefix']."Keywords`.ID=". "`". $_config['db_table_prefix']."NotesKeywords`.KeywordID ". "ORDER BY `".$hda3ad."`" ))$wfa816=r0d6b(); else $wfa816=array(); $b59aeb=array(); foreach ($wfa816 as $ye358e)$b59aeb[] = $ye358e; return $b59aeb; } function m0188($od7df5){ global$_config; if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `Keyword`='".u7928($od7df5)."'" )) { $c8ce4b=r0d6b(); if (isset ($c8ce4b[0])) return $c8ce4b[0]; } return null; } function h8770($bd7ca3){ global$_config; if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `OriginalAlias`='".u7928($bd7ca3)."'" )) $wfa816=r0d6b(); else $wfa816=array(); if (isset ($wfa816[0])) return $wfa816[0]; else return FALSE; } function v4e28($xb80bb){ global$_config; if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `ID`='".((int)$xb80bb)."'" )) { $c8ce4b=r0d6b(); if (isset ($c8ce4b[0])) { $c8ce4b=$c8ce4b[0]; return $c8ce4b; } else { return NULL; } } return NULL; } function e2_tagrecs_with_parameters_($parameters){ $vbdcf3=array(); if (@$parameters['tag-alias']) { $vbdcf3=explode(',',$parameters['tag-alias']); } $k0dff3=array(); foreach ($vbdcf3 as $bd7ca3) if ($bd7ca3){ if ( $gc45dd=e2_aliasrec_of_alias_(@$bd7ca3) and ($gc45dd['EntityType']==ENTITY_TYPE_TAG) ) { $k0dff3[] = v4e28($gc45dd['EntityID']); } else { if ($w3ee3f=h8770($bd7ca3)) { $k0dff3[] = $w3ee3f; } } } return $k0dff3; } function e2m_comment($parameters=array ()) { e2_go_to(y83c8('e2m_note',$parameters)); die; } function e2m_comment_edit($parameters=array ()) { return c4fb7('edit',$parameters); } function e2m_note_comment($parameters=array ()) { return c4fb7('write',$parameters); } function c4fb7($i60cd8,$parameters=array ()) { global$_config,$_strings,$full_blog_url; $td5d3d=$kf74f5=$_strings['pt--new-comment']; $l69b97='new'; if ($i60cd8=='edit'){ $s4032b=e2_commentrec_with_parameters_($parameters); $mc50d0=$_strings['fb--save-changes']; $f39a37=$s4032b['noterec']; $td5d3d=$kf74f5=$_strings['pt--edit-comment']; $l69b97=$waca8d['ID']; if (!$s4032b){ return e2_error404_mode(); } $g80f02=array ( '.note-id' => $s4032b['NoteID'], '.comment-id' => $s4032b['ID'], '.already-subscribed?' => false, '.from' => substr($_SERVER['HTTP_REFERER'],strlen($full_blog_url)+1), 'create:edit?' => false, 'form-action' => y83c8('e2s_comment_process'), 'submit-text' => $mc50d0, 'show-subscribe?' => true, 'subscribe?' => (bool)$s4032b['IsSubscriber'], 'name' => htmlspecialchars($s4032b['AuthorName'],ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($s4032b['AuthorEmail'],ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($s4032b['Text'],ENT_COMPAT,HSC_ENC), 'email-field-name' => 'elton-john', ); if (''!=trim($s4032b['IP'])) { $g80f02['ip']=$s4032b['IP']; $g80f02['ip-href']=$_config['whois_service'].$g80f02['ip']; } } else { $f39a37=$parameters['*note']; $g80f02=u66aa($f39a37); } return array ( 'title' => $td5d3d, 'heading' => $kf74f5, 'form' => 'form-comment', 'form-comment' => $g80f02, ); } function e2m_comment_reply($parameters=array ()) { global$_strings; $s4032b=e2_commentrec_with_parameters_($parameters); if (!$s4032b){ return e2_error404_mode(); } $f39a37=$s4032b['noterec']; $n1aec6=s86f8($f39a37,$s4032b,$parameters['comment-number']); $n1aec6['_']['_id']=$s4032b['ID']; $n1aec6['_']['_ord']=0; $n1aec6['_']['_ord_max']=0; $n1aec6['replying?'] = (bool)true; $c817c7=($s4032b['Reply']=='' or !$s4032b['IsReplyVisible']); $td5d3d=$c817c7? $_strings['pt--reply-to-comment']:$_strings['pt--edit-reply-to-comment']; $f4dc70=array ( '.note-id' => $f39a37['ID'], '.comment-id' => $s4032b['ID'], '.reply-action' => $c817c7? 'new':'edit', 'form-action' => y83c8('e2s_comment_edit_reply'), 'submit-text' => $c817c7? $_strings['fb--publish']:$_strings['fb--save-changes'], 'create:edit?' => (bool) ($c817c7), 'reply-text' => htmlspecialchars($s4032b['Reply'],ENT_COMPAT,HSC_ENC), 'mail-back?' => (bool) ($c817c7), ); return array ( 'title' => $td5d3d, 'heading' => $td5d3d, 'comments' => array ('only' => $n1aec6), 'form' => 'form-comment-reply', 'form-comment-reply' => $f4dc70, ); } function e2m_comment_delete($parameters=array ()) { global$_strings,$settings,$wcbcce,$_config; $s4032b=e2_commentrec_with_parameters_($parameters); $y21158=$s4032b['NoteID']; if (!$s4032b){ return e2_error404_mode(); } e2_drop_caches_for_note_($y21158); @unlink(USER_FOLDER. '/last-comment.psa'); o0738( "DELETE FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `ID` = '".((int)$s4032b['ID'])."'" ); v4930(); die; } function e2m_comment_reply_delete($parameters=array ()) { global$_strings,$settings,$_config; $s4032b=e2_commentrec_with_parameters_($parameters); if (!$s4032b){ return e2_error404_mode(); } o0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='', ". "`IsReplyFavourite`='0' ". "WHERE `ID`=".((int)$s4032b['ID']) ); v4930(); die; } function e2m_unsubscribe($parameters){ global$_strings,$_config; $k70a17="ORDER BY `ID` DESC"; $f39a37=$parameters['*note']; $y21158=$f39a37['ID']; $c0c83f=$parameters['unsubscribe-email']; $q1bc29=$parameters['unsubscribe-key']; $c0c83f=str_replace(' ','+',$c0c83f); if ($y21158){ if (o0738( "SELECT `ID`, `Stamp` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". $y21158 ." AND `IsSubscriber`=1 AND `AuthorEmail`='". $c0c83f ."' ". $k70a17 )) { $result=r0d6b(); if(count($result) < 1) { $i2cb9d['unsubscribe']['success?']=false; $i2cb9d['unsubscribe']['error-message']=$_strings['gs--you-are-not-subscribed']; } else { $o06d4c=@$result[0]; $p97f69=md5($o06d4c['ID'].$o06d4c['Stamp'] .'x'); $s260ca=false; if ($q1bc29==$p97f69){ if (o0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET `IsSubscriber`=0 ". "WHERE `NoteID`=". $y21158 ." AND `AuthorEmail` = '".u7928($c0c83f)."'" )) { $s260ca=true; $i2cb9d['unsubscribe']['success?']=true; $i2cb9d['unsubscribe']['note-title']=g6f10( htmlspecialchars($f39a37['Title'],ENT_COMPAT,HSC_ENC) ); $i2cb9d['unsubscribe']['note-href']=y83c8( 'e2m_note', array ('*note' => $f39a37) ); } } if (!$s260ca){ $i2cb9d['unsubscribe']['success?']=false; $i2cb9d['unsubscribe']['error-message']=$_strings['gs--unsubscription-didnt-work']; } } } else { $i2cb9d['unsubscribe']['success?']=false; $i2cb9d['unsubscribe']['error-message']=$_strings['gs--comment-not-found']; } } else { $i2cb9d['unsubscribe']['success?']=false; $i2cb9d['unsubscribe']['error-message']=$_strings['gs--post-not-found']; } return $i2cb9d; } function e2m_comment_flag($parameters){ v6e30($parameters); e2_go_to(y83c8('e2m_note',$parameters)); die; } function e2m_comment_flag_ajax($parameters){ if (v6e30($parameters)) { $m67142=$parameters; $m67142['value'] = !$parameters['value']; if($parameters['value']==1){ $t99859=y83c8('e2m_comment_flag_ajax',$m67142); $h1fa03='on-rehref|'. $t99859; } else { $t99859=y83c8('e2m_comment_flag_ajax',$m67142); $h1fa03='off-rehref|'. $t99859; } } else { $h1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($h1fa03); } else { e2_go_to(y83c8('e2m_note',$parameters)); die; } } function v6e30($parameters){ $s4032b=e2_commentrec_with_parameters_($parameters); $y21158=$s4032b['NoteID']; $result=false; if ($s4032b){ $result=eaa79('Comments', array ( 'ID' => $s4032b['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); e2_drop_caches_for_note_($y21158); } return$result; } function e2s_comment_process(){ global$_strings,$_fp_error; list ($y21158,$l69b97,$i9d090)=x1a90(); if(__LOG)__log('Comments: processed, noteid <'. $y21158 .'>, commentid <'. $l69b97 .'>'); if (!$l69b97){ $y05c36=''; if($_fp_error==FP_NOT_COMMENTABLE){ y8a40($_strings['er--post-not-commentable'],E2E_USER_ERROR); } elseif($_fp_error==FP_EMPTY_FIELD){ y8a40($_strings['er--name-email-text-required'],E2E_USER_ERROR); } elseif($_fp_error==FP_COMMENT_TOO_LONG){ $oaa731=$_strings['gs--comment-too-long']; $y05c36=$_strings['gs--comment-too-long-description']; } elseif($_fp_error==FP_COMMENT_DOUBLE_POST){ $oaa731=$_strings['gs--comment-double-post']; $y05c36=$_strings['gs--comment-double-post-description']; } elseif($_fp_error==FP_COMMENT_SPAM_SUSPECT){ $oaa731=$_strings['gs--comment-spam-suspect']; $y05c36=$_strings['gs--comment-spam-suspect-description']; } else { y8a40($_strings['er--error-occurred'].' ('. $_fp_error .')'); } if ($y05c36){ $i2cb9d['title']=$oaa731; $i2cb9d['heading']=$oaa731; $i2cb9d['form']='form-unaccepted-comment'; $i2cb9d['form-unaccepted-comment'] = array ( 'reason' => $y05c36, 'text' => @htmlspecialchars($i9d090['text'],ENT_COMPAT,HSC_ENC), ); return $i2cb9d; } } if ($y21158){ e2_go_to(y83c8('e2m_note', array ('*note' => j4627($y21158)))); } else { e2_go_to(); } die; } function e2s_comment_edit_reply(){ global$_strings,$x57de2,$_config; $ve84af=@$_POST['text']; if(trim($ve84af)=='')$ve84af=''; $y21158=@$_POST['note-id']; $uaad65=j4627($y21158); $l69b97=@$_POST['comment-id']; $o06d4c=ub559($l69b97); $o54eb6=isset ($_POST['mail-back']); $u54fa9=time(); if (@$_POST['reply-action']=='new'){ $ne0e30=time(); } @unlink(e2_note_cache_filename_with_id_($y21158 .'-comments')); @unlink(e2_note_cache_filename_with_id_($y21158 .'-comments-author')); if ($o06d4c and o0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='". u7928($ve84af) ."', ". ( isset ($ne0e30)? ( "`ReplyStamp`='". $ne0e30 ."', " ) : ( "" ) ). "`ReplyLastModified`='". $u54fa9 ."', ". "`IsReplyVisible`='1' ". "WHERE `ID`=".((int)$l69b97) )) { $od58c0=y83c8('e2m_note', array ('*note' => $uaad65)); if ($o54eb6 and $ve84af!=''){ $sc6827['comment-time'] = array ($o06d4c['Stamp'],s5c05()); $sc6827['commenter']=$o06d4c['AuthorName']; $sc6827['commenter-email']=$o06d4c['AuthorEmail']; $sc6827['comment-text']=$o06d4c['Text']; $sc6827['note-title']=g6f10($uaad65['Title']); $sc6827['reply-time'] = array (time(),s5c05()); $sc6827['blog-author']=z2640(); $sc6827['note-href']=$od58c0; $sc6827['comment-href']=$od58c0; $sc6827['reply-text']=$ve84af; if(1){ $zde7a3=u3e5c( 'comment-reply',$sc6827 ); $ub904c=e2l_get_string( 'em--comment-reply', $sc6827 ); $y77613=$o06d4c['AuthorEmail']; $e1a49b='From: '. oaed2(); aa41b($y77613,$ub904c,$zde7a3,$e1a49b); } if(1){ unset ($sc6827['commenter-email']); $e1a49b='From: '. oaed2(); foreach (d4975($uaad65,$o06d4c['AuthorEmail']) as $w39c63){ $rba570=$w39c63['AuthorEmail']; $e6fd85=md5($w39c63['ID'].$w39c63['Stamp'].'x'); $sc6827['unsubscribe-href']=y83c8('e2m_unsubscribe', array ( '*note' => $uaad65, 'unsubscribe-email' => $rba570, 'unsubscribe-key' => $e6fd85, ) ); $y77613=$rba570; $zde7a3=u3e5c('comment-reply-to-public',$sc6827); $ub904c=e2l_get_string( 'em--comment-reply-to-public-subject', $sc6827 ); aa41b($y77613,$ub904c,$zde7a3,$e1a49b); } } } e2_go_to($od58c0); } else { v4930(); } die; } function s86f8($uaad65,$o06d4c,$zb1bc2=false){ global$_config; if(__LOG)__log('Comments: package comment <'. $o06d4c['ID'] .'>...'); if ($uaad65===null){ $uaad65=j4627($o06d4c['NoteID']); } if ($zb1bc2!==false)$sc6827['number']=$zb1bc2; $sc6827['name']=htmlspecialchars($o06d4c['AuthorName'],ENT_NOQUOTES,HSC_ENC); if (ve852()) { $sc6827['email']=htmlspecialchars($o06d4c['AuthorEmail'],ENT_NOQUOTES,HSC_ENC); if (''!=trim($o06d4c['IP'])) { $sc6827['ip']=$o06d4c['IP']; $sc6827['ip-href']=$_config['whois_service'].$sc6827['ip']; } } $sc6827['author-name']=z2640(); $sc6827['visible?'] = (bool)$o06d4c['IsVisible']; $sc6827['important?'] = (bool)$o06d4c['IsFavourite']; $sc6827['reply-visible?'] = (bool) ($o06d4c['IsVisible'] && $o06d4c['IsReplyVisible']); $sc6827['reply-important?'] = (bool)$o06d4c['IsReplyFavourite']; $sc6827['spam-suspect?'] = (bool)$o06d4c['IsSpamSuspect']; $b10a7e=array ((int)$o06d4c['Stamp'],y0923($uaad65)); $sc6827['time']=$b10a7e; $sc6827['last-modified']=$b10a7e; if ($o06d4c['LastModified']) $sc6827['last-modified'] = array ((int)$o06d4c['LastModified'],y0923($uaad65)); if ($o06d4c['ReplyStamp']) $sc6827['reply-time'] = array ((int)$o06d4c['ReplyStamp'],y0923($uaad65)); if ($o06d4c['ReplyLastModified']) $sc6827['reply-last-modified'] = array ((int)$o06d4c['ReplyLastModified'],y0923($uaad65)); if (ve852()) { $sc6827['subscriber?'] = (bool)$o06d4c['IsSubscriber']; $sc6827['new?'] = (bool)$o06d4c['IsNew']; $sc6827['first-new?']=false; if ($o06d4c['IsFavourite']) { $sc6827['important-toggle-href']=y83c8( 'e2m_comment_flag_ajax', array ('*note' => $uaad65,'comment-number' => $zb1bc2,'flag' => 'IsFavourite','value' => 0) ); } else { $sc6827['important-toggle-href']=y83c8( 'e2m_comment_flag_ajax', array ('*note' => $uaad65,'comment-number' => $zb1bc2,'flag' => 'IsFavourite','value' => 1) ); } if ($o06d4c['IsReplyFavourite']) { $sc6827['reply-important-toggle-href']=y83c8( 'e2m_comment_flag_ajax', array ( '*note' => $uaad65,'comment-number' => $zb1bc2,'flag' => 'IsReplyFavourite','value' => 0 ) ); } else { $sc6827['reply-important-toggle-href']=y83c8( 'e2m_comment_flag_ajax', array ( '*note' => $uaad65,'comment-number' => $zb1bc2,'flag' => 'IsReplyFavourite','value' => 1 ) ); } $sc6827['edit-href']=y83c8( 'e2m_comment_edit', array ('*note' => $uaad65,'comment-number' => $zb1bc2) ); $sc6827['removed-toggle-href']=y83c8( 'e2m_comment_flag_ajax', array ( '*note' => $uaad65,'comment-number' => $zb1bc2, 'flag' => 'IsVisible','value' => !$o06d4c['IsVisible'] ) ); $sc6827['removed-reply-toggle-href']=y83c8( 'e2m_comment_flag_ajax', array ( '*note' => $uaad65,'comment-number' => $zb1bc2, 'flag' => 'IsReplyVisible','value' => !$o06d4c['IsReplyVisible'] ) ); $ce36ef=y83c8( 'e2m_comment_reply', array ('*note' => $uaad65,'comment-number' => $zb1bc2) ); if ($o06d4c['Reply']=='' or !$o06d4c['IsReplyVisible']) { $sc6827['reply-href']=$ce36ef; } else { $sc6827['edit-reply-href']=$ce36ef; } } if(mb_strlen($o06d4c['Text']) > $_config['max_comment_length']) { $o06d4c['Text']=mb_substr($o06d4c['Text'],0,$_config['max_comment_length']); } $m2bfe4=a154e($uaad65['FormatterID'],$o06d4c['Text'],'simple'); $sc6827['text']=$m2bfe4['text-final']; $sc6827['replying?'] = (bool)false; $sc6827['replied?'] = (bool) ( (trim($o06d4c['Reply']) != '') && ($o06d4c['IsReplyVisible']) ); $m2bfe4=a154e($uaad65['FormatterID'],$o06d4c['Reply'],'full'); $sc6827['reply']=$m2bfe4['text-final']; if(array_key_exists('_',$o06d4c))$sc6827['_']=$o06d4c['_']; if(__LOG)__log('Comments: done'); return $sc6827; } function ub559($xb80bb){ global$_config; if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `ID` = '".$xb80bb."'" )) { $wfa816=r0d6b(); if(count($wfa816) > 0) return $wfa816[0]; } return false; } function ne5b6($d0604c){ e2_comment_set_flag('IsVisible',$d0604c); } function m3183($v0dd2c){ e2_comment_set_flag('IsReplyVisible',$v0dd2c); } function u66aa($bea59a){ global$_strings; $le3cb9=@$_COOKIE[e8c3b('commenter_name')]; $if92ee=@$_COOKIE[e8c3b('commenter_email')]; $l3d682=@$_COOKIE[e8c3b('commenter_ph')]; $l92399=false; if ($if92ee and cookie_unsubscribe_key){ foreach (d4975($bea59a) as $w39c63){ $p97f69=md5($w39c63['ID'].$w39c63['Stamp'] .'x'); if ( $w39c63['AuthorEmail']==$if92ee and $l3d682==$p97f69 ){ $l92399=true; break; } } } $mc50d0=$_strings['fb--submit']; $g80f02=array ( '.note-id' => $bea59a['ID'], '.comment-id' => 'new', '.already-subscribed?' => (bool)$l92399, 'create:edit?' => true, 'form-action' => y83c8('e2s_comment_process'), 'submit-text' => $mc50d0, 'show-subscribe?' => (bool) !$l92399, 'subscribe?' => (bool)$l92399, 'subscription-status' => $l92399? $_strings['gs--you-are-already-subscribed']:'', 'visible?' => true, 'email-field-name' => 'elton-john', 'nospam-field-name' => 'first-name', 'name' => htmlspecialchars($le3cb9,ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($if92ee,ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($o06d4c['Text'],ENT_COMPAT,HSC_ENC), ); return $g80f02; } function p254f($y21158,$hdaf19=0){ global$_config; if (!$hdaf19)$kf79b1=' AND `IsVisible`=1'; if ('all'===$hdaf19){ $kf79b1=''; } if ('new'===$hdaf19){ $kf79b1=' AND `IsNew`=1'; } $obc751=0; if (o0738( "SELECT count(*) FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". @$y21158 . @$kf79b1 )) { $result=r0d6b(); $result=(int)$result[0]['count(*)']; $obc751=$result; } return (int)$obc751; } function e2a6b(){ global$_config; $ae2942=0; $z7ec7e=''; $qe8fab=''; if (o0738( "SELECT `NoteID`, `Text` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `IsNew`=1 ORDER BY `Stamp`" )) { $result=r0d6b(); $ae2942=count($result); if ($ae2942){ $y21158=$result[0]['NoteID']; $qe8fab=y83c8( 'e2m_note', array ('*note' => j4627($y21158)) ); } else { $qe8fab=''; } } return array ((int)$ae2942,$z7ec7e,$qe8fab); } function m1baf($y21158,$f641f6){ global$_config; if(__LOG)__log('Comments: getting comments for note '. $y21158); if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". @$y21158." ". @$kf79b1 ." ". $f641f6 )) { $result=r0d6b(); return$result; } return array (); } function d4975($uaad65,$md1cc6=''){ global$_config; $k70a17="ORDER BY `ID` DESC"; $i2cb9d=$waf67c=array(); if (o0738( "SELECT DISTINCT `ID`, `Text`, `IsSubscriber`, `AuthorName`, `AuthorEmail`, `Stamp` ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". @$uaad65['ID'] ." ". "AND `IsSubscriber`=1 ". "AND `AuthorEmail`!='". u7928($md1cc6) ."' ". $k70a17 )) { $result=r0d6b(); foreach($result as $w39c63){ if (!in_array($w39c63['AuthorEmail'],$waf67c)) { $i2cb9d[] = $w39c63; } $waf67c[] = $w39c63['AuthorEmail']; } } return $i2cb9d; } function rb387($uaad65,$r3f917=NOTE_COMMENTABLE_NOW){ global$settings,$_config; $vbdb20=true; if (@$settings['comments']['fresh_only']) if (isset ($_config['comment_freshness_days'])) if ($uaad65['Stamp'] < time()-$_config['comment_freshness_days']*SECONDS_IN_A_DAY) $vbdb20=false; $bc770a=$uaad65['IsCommentable']; if ($r3f917==NOTE_COMMENTABLE_NOW_CONDITIONALLY){ $bc770a=true; } return ( $uaad65['IsPublished'] and $uaad65['IsVisible'] and $vbdb20 and $bc770a ); } function e2_commentrec_with_parameters_($parameters=array ()) { $f39a37=$parameters['*note']; $na5d49=m1baf($f39a37['ID'],"ORDER BY `Stamp`"); $s4032b=@$na5d49[$parameters['comment-number']-1]; if ($s4032b){ $s4032b['noterec']=$f39a37; return $s4032b; } } function x1a90($r98ea6=''){ global$settings,$wcbcce,$_config,$_fp_error; $_fp_error=false; $kbe16c='elton-john'; $y21158=$l69b97=$ib0689=$c0c83f=$h1cb25=''; if(array_key_exists('note-id',$_POST)) $y21158=trim(@$_POST['note-id']); if(array_key_exists('comment-id',$_POST)) $l69b97=trim(@$_POST['comment-id']); if(array_key_exists('name',$_POST)) $ib0689=trim(@$_POST['name']); if(array_key_exists($kbe16c,$_POST)) $c0c83f=trim(@$_POST[$kbe16c]); if(array_key_exists('text',$_POST)) $h1cb25=trim(@$_POST['text']); $ib0689=rff7c($ib0689); $h1cb25=rff7c($h1cb25); $v07d3d=( (array_key_exists('already-subscribed',$_POST) and $_POST['already-subscribed']) or (array_key_exists('subscribe',$_POST) and $_POST['subscribe']) ); $i20612=time(); $i9d090['text']=$h1cb25; if ($l69b97=='new'){ nc64a('commenter_name',$ib0689); nc64a('commenter_email',$c0c83f); } $f848b5=($l69b97=='new' and ( (array_key_exists('email',$_POST) and $_POST['email']!=='')) or (!array_key_exists('first-name',$_POST) or ($_POST['first-name']!=='') )); $bc2b1a=1; $result=false; if (!is_numeric($y21158)) { $_fp_error=FP_NO_ID_OR_NEW; } elseif (!is_numeric($l69b97) and !($l69b97=='new')) { $_fp_error=FP_NO_ID_OR_NEW; } else { if ($l69b97 and $ib0689=='' or $c0c83f=='' or $h1cb25==''){ $_fp_error=FP_EMPTY_FIELD; } if ($l69b97=='new'){ $t795f1=@unserialize(file_get_contents(USER_FOLDER. '/last-comment.psa')); if(md5($ib0689.$c0c83f.$h1cb25)==$t795f1['md5']) { $_fp_error=FP_COMMENT_DOUBLE_POST; } if ( isset ($_config['max_comment_length']) and strlen(@$_POST['text']) > ($_config['max_comment_length']) ){ $_fp_error=FP_COMMENT_TOO_LONG; } $f39a37=j4627($y21158); if ($l69b97=='new' and !rb387($f39a37)) { $_fp_error=FP_NOT_COMMENTABLE; } if ($f848b5){ $_fp_error=FP_COMMENT_SPAM_SUSPECT; } } } if (!$_fp_error){ e2_drop_caches_for_note_($y21158); if ($l69b97=='new'){ $s4032b=array ( 'NoteID' => (int)$y21158, 'AuthorName' => $ib0689, 'AuthorEmail' => $c0c83f, 'Text' => $h1cb25, 'Reply' => '', 'IsVisible' => 1, 'IsAnswerAware' => 1, 'IsSubscriber' => (int)$v07d3d, 'IsSpamSuspect' => (int)$f848b5, 'IsNew' => (int)$bc2b1a, 'Stamp' => (int)time(), 'LastModified' => (int)time(), 'IP' => u7928($_SERVER['REMOTE_ADDR']), ); if (($s4032b=m9943('Comments',$s4032b)) !== false){ $l69b97=$s4032b['ID']; $t795f1=array ( 'id' => $l69b97, 'md5' => md5($ib0689.$c0c83f.$h1cb25), ); @t6e52(USER_FOLDER. 'last-comment.psa',serialize($t795f1)); $result=(int)$l69b97; $e303ee=md5($s4032b['ID'].$s4032b['Stamp'].'x'); nc64a('commenter_ph',$e303ee); $j60422=p254f($y21158,'all')-1+1; $uaad65=j4627($y21158); $od58c0=y83c8('e2m_note', array ('*note' => $uaad65)); $sc6827['comment-time'] = array ($i20612,s5c05()); $sc6827['commenter']=$ib0689; $sc6827['commenter-email']=$c0c83f; $sc6827['comment-text']=$h1cb25; $sc6827['note-title']=$uaad65['Title']; $sc6827['note-href']=$od58c0; $sc6827['comment-href']=$od58c0; $sc6827['comments-disable-href']=y83c8('e2m_note_flag', array ( '*note' => $uaad65, 'flag' => 'IsCommentable', 'value' => 0 )); $sc6827['reply-href']=y83c8( 'e2m_comment_reply', array ('*note' => $uaad65,'comment-number' => $j60422) ); if (isset ($settings['user']['email']) and @$settings['notifications']['new_comments']) { $zde7a3=u3e5c( 'comment-new-to-author',$sc6827 ); $ub904c=e2l_get_string( 'em--comment-new-to-author-subject', $sc6827 ); $y77613=$settings['user']['email']; $e1a49b = 'From: '. oaed2() ."\r\n". 'Reply-to: '. $ib0689 .' <'. $c0c83f .">"; aa41b($y77613,$ub904c,$zde7a3,$e1a49b); } if (!$f848b5){ unset ($sc6827['commenter-email']); $e1a49b='From: '. oaed2(); foreach (d4975($uaad65,$c0c83f) as $w39c63){ $rba570=$w39c63['AuthorEmail']; $e6fd85=md5($w39c63['ID'].$w39c63['Stamp'].'x'); $sc6827['unsubscribe-href']=y83c8('e2m_unsubscribe', array ( '*note' => $uaad65, 'unsubscribe-email' => $rba570, 'unsubscribe-key' => $e6fd85 ) ); $y77613=$rba570; $zde7a3=u3e5c('comment-new-to-public',$sc6827); $ub904c=e2l_get_string( 'em--comment-new-to-public-subject', $sc6827 ); aa41b($y77613,$ub904c,$zde7a3,$e1a49b); } } } else { $_fp_error=FP_INSERT_ERROR; } } else { $ifd6f3=array ( 'ID' => $l69b97, 'AuthorName' => $ib0689, 'AuthorEmail' => $c0c83f, 'Text' => $h1cb25, 'IsSubscriber' => ((int)$v07d3d), 'LastModified' => time(), ); if (eaa79('Comments',$ifd6f3)) { $result=(int)$l69b97; } else { $_fp_error=FP_UPDATE_ERROR; }; } } if ($r98ea6=='ajaxresult') return $h1fa03; else return array ((int)$y21158,$result,$i9d090); } function e2m_most_commented(){ global$settings,$_strings,$_config; $na0acf=@$_GET['period']; if ($na0acf=='')$na0acf=$_config['hot_period']; $v632a2=time()-g35c3($na0acf); $kf79b1="AND `IsVisible`=1 "; if (ve852())$kf79b1=''; return dd864(array ( 'query' => "SELECT `IsVisible`, `Stamp`, `NoteID` ID, count(*) c ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE (`Stamp` > ". $v632a2.") ". $kf79b1. "GROUP BY `NoteID` ". "ORDER BY c ". "DESC ". "LIMIT ".$settings['appearance']['notes_per_page'], 'query-returns-only-ids' => 1, 'limit' => $settings['appearance']['notes_per_page'], 'title' => e2l_get_string('pt--most-commented', array ('period' => $na0acf)), 'heading' => e2l_get_string('pt--most-commented', array ('period' => $na0acf)), 'nothing' => $_strings['gs--no-such-notes'], )); } function e2m_favourites($parameters=array ()) { global$_config,$_strings; $kf79b1="AND `IsVisible`=1 "; if (ve852())$kf79b1=''; return dd864(array ( 'query' => "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND `IsFavourite`=1 ". $kf79b1 . "ORDER BY `Stamp` DESC", 'page' => $parameters['page'], 'candy' => 'e2m_favourites', 'parameters' => $parameters, 'title' => $_strings['pt--favourites'], 'heading' => $_strings['pt--favourites'], 'nothing' => $_strings['gs--no-favourites'], )); } function g35c3($na0acf){ if ('year'==$na0acf) return SECONDS_IN_A_YEAR; elseif ('month'==$na0acf) return SECONDS_IN_A_MONTH; elseif ('week'==$na0acf) return SECONDS_IN_A_DAY*7; elseif ('day'==$na0acf) return SECONDS_IN_A_DAY; else return PHP_INT_MAX; } function f8696($p8d777){ global$_current_url; if(__LOG)__log('Arbitrary list ('. $p8d777['_log'] .') {'); $fe919a=w7f78(); $tf4ac8=null; if ($p8d777['cache'] and is_file($p8d777['cache-filename'])) { $tf4ac8=@unserialize(file_get_contents($p8d777['cache-filename'])); } $if957e=true; if ($p8d777['cache-filename-expires']) { if ($p8d777['cache'] and is_file($p8d777['cache-filename-expires'])) { $o07cc6=time(); $m09bcb=(int) @file_get_contents($p8d777['cache-filename-expires']); if(__LOG)__log('List expires '. date('r',$m09bcb) .', now '. date('r',$o07cc6)); $if957e=($o07cc6 < $m09bcb); } } $rdbb0c=array(); if ($p8d777['cache'] and is_array($tf4ac8) and $if957e){ if(__LOG)__log('Retrieve cached ctree'); $rdbb0c=$tf4ac8; } else { if(__LOG)__log('Assemle cacheable ctree...'); $o4358b=array(); if (o0738($p8d777['query'])) { $result=r0d6b(); foreach($result as $c8ce4b => $f39a37){ $f39a37=j4627($f39a37['ID']); if ($f39a37['IsVisible'] and $f39a37['IsPublished']) { $uaad65['_']['_id']=$f39a37['ID']; $uaad65['_']['_ord']=$c8ce4b; $uaad65['_']['_ord_max']=count($result)-1; $uaad65['href']=y83c8('e2m_note', array ('*note' => $f39a37)); $uaad65['time'] = array ($f39a37['Stamp'],y0923($f39a37)); $uaad65['title']=g6f10(htmlspecialchars($f39a37['Title'],ENT_NOQUOTES,HSC_ENC)); $rdbb0c[] = $uaad65; } } $tf4ac8=$rdbb0c; if ($p8d777['cache']) { @t6e52($p8d777['cache-filename'],serialize($tf4ac8)); if ($p8d777['cache-filename-expires']) { @t6e52($p8d777['cache-filename-expires'],time()+$p8d777['expires-after']); } } } } foreach ($rdbb0c as $c8ce4b => $l9e366){ $rdbb0c[$c8ce4b]['current?'] = ($rdbb0c[$c8ce4b]['href']==$_current_url); } if(__LOG)__log('} // Arbitrary list @ '. round(w7f78()-$fe919a,3)); return $rdbb0c; } function z09d1(){ global$_config; $v632a2=time()-g35c3($_config['hot_period']); return f8696(array ( '_log' => 'most_commented', 'cache' => CACHE_HOT, 'cache-filename' => CACHE_FILENAME_HOT, 'cache-filename-expires' => CACHE_FILENAME_HOT_EXPIRES, 'expires-after' => SECONDS_IN_A_DAY, 'query' => ( "SELECT `Stamp`, `NoteID` ID, count(*) c ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `Stamp` > ". $v632a2 ." AND IsVisible='1'". "GROUP BY `NoteID` ". "ORDER BY c DESC LIMIT 10" ), )); } function t0256(){ global$_config; $v632a2=time()-g35c3($_config['popular_period']); return f8696(array ( '_log' => 'most_read', 'cache' => CACHE_POPULAR, 'cache-filename' => CACHE_FILENAME_POPULAR, 'cache-filename-expires' => CACHE_FILENAME_POPULAR_EXPIRES, 'expires-after' => SECONDS_IN_A_DAY, 'query' => ( "SELECT n.`ID`, n.`Title`, n.`IsFavourite`, a.`EntityID`, SUM(a.`HitCount`) HitCount ". "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n  ". "WHERE a.`Stamp` > ". $v632a2 ." ". "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID` ". "ORDER BY `IsFavourite` DESC, HitCount DESC ". "LIMIT 10" ), )); } function e2m_password(){ global$settings,$_strings; $i2cb9d['title']=$_strings['pt--password']; $i2cb9d['heading']=$_strings['pt--password-for-blog']; $i2cb9d['form']='form-password'; $i2cb9d['form-password'] = array ( 'form-action' => y83c8('e2s_password_save'), 'submit-text' => $_strings['fb--change'], ); return $i2cb9d; } function e2m_sessions(){ global$settings,$_strings; $b2d6d8=j7785(); $i2cb9d['title']=$_strings['pt--sessions']; $i2cb9d['heading']=$_strings['pt--sessions']; $z161bc=array(); $r3c6e0=$_COOKIE[e8c3b('key')]; foreach ($b2d6d8['sessions'] as $c8ce4b => $l9e366){ $z161bc[] = array ( 'current?' => r4c49($r3c6e0)===$l9e366['key_hash'], 'opened' => array ((int)$l9e366['stamp'],i3211()), 'ip-address' => $l9e366['remote_ip'], 'source' => ($l9e366['remote_ip']=='127.0.0.1')? $_strings['gs--locally']:$l9e366['remote_ip'], 'title' => fcc31($l9e366['ua']), 'user-agent' => $l9e366['ua']? $l9e366['ua']:$_strings['gs--unknown'], ); } $z161bc=array_reverse($z161bc); $i2cb9d['sessions']['each']=$z161bc; if(count($z161bc) > 1){ $i2cb9d['form']='form-sessions'; $i2cb9d['form-sessions'] = array ( 'form-action' => y83c8('e2s_drop_other_sessions'), 'submit-text' => $_strings['fb--end-all-sessions-but-this'], ); } return $i2cb9d; } function e2m_sign_in(){ if (ve852()) { e2_go_to(y83c8('e2m_frontpage', array ('page' => 1))); } else { return array (); } } function e2m_sign_out(){ global$_strings; $b2d6d8=j7785(); $j48bb9=-1; if(array_key_exists('sessions',$b2d6d8) and is_array($b2d6d8['sessions'])) { foreach ($b2d6d8['sessions'] as $c8ce4b => $l9e366){ $r3c6e0=$_COOKIE[e8c3b('key')]; if (r4c49($r3c6e0)===$l9e366['key_hash']) { $j48bb9=$c8ce4b; break; } } } if ($j48bb9 > -1) unset ($b2d6d8['sessions'][$j48bb9]); if (!k1d21($b2d6d8)) { y8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } nc64a('key',''); e2_go_to(); die; } function e2s_password_save(){ global$settings,$_strings; $p0512f=trim($_POST['old-password']); if (va8cf($p0512f)) { $d88162=trim($_POST['new-password']); if ($d88162!=''){ if (@t6e52(USER_FOLDER. '/password-hash.psa',serialize(r4c49($d88162)))) { y8a40($_strings['gs--password-changed'],E2E_MESSAGE); e2_go_to(); } else { y8a40($_strings['er--could-not-change-password'],E2E_PERMISSIONS_ERROR); e2_go_to(y83c8('e2m_password')); } } else { y8a40($_strings['er--no-password-entered'],E2E_USER_ERROR); e2_go_to(y83c8('e2m_password')); } } else { y8a40($_strings['er--wrong-password'],E2E_USER_ERROR); e2_go_to(y83c8('e2m_password')); } die; } function e2s_sign_in_necessary(){ e2_go_to(y83c8('e2m_sign_in')); die; } function e2s_sign_in(){ global$_strings; $b2d6d8=j7785(); if($_SERVER['REQUEST_METHOD']=='POST'){ $z5f4dc=@$_POST['password']; $g6bc8e=@$_POST['is_public_pc']; } else { $z5f4dc=@$_GET['password']; $g6bc8e=false; } if (va8cf($z5f4dc)) { $r21d6f=array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => de8ed($g6bc8e), 'ua' => $_SERVER['HTTP_USER_AGENT'], ); $b2d6d8['sessions'][] = $r21d6f; } elseif(strlen(trim($z5f4dc)) > 0){ va711(); y8a40($_strings['er--wrong-password'],E2E_USER_ERROR); } if (!k1d21($b2d6d8)) { y8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); e2_go_to(); die; } v4930(); die; } function e2s_drop_other_sessions(){ global$_strings; $b2d6d8=j7785(); foreach ($b2d6d8['sessions'] as $c8ce4b => $l9e366){ $r3c6e0=$_COOKIE[e8c3b('key')]; if (r4c49($r3c6e0)===$l9e366['key_hash']) { $r21d6f=$l9e366; break; } } $b2d6d8['sessions'] = array ($r21d6f); if (!k1d21($b2d6d8)) { y8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } v4930(); die; } function va8cf($z5f4dc){ $n8e9a8=@unserialize(file_get_contents(USER_FOLDER. '/password-hash.psa')); return (r4c49($z5f4dc)===$n8e9a8 and trim($z5f4dc)!=''); } function de8ed($b2a2a4=false){ global$settings; $r3c6e0=q2a24(); $t3f363=r4c49($r3c6e0); nc64a('key',$r3c6e0, !$b2a2a4); return $t3f363; } function ve852(){ global $c1c0b7,$settings,$_auth_sessions; if (isset ($c1c0b7)) return $c1c0b7; $c1c0b7=false; if (isset ($_COOKIE[e8c3b('key')])) { $r3c6e0=$_COOKIE[e8c3b('key')]; $b2d6d8=j7785(); $d0f83b=array(); if(array_key_exists('sessions',$b2d6d8) and is_array($b2d6d8['sessions'])) { foreach ($b2d6d8['sessions'] as $r21d6f){ $d0f83b[] = $r21d6f['key_hash']; } $_auth_sessions['count']=count($b2d6d8['sessions']); } if(1){ $c1c0b7=(bool)in_array(r4c49($r3c6e0),$d0f83b,true); } if (!$c1c0b7){ nc64a('key',''); } } return $c1c0b7; } function r4c49($p25d90){ if(function_exists('sha1')) { return sha1($p25d90); } else { return substr(md5($p25d90).md5(' '.$p25d90),0,40); } } function j7785(){ if(is_file(USER_FOLDER.'auth.psa')) { $b2d6d8=unserialize(@file_get_contents(USER_FOLDER.'auth.psa')); if ($b2d6d8) return $b2d6d8; } return array (); } function k1d21($b2d6d8){ return t6e52(USER_FOLDER.'auth.psa',serialize($b2d6d8)); } function ic3fb(){ if ($r3c6e0=$_COOKIE[e8c3b('key')]) { return e8c3b('key') .'='. $r3c6e0 .""; } } function cff2e(){ if ($r3c6e0=$_COOKIE[e8c3b('key')]) { return 'Cookie: '. e8c3b('key') .'='. $r3c6e0 ."\r\n"; } return "\r\n"; } function fcc31($r5269f){ global$_strings; if(strstr($r5269f,'iPhone')) return$_strings['gs--ua-iphone']; if(strstr($r5269f,'iPad')) return$_strings['gs--ua-ipad']; if(strstr($r5269f,'Opera'))$i2cb9d=$_strings['gs--ua-opera']; if(strstr($r5269f,'Firefox'))$i2cb9d=$_strings['gs--ua-firefox']; if(strstr($r5269f,'Chrome'))$i2cb9d=$_strings['gs--ua-chrome']; if(strstr($r5269f,'Safari') and !strstr($r5269f,'Chrome'))$i2cb9d=$_strings['gs--ua-safari']; if (!$i2cb9d)$i2cb9d=$_strings['gs--ua-unknown']; if(strstr($r5269f,'Macintosh')) { if ($i2cb9d)$i2cb9d.=' '. $_strings['gs--ua-for-mac']; } return $i2cb9d; } function e2j_check_password(){ $n8e9a8=@unserialize(file_get_contents(USER_FOLDER. '/password-hash.psa')); $z5f4dc=''; if(array_key_exists('password',$_POST))$z5f4dc=$_POST['password']; va711(); if (r4c49($z5f4dc)===$n8e9a8 and trim($z5f4dc)!=''){ die ('password-correct'); } die ('password-wrong'); } function q2a24(){ $ub04ec=''; $fb8d1b='0123456789abcdef'; for ($q865c0=0; $q865c0 < 40; $q865c0++)$ub04ec.=$fb8d1b[mt_rand(0,15)]; $ub04ec.=time(); $ub04ec=r4c49($ub04ec); return $ub04ec; } function va711(){ if(is_file(USER_FOLDER. 'password-wait.psa')) { $baf788=unserialize( file_get_contents(USER_FOLDER. '/password-wait.psa') ); if ($baf788['delay'] < 5){ $baf788['delay'] ++; } if(time()-$baf788['time'] > SECONDS_IN_A_MINUTE){ $baf788['delay']=0; } $baf788['time']=time(); } else { $baf788=array ( 'time' => time(), 'delay' => 5, ); } t6e52(USER_FOLDER.'password-wait.psa',serialize($baf788)); sleep($baf788['delay']); } function d7874(){ return md5('seсret'); } function b1305($jb45cf){ $r3c6e0=d7874(); $p16ec1=strlen($r3c6e0); $k2db95=strlen($jb45cf); $i2cb9d=''; for ($q865c0=0; $q865c0 < $k2db95+rand(16,64); ++ $q865c0){ if ($q865c0 > $k2db95){ $h462e1=rand(0,127); } elseif ($q865c0==$k2db95){ $h462e1=0; } else { $h462e1=ord($jb45cf[$q865c0]); } $p18e1b=chr(($h462e1+ord($r3c6e0[$q865c0%$p16ec1])) % 256); $i2cb9d.=$p18e1b; } $i2cb9d=base64_encode($i2cb9d); return $i2cb9d; } function uee85($jb45cf){ $r3c6e0=d7874(); $p16ec1=strlen($r3c6e0); $jb45cf=base64_decode($jb45cf); $k2db95=strlen($jb45cf); $i2cb9d=''; for ($q865c0=0; $q865c0 < $k2db95; ++ $q865c0){ $ud9468=(ord($jb45cf[$q865c0]) + 256-ord($r3c6e0[$q865c0%$p16ec1])) % 256; if ($ud9468===0) break; $i2cb9d.=chr($ud9468); } return $i2cb9d; } $_candies_installer=array ( 'e2s_build', 'e2m_info', 'e2m_install', 'e2j_check_db_config', 'e2j_list_databases', 'e2s_instantiate', 'e2s_install', 'e2s_update_perform', ); $_candies_public=array ( 'e2m_info', 'e2m_frontpage', 'e2m_rss', 'e2m_json', 'e2m_note', 'e2m_note_json', 'e2m_note_comment', 'e2m_draft_preview', 'e2m_tags', 'e2m_tag', 'e2m_tag_rss', 'e2m_tag_json', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_comments', 'e2m_everything', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_unsubscribe', 'e2m_sign_out', 'e2m_theme_preview', 'e2s_sign_in', 'e2s_comment_process', 'e2s_search', 'e2s_bsi_step', 'e2j_check_password', 'e2s_notify', ); $_candies_to_disallow_in_read_only=array ( 'e2m_write', 'e2m_note_edit', 'e2s_note_process', 'e2s_note_publish', 'e2s_note_delete', 'e2m_note_flag_favourite', 'e2m_note_flag', 'e2m_note_comment', 'e2m_comment_edit', 'e2m_comment_delete', 'e2m_comment_reply', 'e2m_comment_reply_delete', 'e2m_comment_flag', 'e2m_comment_flag_ajax', 'e2m_unsubscribe', 'e2s_comment_process', 'e2m_settings', 'e2m_timezone', ); $_candies_public=array_merge($_candies_public,$_candies_installer); $_candies_indexable=array ( 'e2m_note', ); $_candies_indexable_conditionally=array ( 'e2m_frontpage', 'e2m_tag', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_tags', 'e2m_everything', ); $_candies_ajax=array ( 'e2j_check_db_config', 'e2j_list_databases', 'e2j_check_password', 'e2j_userpic_upload', 'e2j_file_upload', 'e2j_file_remove', 'e2j_note_livesave', 'e2m_note_flag_favourite', 'e2m_comment_flag_ajax', 'e2m_tag_flag_ajax', ); function e2_modes($parameters){ global$content,$_strings; if (!is_array($parameters))$parameters=array(); if(array_key_exists('~',$parameters)) { $e71860=$parameters['~']; } if(e2_is_installed()) { if(__LOG)__log('Popular and tags menu {'); if (!$content['popular']) { $content['popular'] = array ( 'title' => $_strings['nm--most-read'], ); $content['popular']['each']=t0256(); } if(count($content['popular']['each']) < 10) unset($content['popular']['each']); if (!$content['tags']) { $content['tags']['each']=q5d57(); $content['tags']['many?']=count($content['tags']['each']) > KEYWORDS_MANY_THRESH; $content['tags']['menu-each']=naf16($parameters); } if(__LOG)__log('} // Popular and tags menu'); } } function s6f51(){ global$settings,$_strings; if ( array_key_exists('site_title',$settings) and trim($settings['site_title']) != '' ){ return trim($settings['site_title']); } else { return$_strings['e2--default-blog-title']; } } function z2640(){ global$settings,$_strings; if ( array_key_exists('author',$settings) and trim($settings['author']) != '' ){ return trim($settings['author']); } else { return$_strings['e2--default-blog-author']; } } function i2461(){ global$full_blog_url; if(is_file(USER_FOLDER .'userpic@2x.png')) { return$full_blog_url .'/'. USER_FOLDER .'userpic@2x.png'; } elseif(is_file(USER_FOLDER .'userpic@2x.jpg')) { return$full_blog_url .'/'. USER_FOLDER .'userpic@2x.jpg'; } else { return false; } } function e2m_info(){ global$settings,$_config,$x57de2,$aa57c1,$_template; $of1f71=array ( 'E2_VERSION' => E2_VERSION, 'E2_RELEASE' => E2_RELEASE, 'E2_UA_STRING' => E2_UA_STRING, '---', 'PHP_VERSION' => PHP_VERSION, '---', 'installed' => (bool)e2_is_installed(), 'server_name' => $x57de2, 'folder_on_server' => $aa57c1, '---', 'request_logging' => $_config['request_logging'], 'default formatter' => $_config['default_formatter'], '---', 'theme' => $settings['template'], '---', 'Olba name' => $_template['name'], 'Olba max_image_width' => $_template['max_image_width'], 'Olba stack' => $_template['stack'], '---', 'Neasden' => substr(md5(file_get_contents('system/neasden/neasden.php')), 0,4), '---', ); echo '<pre>'; foreach ($of1f71 as $c8ce4b => $l9e366){ if ($l9e366=='---'){ echo "\n"; continue; } echo str_pad($c8ce4b,24); echo '\''; print_r($l9e366); echo '\''; echo "\n"; } echo '</pre>'; die; } function e2s_notify(){ global$_config; if($_config['holborn']) { $u4de32=@$_GET['src']; if ($u4de32==''){ if(__LOG)__log('Holborn: No src URL'); die; } $y466de=file_get_contents($u4de32); $y466de=l09a6($y466de); $ce13b0=json_decode($y466de,true); if (!$ce13b0){ if(__LOG)__log('Holborn: No meaningful info from '. $u4de32 .' ('. json_last_error() .')'); if ($c13bc3=edd69($u4de32)) { if(__LOG)__log('Holborn: Delete note with ID '. $c13bc3['ID']); je268($c13bc3['ID'],false); } die; } s927d($ce13b0,$u4de32); } die; } function e2m_source_trust($parameters){ global$_config; $e0afd9=$parameters['source']; o0738( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsTrusted`=1 ". "WHERE `ID`=". $e0afd9 ); o0738( "UPDATE  ". $_config['db_table_prefix']."Notes ". "SET `IsPublished`=1 ". "WHERE `SourceID`=". $e0afd9 ); g198f(); r7996(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); e2_go_to(''); die; } function e2m_source_premoderate($parameters){ global$_config; $e0afd9=$parameters['source']; o0738( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsTrusted`=0 ". "WHERE `ID`=". $e0afd9 ); r7996(); e2_go_to(''); die; } function e2m_source_ban($parameters){ global$_config; $e0afd9=$parameters['source']; o0738( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsWhiteListed`=0, `IsTrusted`=0 ". "WHERE `ID`=". $e0afd9 ); o0738( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SourceID`=". $e0afd9 ); r7996(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); e2_go_to(''); die; } function e2m_source_forget($parameters){ global$_config; $e0afd9=$parameters['source']; o0738( "DELETE FROM  ". $_config['db_table_prefix']."Sources ". "WHERE `ID`=". $e0afd9 ); o0738( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SourceID`=". $e0afd9 ); r7996(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); e2_go_to(''); die; } function s927d($ce13b0,$u4de32){ if(__LOG)__log('Holborn: Note info == '. print_r($ce13b0,true)); if (@$ce13b0['items']) { if(__LOG)__log('Holborn: JSON feed format'); $ha4a84=y10cd(array ( 'author' => $ce13b0['author']['name'], 'title' => $ce13b0['title'], 'href' => $ce13b0['author']['url'], 'userpic-href' => $ce13b0['author']['avatar'], )); if (!$ha4a84['IsWhiteListed']) return; if(preg_match('/\+(\d\d)\:(\d\d)/',$ce13b0['items'][0]['date_published'],$b9c28d)) { $m7a86c=$b9c28d[1]*SECONDS_IN_AN_HOUR+$b9c28d[2]*SECONDS_IN_A_MINUTE; } $v929cf=@$ce13b0['items'][0]['_e2_data'] or $v929cf=array(); $v929cf=json_encode($v929cf); $f39a37=array ( 'Title' => $ce13b0['items'][0]['title'], 'Text' => $ce13b0['items'][0]['content_html'], 'FormatterID' => 'raw', 'OriginalAlias' => '', 'Uploads' => '', 'Stamp' => strtotime($ce13b0['items'][0]['date_published']), 'Offset' => (int)$m7a86c, 'IsDST' => 0, 'LastModified' => strtotime($ce13b0['items'][0]['date_modified']), 'IsCommentable' => 0, 'IsPublished' => $ha4a84['IsTrusted'], 'IsExternal' => 1, 'SourceID' => $ha4a84['ID'], 'SourceNoteID' => $ce13b0['items'][0]['id'], 'SourceNoteURL' => $ce13b0['items'][0]['url'], 'SourceNoteJSONURL' => $u4de32, 'SourceNoteData' => $v929cf, ); $y21158=$ce13b0['items'][0]['id']; } else { if(__LOG)__log('Holborn: legacy custom format'); $n03396=@$ce13b0['blog']; $ha4a84=y10cd($n03396); if (!$ha4a84['IsWhiteListed']) return; $v929cf=@$ce13b0['note']['og-images'] or $v929cf=array(); $v929cf['og_images']=$v929cf; $v929cf=json_encode($v929cf); $f39a37=array ( 'Title' => $ce13b0['note']['title'], 'Text' => $ce13b0['note']['text'], 'FormatterID' => 'raw', 'OriginalAlias' => '', 'Uploads' => '', 'Stamp' => $ce13b0['note']['time'][0], 'Offset' => (int)$ce13b0['note']['time'][1]['offset'], 'IsDST' => (int)$ce13b0['note']['time'][1]['is_dst'], 'LastModified' => $ce13b0['note']['last-modified'][0], 'IsCommentable' => 0, 'IsPublished' => $ha4a84['IsTrusted'], 'IsExternal' => 1, 'SourceID' => $ha4a84['ID'], 'SourceNoteID' => $ce13b0['note']['id'], 'SourceNoteURL' => $ce13b0['note']['href'], 'SourceNoteJSONURL' => $u4de32, 'SourceNoteData' => $v929cf, ); $y21158=$ce13b0['note']['id']; } if ( $c13bc3=df25e($ha4a84['ID'],$y21158) ) { $f39a37['ID']=$c13bc3['ID']; eaa79('Notes',$f39a37); } else { $f39a37=m9943('Notes',$f39a37); } pd2e1($f39a37); e2_drop_caches_for_note_($f39a37['ID']); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); ucc38(y83c8('e2s_dump', array ())); } function edd69($u4de32){ global$_config; $result=o0738( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SourceNoteJSONURL`='". $u4de32 ."' ". "LIMIT 1" ); $result=r0d6b(); return$result[0]; } function df25e($e0afd9,$zbb971){ global$_config; $result=o0738( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SourceID`= '". $e0afd9 ."' ". "AND `SourceNoteID`= '". $zbb971 ."' ". "LIMIT 1" ); $result=r0d6b(); return$result[0]; } function l09a6($y466de){ for ($q865c0=0; $q865c0 <= 31; ++$q865c0){ $y466de=str_replace(chr($q865c0),'',$y466de); } $y466de=str_replace(chr(127),'',$y466de); if(0===strpos(bin2hex($y466de),'efbbbf')) { $y466de=substr($y466de,3); } return $y466de; } function y10cd($n03396){ global$_config; $j305c2=false; $result=o0738( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `URL`= '". $n03396['href'] ."' ". "LIMIT 1" ); $result=r0d6b(); if(count($result)) { $j305c2=$result[0]; if ($j305c2['ID']!=$j305c2['TrueID']) { $result=o0738( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `ID`= '". $j305c2['TrueID'] ."' ". "LIMIT 1" ); $result=r0d6b(); if(count($result)) { $j305c2=$result[0]; } } } $ha4a84=array ( 'Title' => $n03396['title'], 'AuthorName' => $n03396['author'], 'PictureURL' => $n03396['userpic-href'], ); if ($j305c2!==false){ if ( $j305c2['Title']!==$n03396['title'] or $j305c2['AuthorName']!==$n03396['author'] or $j305c2['PictureURL']!==$n03396['userpic-href'] ) { $ha4a84['ID']=$j305c2['ID']; eaa79('Sources',$ha4a84); } return $j305c2; } else { $ha4a84['URL']=$n03396['href']; $ha4a84['IsWhiteListed']=1; $ha4a84['IsTrusted']=0; $ha4a84=m9943('Sources',$ha4a84); $ha4a84['TrueID']=$ha4a84['ID']; eaa79('Sources',$ha4a84); return $ha4a84; } } function o1a48($f39a37,$b34d5a=false){ global$_config; $sc6827=array(); if (@$f39a37['IsExternal']) { if(array_key_exists('SourceID',$f39a37)) { if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Sources` ". "WHERE `ID` = '". $f39a37['SourceID'] ."'" )) { $wfa816=r0d6b(); } $sc6827['source']=$wfa816[0]['Title']; $sc6827['source-id']=$f39a37['SourceID']; $sc6827['source-true-id']=$wfa816[0]['TrueID']; $sc6827['source-whitelisted?']=$wfa816[0]['IsWhiteListed']; $sc6827['source-trusted?']=$wfa816[0]['IsTrusted']; if (!$wfa816[0]['IsTrusted']) { $sc6827['source-trust-url']=y83c8( 'e2m_source_trust', array ('source' => $f39a37['SourceID']) ); } if ($wfa816[0]['IsTrusted']) { $sc6827['source-premoderate-url']=y83c8( 'e2m_source_premoderate', array ('source' => $f39a37['SourceID']) ); } $sc6827['source-ban-url']=y83c8( 'e2m_source_ban', array ('source' => $f39a37['SourceID']) ); $sc6827['source-forget-url']=y83c8( 'e2m_source_forget', array ('source' => $f39a37['SourceID']) ); $sc6827['author']=$wfa816[0]['AuthorName']; $sc6827['author-href']=$wfa816[0]['URL']; $sc6827['userpic-href']=$wfa816[0]['PictureURL']; } if ($b34d5a){ if(array_key_exists('SourceNoteURL',$f39a37) and @$f39a37['SourceNoteURL']!=''){ $sc6827['href']=$f39a37['SourceNoteURL']; $sc6827['href-original']=$f39a37['SourceNoteURL']; } } } return $sc6827; } function e2m_frontpage($parameters=array ()) { global$settings,$_config,$_strings; $e71860=$parameters['page']; $sd7e5d=$settings['appearance']['notes_per_page']; $q06d2e=c8ca0(true,true); if (ve852())$q06d2e+=c8ca0(true,false); $kae0fe=ceil($q06d2e/$sd7e5d); $xd29bb=CACHE_FILENAME_FRONTPAGE; if (ve852())$xd29bb=CACHE_FILENAME_FRONTPAGE_AUTHOR; if ($e71860 < 1) return e2_error404_mode(); if(CACHE_FRONTPAGE and $e71860==1 and is_file($xd29bb)) { $o4358b=@unserialize(file_get_contents($xd29bb)); } if(CACHE_FRONTPAGE and $e71860==1 and is_array($o4358b)) { } else { if (($result=q7573($e71860)) === false){ y8a40($_strings['er--cannot-show-latest-notes'],E2E_DATABASE_ERROR); return array ( 'title' => htmlspecialchars(s6f51(),ENT_NOQUOTES,HSC_ENC), ); } $o4358b=array(); if(count($result) > 0){ foreach($result as $c8ce4b => $uaad65){ $uaad65['_']['_id']=$uaad65['ID']; $uaad65['_']['_title']=$uaad65['Title']; $uaad65['_']['_ord']=$c8ce4b; $uaad65['_']['_ord_max']=count($result)-1; $ye244c=j6791($uaad65); $o4358b[] = $ye244c; } } else { if ($e71860!=1) return e2_error404_mode(); } if(CACHE_FRONTPAGE and $e71860==1)t6e52($xd29bb,serialize($o4358b)); } $ab3b32['timeline?']=true; $ab3b32['count']=$kae0fe; $ab3b32['this'] = (int)$e71860; if ($kae0fe > 1){ if ($e71860 < $kae0fe)$ab3b32['earlier-href']=y83c8('e2m_frontpage', array ('page' => $e71860+1)); if ($e71860 > 1)$ab3b32['later-href']=y83c8('e2m_frontpage', array ('page' => $e71860-1)); $ab3b32['earlier-title']=$_strings['gs--earlier']; $ab3b32['later-title']=$_strings['gs--later']; } $td5d3d=s6f51(); return array ( 'frontpage?' => (bool) ($e71860==1), 'title' => $td5d3d, 'notes' => $o4358b, 'pages' => $ab3b32, ); } function q7573($e71860=1){ global$settings,$_config; $zb01a5=$zd5566; $g8b7af='all'; if (!ve852()) { $l25715="AND `IsVisible`=1 "; $g8b7af='visible'; } $zb01a5.='_'.$g8b7af; $p19ee4=($e71860-1)*$settings['appearance']['notes_per_page']; $gaa9f7=$p19ee4 .', '. $settings['appearance']['notes_per_page']; if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 " .@$l25715. "ORDER BY `Stamp` DESC ". "LIMIT ". $gaa9f7 )) { $result=r0d6b(); return$result; } else { return false; } } function e2m_json($parameters=array ()) { list ($bb9076,$i20612)=eab26(); $y466de=json_encode($bb9076,E2_JSON_STYLE); a8ec5($y466de,$i20612,'json'); } function e2m_rss($parameters=array ()) { list ($bb9076,$i20612)=eab26(); $r8bb85=e2feeds__rss_using_jsonfeed_array_($bb9076); a8ec5($r8bb85,$i20612,'rss'); } function e2m_tag_json($parameters=array ()) { if(array_key_exists('*tag',$parameters)) { $pb19ad=$parameters['*tag']; } else { return e2_error404_mode(); } list ($bb9076,$i20612)=je229($pb19ad); $y466de=json_encode($bb9076,E2_JSON_STYLE); a8ec5($y466de,$i20612,'json'); } function e2m_tag_rss($parameters=array ()) { global$settings,$_config,$_strings; if(array_key_exists('*tag',$parameters)) { $pb19ad=$parameters['*tag']; } else { return e2_error404_mode(); } list ($bb9076,$i20612)=je229($pb19ad); $r8bb85=e2feeds__rss_using_jsonfeed_array_($bb9076); a8ec5($r8bb85,$i20612,'rss'); } function e2m_note_json($parameters=array ()) { global$settings,$_current_url; $f39a37=$parameters['*note']; if ($f39a37==false){ return e2_error404_mode(); } $f39a37['_']['_id']=$f39a37['ID']; $i20612=$f39a37['Stamp']; $l7da21=e2_jsonfeed_item_array_from_noterec_($f39a37); $q0bf08=array ($l7da21); $bb9076=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($q0bf08); $bb9076['title']=$settings['site_title']; $bb9076['home_page_url']=y83c8('e2m_frontpage', array ('page' => 1)); $bb9076['feed_url']=$_current_url; a8ec5(json_encode($bb9076,E2_JSON_STYLE),$i20612,'json'); } function e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($q0bf08){ return array ( 'version' => 'https://jsonfeed.org/version/1', 'title' => null, 'home_page_url' => null, 'feed_url' => null, 'icon' => i2461(), 'author' => array ( 'name' => z2640(), 'url' => y83c8('e2m_frontpage', array ('page' => 1)), 'avatar' => i2461(), ), 'items' => $q0bf08, '_e2_version' => E2_VERSION, '_e2_ua_string' => E2_UA_STRING, ); } function e2_jsonfeed_item_array_from_noterec_($f39a37){ global$settings; $f39a37['_']['_id']=$f39a37['ID']; $j572d4=y83c8('e2m_note', array ('*note' => $f39a37)); $s803d0=( da846('Y-m-d\TH:i:s',$f39a37['Stamp']) . wd536($f39a37['Stamp'],':') ); $cade16=( da846('Y-m-d\TH:i:s',$f39a37['LastModified']) . wd536($f39a37['LastModified'],':') ); $k316ec=( da846('D, d M Y H:i:s ',$f39a37['Stamp']) . wd536($f39a37['Stamp']) ); $m2bfe4=a154e($f39a37['FormatterID'], @$f39a37['Text'],'full-rss'); $gad965=kdbcc( 'note',$f39a37['_']['_id'], $m2bfe4['meta']['resources-detected'] ); $ze70c4=array ( 'id' => (string)$f39a37['ID'], 'url' => $j572d4, 'title' => g6f10(htmlspecialchars($f39a37['Title'],ENT_NOQUOTES)), 'content_html' => $m2bfe4['text-final'], 'date_published' => $s803d0, 'date_modified' => $cade16, ); if ($f39a37['IsExternal']) { $k60d40=o1a48($f39a37); $ze70c4['url']=$k60d40['href']; $ze70c4['author'] = array ( 'name' => $k60d40['author'], 'url' => $k60d40['author-href'], 'avatar' => $k60d40['userpic-href'], ); } if(count($gad965) > 0){ $ze70c4['image']=$gad965[0]; } $ze70c4['_date_published_rfc2822']=$k316ec; if ($f39a37['Stamp'] < $settings['v3223_rss_permalinks_before_stamp']) { $ze70c4['_rss_guid_is_permalink']='true'; $ze70c4['_rss_guid']=$ze70c4['url']; } else { $ze70c4['_rss_guid_is_permalink']='false'; $ze70c4['_rss_guid'] = (string)$f39a37['ID']; } $ze70c4['_e2_data'] = array ( 'is_favourite' => (bool)$f39a37['IsFavourite'], 'links_required' => $m2bfe4['meta']['links-required'], 'og_images' => $gad965, ); return $ze70c4; } function f3010($i7a402,$td5d3d,$qe8fab){ global$_newsfeeds; $rfc0f6=''; if ($i7a402=='rss')$rfc0f6='application/rss+xml'; if ($i7a402=='json')$rfc0f6='application/json'; $f336a4=array ( 'type' => $rfc0f6, 'title' => htmlspecialchars($td5d3d,ENT_NOQUOTES,HSC_ENC), 'href' => $qe8fab ); $_newsfeeds[] = $f336a4; } function zed63(){ global$_config; if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND `IsVisible`=1 ". "ORDER BY `Stamp` DESC ". "LIMIT ". $_config['rss_items'] )) { $result=r0d6b(); return$result; } } function eab26(){ global$settings,$_current_url; $i20612=0; $q0bf08=array(); $bb9076=array(); $xd29bb=CACHE_FILENAME_FRONTPAGE_FEED; if(CACHE_FRONTPAGE_FEED and is_file($xd29bb)) { if(__LOG)__log('Feed array (RSS, JSON): cached'); $bb9076=@unserialize(file_get_contents($xd29bb)); $i20612=filemtime($xd29bb); } else { if(__LOG)__log('Feed array (RSS, JSON): not cached, will need to build'); if (($nc2d18=zed63()) !== false){ foreach ($nc2d18 as $f39a37){ $q0bf08[] = e2_jsonfeed_item_array_from_noterec_($f39a37); $i20612=max($i20612,$f39a37['Stamp']); } $bb9076=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($q0bf08); $bb9076['title']=$settings['site_title']; $bb9076['home_page_url']=y83c8('e2m_frontpage', array ('page' => 1)); $bb9076['feed_url']=$_current_url; if(CACHE_FRONTPAGE_FEED)t6e52($xd29bb,serialize($bb9076)); } } return array ($bb9076,$i20612); } function je229($pb19ad){ global$settings,$_config,$_strings,$_current_url; $i20612=0; $q0bf08=array(); if ((o0738( "SELECT `". $_config['db_table_prefix']."Notes`.* ". "FROM `". $_config['db_table_prefix']."Notes` ". "INNER JOIN `". $_config['db_table_prefix']."NotesKeywords` ". "ON `". $_config['db_table_prefix']."NotesKeywords`.NoteID=`". $_config['db_table_prefix']."Notes`.ID ". "WHERE (`". $_config['db_table_prefix']."NotesKeywords`.KeywordID=". $pb19ad['ID'] .") ". "ORDER BY `". $_config['db_table_prefix'] ."Notes`.`Stamp` DESC ". "LIMIT ". $_config['rss_items'] )) !== false){ $nc2d18=r0d6b(); foreach ($nc2d18 as $f39a37){ $q0bf08[] = e2_jsonfeed_item_array_from_noterec_($f39a37); $i20612=max($i20612,$f39a37['Stamp']); } $bb9076=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($q0bf08); $bb9076['title'] = ( $settings['site_title'] .', '. $_strings['gs--posts-tagged'] .': '. $pb19ad['Keyword'] ); $bb9076['home_page_url']=y83c8('e2m_tag', array ('*tag' => $pb19ad)); $bb9076['feed_url']=$_current_url; } return array ($bb9076,$i20612); } function e2feeds__rss_using_jsonfeed_array_($content){ $f92eac=DEFAULTS_FOLDER.'rss/rss.tmpl.php'; if(is_file($f92eac)) { ob_start(); include $f92eac; $r8bb85=ob_get_contents(); ob_end_clean(); } return $r8bb85; } function w99a9($r8bb85){ $r8bb85=str_replace("\x0",'',$r8bb85); for ($q865c0=0; $q865c0 < strlen($r8bb85); ++$q865c0){ if(ord($r8bb85[$q865c0]) < 32 and !in_array(ord($r8bb85[$q865c0]), array (10,13))) { $r8bb85[$q865c0]=''; } } return $r8bb85; } function a8ec5($g321c3,$i20612,$i7a402){ $y69a10=gmdate('r',$i20612); $l1872a=md5($i20612); if ($i7a402=='rss'){ if(RSS_AS_TEXT){ header('Content-Type: text/plain'); } else { header('Content-type: application/xml; charset=utf-8'); } } elseif ($i7a402=='json'){ header('Content-Type: application/json'); } else { header('Content-Type: text/plain'); } header('Last-modified: '. $y69a10); header('Etag: '. $l1872a); header('Cache-Control: public'); header('Expires: '. date('r',$i20612+SECONDS_IN_A_DAY)); $u0c3cd=isset($_SERVER['HTTP_IF_MODIFIED_SINCE'])? stripslashes($_SERVER['HTTP_IF_MODIFIED_SINCE']) : false; $ac3522=isset($_SERVER['HTTP_IF_NONE_MATCH'])? stripslashes($_SERVER['HTTP_IF_NONE_MATCH']) : false; if ( !$u0c3cd && !$ac3522 or $ac3522 && $ac3522!=$l1872a or $u0c3cd && $u0c3cd!=$y69a10 ){ if ($i7a402=='rss'){ $r8bb85=w99a9($r8bb85); } echo $g321c3; } else { header('HTTP/1.1 304 Not Modified'); } die; } function e2m_year($parameters=array ()) { global$_strings,$_config; $b84cdc=$parameters['year']; $t09d6c=e2l_get_string('pt--nth-year', array ('year' => $b84cdc)); if (!p1665($b84cdc)) { return e2_error404_mode(); } $se6e7d=gmmktime(0,0,0,1,1,$b84cdc-1); $i029bd=gmmktime(0,0,0,1,1,$b84cdc+1); list ($w8aebd,$o5a7f3)=e2__fruitful_neighbours_with_ymd_($b84cdc); $da6d40='e2m_year'; if ($w8aebd){ $ab3b32['prev-href']=y83c8( $da6d40,e2__parameters_with_timestamp_($w8aebd) ); $ab3b32['prev-jump?'] = (bool) (gmdate('Y',$se6e7d)!=gmdate('Y',$w8aebd)); $ab3b32['prev-title']=gmdate('Y',$w8aebd); } if ($o5a7f3){ $ab3b32['next-href']=y83c8( $da6d40,e2__parameters_with_timestamp_($o5a7f3) ); $ab3b32['next-jump?'] = (bool) (gmdate('Y',$i029bd)!=gmdate('Y',$o5a7f3)); $ab3b32['next-title']=gmdate('Y',$o5a7f3); } $ab3b32['timeline?']=false; $ab3b32['this']=$b84cdc; $ab3b32['this-title']=$b84cdc; $nb2442=pcc02('start'); $z8dbc7=pcc02('end'); if ( $b84cdc==a5a2f('Y',$nb2442['stamp'],$nb2442['timezone']) ) { $ufa098=a5a2f('m',$nb2442['stamp'],$nb2442['timezone']); } else { $ufa098=1; } if ( $b84cdc==da846('Y',time()) ) { $ifd384=da846('m',time()); } else { $ifd384=12; } $h6eac3=fb92c($b84cdc); for ($t7436f=1; $t7436f <= 12; ++ $t7436f){ $d7f769=gmmktime(0,0,0,$t7436f,1,$b84cdc); $vd039b[$t7436f] = array ( 'number' => $t7436f, 'start-time' => array ($d7f769,i3211()), 'href' => gmdate('Y/m/',$d7f769), 'real?' => $t7436f >= $ufa098 and $t7436f <= $ifd384, 'fruitful?' => @in_array(gmdate('n',$d7f769),$h6eac3), ); } list ($p7b314,$ra1f20)=p5273($b84cdc); o0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "AND `Stamp` BETWEEN ". $p7b314 ." ". "AND ". $ra1f20 ." ". "ORDER BY `Stamp`" ); $result=r0d6b(); $o4358b=v28df($result,$b84cdc); $i2cb9d=array ( 'title' => $t09d6c, 'heading' => $t09d6c, 'pages' => $ab3b32, 'year' => (int)$b84cdc, 'year-months' => $vd039b, ); if(count($o4358b)) { $i2cb9d['notes-list']=$o4358b; } else { $i2cb9d['nothing']=$_strings['gs--no-such-notes']; } return $i2cb9d; } function e2m_month($parameters=array ()) { global$_strings,$_config; $b84cdc= $parameters['year']; $t7436f=$parameters['month']; $t09d6c=e2l_get_string( 'pt--nth-month-of-nth-year', array ('year' => $b84cdc,'month' => $t7436f) ); if (!p1665($b84cdc,$t7436f)) { return e2_error404_mode(); } $se6e7d=gmmktime(0,0,0,$t7436f-1,1,$b84cdc); $i029bd=gmmktime(0,0,0,$t7436f+1,1,$b84cdc); list ($w8aebd,$o5a7f3)=e2__fruitful_neighbours_with_ymd_($b84cdc,$t7436f); $da6d40='e2m_month'; if ($w8aebd){ $ab3b32['prev-href']=y83c8( $da6d40,e2__parameters_with_timestamp_($w8aebd) ); $ab3b32['prev-jump?'] = (bool) (gmdate('Y/m',$se6e7d)!=gmdate('Y/m',$w8aebd)); $ab3b32['prev-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$w8aebd),'month' => gmdate('n',$w8aebd) ) ); } if ($o5a7f3){ $ab3b32['next-href']=y83c8( $da6d40,e2__parameters_with_timestamp_($o5a7f3) ); $ab3b32['next-jump?'] = (bool) (gmdate('Y/m',$i029bd)!=gmdate('Y/m',$o5a7f3)); $ab3b32['next-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$o5a7f3),'month' => gmdate('n',$o5a7f3) ) ); } $ab3b32['timeline?']=false; $ab3b32['this-title']=$t09d6c; list ($p7b314,$ra1f20)=p5273($b84cdc,$t7436f); o0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "AND `Stamp` BETWEEN ". $p7b314 ." ". "AND ". $ra1f20 ." ". "ORDER BY `Stamp`" ); $result=r0d6b(); $o4358b=v28df($result,$b84cdc,$t7436f); $ze70c4['title']=$t09d6c; $ze70c4['heading']=$t09d6c; $ze70c4['pages']=$ab3b32; $ze70c4['year'] = (int)$b84cdc; $ze70c4['month'] = (int)$t7436f; $ze70c4['month-days']=e2_pack_month_days_with_ymd_($b84cdc,$t7436f,false); if(count($o4358b)) { $ze70c4['notes-list']=$o4358b; } else { $ze70c4['nothing']=$_strings['gs--no-such-notes']; } return $ze70c4; } function e2m_day($parameters=array ()) { global$_strings; $b84cdc= (int)$parameters['year']; $t7436f=(int)$parameters['month']; $h628b7= (int)$parameters['day']; if (!(p1665($b84cdc,$t7436f,$h628b7))) { return e2_error404_mode(); } $t09d6c=e2l_get_string( 'pt--nth-day-of-nth-month-of-nth-year', array ('year' => $b84cdc,'month' => $t7436f,'day' => $h628b7) ); $se6e7d=gmmktime(0,0,0,$t7436f,$h628b7-1,$b84cdc); $i029bd=gmmktime(0,0,0,$t7436f,$h628b7+1,$b84cdc); list ($w8aebd,$o5a7f3)=e2__fruitful_neighbours_with_ymd_($b84cdc,$t7436f,$h628b7); $da6d40='e2m_day'; if ($w8aebd){ $ab3b32['prev-href']=y83c8( $da6d40,e2__parameters_with_timestamp_($w8aebd) ); $ab3b32['prev-jump?'] = (bool) (gmdate('Y/m/d',$se6e7d)!=gmdate('Y/m/d',$w8aebd)); $ab3b32['prev-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$w8aebd),'month' => gmdate('n',$w8aebd),'day' => gmdate('j',$w8aebd), ) ); } if ($o5a7f3){ $ab3b32['next-href']=y83c8( $da6d40,e2__parameters_with_timestamp_($o5a7f3) ); $ab3b32['next-jump?'] = (bool) (gmdate('Y/m/d',$i029bd)!=gmdate('Y/m/d',$o5a7f3)); $ab3b32['next-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$o5a7f3),'month' => gmdate('n',$o5a7f3),'day' => gmdate('j',$o5a7f3), ) ); } $ab3b32['timeline?']=false; $ab3b32['this-title']=$t09d6c; if (($result=jf9fb($b84cdc,$t7436f,$h628b7)) !== false){ $result=array_reverse($result); foreach($result as $c8ce4b => $uaad65){ if ($uaad65['IsVisible'] or ve852()) { $uaad65['_']['_id']=$uaad65['ID']; $uaad65['_']['_ord']=k; $uaad65['_']['_ord_max']=count($result)-1; $o4358b[] = j6791($uaad65); } } } $ze70c4['title']=$t09d6c; $ze70c4['heading']=$t09d6c; $ze70c4['pages']=$ab3b32; $ze70c4['month-days']=e2_pack_month_days_with_ymd_($b84cdc,$t7436f,$h628b7); if(count($o4358b)) { $ze70c4['notes']=$o4358b; } else { $ze70c4['nothing']=$_strings['gs--no-such-notes']; } return $ze70c4; } function e2m_everything($parameters=array ()) { global$_strings,$_config; $o4358b=null; if(CACHE_FULLLIST and is_file(CACHE_FILENAME_FULLLIST)) { $o4358b=@unserialize(file_get_contents(CACHE_FILENAME_FULLLIST)); if(__LOG)__log('Everything: retrieving from cache...'); } if (!is_array($o4358b)) { if(__LOG)__log('Everything: retrieving from database...'); o0738( "SELECT `ID`, `Title`, `Stamp`, `LastModified`, `Offset`, `IsDST`, ". "`IsFavourite`, `IsPublished`, `IsVisible`, `SourceNoteURL`, `OriginalAlias` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "ORDER BY `Stamp`" ); $result=r0d6b(); if(__LOG)__log('Everything: preparing notes list...'); $o4358b=v28df($result); if(__LOG)__log('Everything: saving cache...'); if(CACHE_FULLLIST)t6e52(CACHE_FILENAME_FULLLIST,serialize($o4358b)); } $z1f525=count($o4358b); $t09d6c=e2l_get_string('pt--n-posts', array ('number' => $z1f525)); if(array_key_exists('part',$_GET) and array_key_exists('of',$_GET)) { if(__LOG)__log('Everything: splitting into parts...'); $wf4c93=$_GET['part']; $r8bf88=$_GET['of']; $t09d6c.=' ('. e2l_get_string('gs--part-x-of-y', array ('part' => $wf4c93,'of' => $r8bf88)) .')'; $l895e3=$z1f525/$r8bf88; $jd98a0=($wf4c93-1)*$l895e3; $z01b6e=$wf4c93*$l895e3; $o4358b=array_slice($o4358b,round($jd98a0),round($z01b6e-round($jd98a0))); } if(__LOG)__log('Everything: done, returning'); $ze70c4['title']=$t09d6c; $ze70c4['heading']=$t09d6c; if(count($o4358b)) { $ze70c4['notes-list']=$o4358b; } else { $ze70c4['nothing']=$_strings['gs--no-notes']; } return $ze70c4; } function e2_pack_month_days_with_ymd_($b84cdc,$t7436f,$h628b7){ $xa6933=a5a2f('t',gmmktime(0,0,0,$t7436f,1,$b84cdc),i3211()); $nb2442=pcc02('start'); $z8dbc7=pcc02('end'); if ( $b84cdc .'/'. $t7436f == a5a2f('Y/n',$nb2442['stamp'],$nb2442['timezone']) ) { $y42eb4=a5a2f('d',$nb2442['stamp'],$nb2442['timezone']); } else { $y42eb4=1; } if ( $b84cdc .'/'. $t7436f == da846('Y/n',time()) ) { $ld5f50=da846('d',time()); } else { $ld5f50=$xa6933; } $ye4602=k82dc($b84cdc,$t7436f); for ($q865c0=1; $q865c0 <= $xa6933; ++ $q865c0){ $d7f769=gmmktime(0,0,0,$t7436f,$q865c0,$b84cdc); $n271c1[$q865c0] = array ( 'number' => $q865c0, 'start-time' => array ($d7f769,i3211()), 'href' => gmdate('Y/m/d/',$d7f769), 'this?' => (bool) ($q865c0==$h628b7), 'real?' => $q865c0 >= $y42eb4 and $q865c0 <= $ld5f50, 'fruitful?' => @in_array(gmdate('d',$d7f769),$ye4602), ); } return $n271c1; } function p1665($b84cdc,$t7436f=false,$h628b7=false){ $nb2442=pcc02('start'); if ($nb2442===false){ return false; } $dc1f1e=a5a2f('Y',$nb2442['stamp'],$nb2442['timezone']); $xebeb3=da846('Y',time()); if ($t7436f===false){ return (bool) ( $b84cdc >= $dc1f1e and $b84cdc <= $xebeb3 ); } else { $r782fc=a5a2f('n',$nb2442['stamp'],$nb2442['timezone']); $e13dd1=da846('n',time()); if ($h628b7===false){ return (bool) ( $t7436f >= 1 and $t7436f <= 12 and ( ($b84cdc > $dc1f1e and $b84cdc < $xebeb3) or ($b84cdc==$dc1f1e and $t7436f >= $r782fc) or ($b84cdc==$xebeb3 and $t7436f <= $e13dd1) ) ); } else { $v7a9c0=a5a2f('j',$nb2442['stamp'],$nb2442['timezone']); $s23209=da846('j',time()); if(1){ return (bool) ( checkdate($t7436f,$h628b7,$b84cdc) and ( ($b84cdc > $dc1f1e and $b84cdc < $xebeb3) or ($b84cdc==$dc1f1e and $t7436f > $r782fc) or ($b84cdc==$dc1f1e and $t7436f==$r782fc and $h628b7 >= $v7a9c0) or ($b84cdc==$xebeb3 and $t7436f < $e13dd1) or ($b84cdc==$xebeb3 and $t7436f==$e13dd1 and $h628b7 <= $s23209) ) ); } } } } function e2__fruitful_neighbours_with_ymd_($z41529,$w6f8f5=false,$d8277e=false){ global$_db,$_config; list ($l3d2fa,$g9468c)=p5273($z41529,$w6f8f5,$d8277e); $rada4b=SECONDS_IN_A_DAY; if ($d8277e===false)$rada4b=SECONDS_IN_A_MONTH; if ($w6f8f5===false)$rada4b=SECONDS_IN_A_YEAR; if (!ve852())$kf79b1="`IsVisible`=1 AND "; if (u0f7c()) { $_db['result']=mysqli_query( $_db['link'], "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` ". "WHERE `IsPublished`=1 AND " .@$kf79b1. "Stamp < '". ($g9468c-$rada4b) ."' ". "ORDER BY Stamp DESC" ); while ($q6438c=@mysqli_fetch_array($_db['result'],MYSQLI_ASSOC)) { list ($b84cdc,$t7436f,$h628b7)=explode('/', a5a2f('Y/n/j',$q6438c['Stamp'],y0923($q6438c)) ); $g7474d=$z41529*10000 + ($w6f8f5? ($w6f8f5*100):0) + ($d8277e? $d8277e:0); $ebd8da=$b84cdc*10000 + ($w6f8f5? ($t7436f*100):0) + ($d8277e? $h628b7:0); if ($ebd8da < $g7474d){ $zbf025=gmmktime(0,0,0,$t7436f,$h628b7,$b84cdc); break; } } $_db['result']=mysqli_query( $_db['link'], "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` ". "WHERE `IsPublished`=1 AND " .@$kf79b1. "Stamp > '". ($l3d2fa+$rada4b) ."' ". "ORDER BY Stamp" ); while ($q6438c=@mysqli_fetch_array($_db['result'],MYSQLI_ASSOC)) { list ($b84cdc,$t7436f,$h628b7)=explode('/', a5a2f('Y/n/j',$q6438c['Stamp'],y0923($q6438c)) ); $g7474d=$z41529*10000 + ($w6f8f5? ($w6f8f5*100):0) + ($d8277e? $d8277e:0); $ebd8da=$b84cdc*10000 + ($w6f8f5? ($t7436f*100):0) + ($d8277e? $h628b7:0); if ($ebd8da > $g7474d){ $t8dc98=gmmktime(0,0,0,$t7436f,$h628b7,$b84cdc); break; } } return array ($zbf025,$t8dc98); } } function e2__parameters_with_timestamp_($e96b8c){ list ( $parameters['year'], $parameters['month'], $parameters['day'] ) = explode('/',gmdate('Y/m/d',$e96b8c)); return$parameters; } function v28df($nc2d18,$b84cdc=false,$t7436f=false){ $e229c3=0; $o4358b=array(); $ff09d8=''; $o4358b=array(); $ccc73f=array(); foreach ($nc2d18 as $c8ce4b => $f39a37){ $uaad65['href'] = y83c8('e2m_note', array ('*note' => $f39a37)); $uaad65['time'] = array ((int)min($f39a37['Stamp'],time()), y0923($f39a37)); $uaad65['last-modified'] = array ((int)min($f39a37['LastModified'],time()), y0923($f39a37)); $uaad65['favourite?'] = (bool) ($f39a37['IsFavourite'] && $f39a37['IsPublished']); if(array_key_exists('SourceNoteURL',$f39a37) and @$f39a37['SourceNoteURL']!=''){ $uaad65['href']=$f39a37['SourceNoteURL']; $uaad65['href-original']=$f39a37['SourceNoteURL']; } if ( ($b84cdc and $t7436f and ( ((int)$b84cdc) .'/'. ((int)$t7436f) == a5a2f('Y/n',$f39a37['Stamp'],y0923($f39a37)) )) or ($b84cdc and !$t7436f and ( (int)$b84cdc == a5a2f('Y',$f39a37['Stamp'],y0923($f39a37)) )) or (!$b84cdc and !$t7436f) ) { array_unshift($o4358b,$uaad65); array_unshift($ccc73f,str_replace("\n",' ',$f39a37['Title'])); } } $e789f1=implode("\n",$ccc73f); if(strlen($e789f1) < 20000){ $e789f1=g6f10(htmlspecialchars($e789f1,ENT_NOQUOTES,HSC_ENC)); $ccc73f=explode("\n",$e789f1); } foreach ($o4358b as $c8ce4b => $l9e366){ $o4358b[$c8ce4b]['title']=$ccc73f[$c8ce4b]; } return $o4358b; } function e2s_sync(){ e2_drop_all_kinds_of_cache(); die ('All caches clean.'); } function e2_note_cache_filename_with_id_($xb80bb){ return str_replace('*',$xb80bb,CACHE_FILENAMES_NOTES); } function e2_drop_caches_for_note_($y21158){ if(__LOG)__log('Caches: Drop caches for note id '. $y21158); ye2f1(); v22e7(); @unlink(e2_note_cache_filename_with_id_($y21158)); @unlink(e2_note_cache_filename_with_id_($y21158 .'-comments')); @unlink(e2_note_cache_filename_with_id_($y21158 .'-comments-author')); @unlink(CACHE_FILENAME_HOT); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_FEED); @unlink(CACHE_FILENAME_FULLLIST); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); @unlink(CACHE_FILENAME_LASTMODIFIEDS); } function r7996(){ if(__LOG)__log('Caches: Drop notes caches'); nc5a6(CACHE_FILENAMES_NOTES); nc5a6(CACHE_FILENAMES_NOTES_COMMENTS); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_FEED); @unlink(CACHE_FILENAME_LASTMODIFIEDS); } function ye2f1(){ if(__LOG)__log('Caches: Drop notes counts cache'); nc5a6(CACHE_FILENAMES_NOTES_COUNTS); } function v22e7(){ if(__LOG)__log('Caches: Drop egde time info cache'); nc5a6(CACHE_FILENAMES_EDGE_TIMEINFO); } function e2_drop_all_kinds_of_cache(){ if(__LOG)__log('Caches: Drop all kinds of caches'); nc5a6(CACHES_FOLDER.'*'); return true; } function u4e27($o139c8){ global$_template,$_config; if(__LOG)__log('Olba: Prepare template <'. $o139c8 .'>'); $vaf10b=array(); $t8598c=$o139c8; $q620f7=TEMPLATES_FOLDER.$t8598c .'/'; $e1b14d=false; $la5fca=false; $q37c8a=false; if ( $o139c8!='' ){ if ( is_dir($q620f7) and is_file($q620f7 .'/theme-info.php') ) { while (1){ $q620f7=TEMPLATES_FOLDER.$t8598c .'/'; array_push($vaf10b,$q620f7); $i38226=include $q620f7 .'/theme-info.php'; $a4e502[$q620f7]=$i38226; if(array_key_exists('max_image_width',$i38226)) { if ($e1b14d===false){ $e1b14d=$i38226['max_image_width']; } } if(array_key_exists('meta_viewport',$i38226)) { if ($la5fca===false){ $la5fca=$i38226['meta_viewport']; } } if(array_key_exists('use_likely_light',$i38226)) { if ($q37c8a===false){ $q37c8a=$i38226['use_likely_light']; } } if(array_key_exists('based_on',$i38226)) { $t8598c=$i38226['based_on']; } else { break; } } } else { } } $q620f7=SYSTEM_TEMPLATE_FOLDER; array_push($vaf10b,$q620f7); if ($e1b14d===false){ $e1b14d=$_config['max_image_width']; } $_template['name']=$o139c8; $_template['max_image_width']=$e1b14d; $_template['meta_viewport']=$la5fca; $_template['use_likely_light']=$q37c8a; $_template['stack']=$vaf10b; $_template['infos']=$a4e502; }; function d53ee($ld436e){ global$content; ++ $_olba_includes; include $ld436e; } function r6a97($m52678){ if(0){ echo '<div style="background: #ff0">'.$m52678.'</div>'; } if(is_dir(EXTRAS_FOLDER)) { $v71cae=EXTRAS_FOLDER.$m52678 .'.tmpl.php'; if(is_file($v71cae)) { d53ee($v71cae); } } return ''; } function u166b($m52678){ global$_template,$_olba_includes; $v71cae='templates/'. $m52678 .'.tmpl.php'; if ($ld436e=e2o__usable_file_with_basename_($v71cae)) { if(__LOG)__log('Olba: Apply template <'. $ld436e .'>'); d53ee($ld436e); } else { p1928($v71cae); } } function obc21(){ global$_config; if ( @$_config['raw_template_data'] or @$_config['raw_template_data_with_param'] and array_key_exists('raw',$_GET) ) { $p3f7d9='raw'; } else { $p3f7d9='main'; } return u166b($p3f7d9); } function p1928($g8b7af){ gf1da($g8b7af,'_olba_missing_templates'); } function sd4c1($t45ac4){ gf1da($t45ac4 .'.css','_olba_used_stylesheets'); } function ld00a($d3205c){ gf1da($d3205c .'.js','_olba_used_scripts'); } function w16f0($ue8acc){ foreach (array (SYSTEM_LIBRARY_FOLDER,USER_LIBRARY_FOLDER) as $n71379){ foreach(glob($n71379.$ue8acc .'/*') as $m8c7dd){ $iabf77=pathinfo($m8c7dd,PATHINFO_EXTENSION); if ($iabf77=='js'){ gf1da($m8c7dd,'_olba_used_scripts'); } if ($iabf77=='css'){ gf1da($m8c7dd,'_olba_used_stylesheets'); } } } } function be655(){ global$_olba_missing_templates; if (isset ($_olba_missing_templates)) { return array_unique($_olba_missing_templates); } } function i94dd(){ global$_template,$_config,$settings; if ($de1260=@opendir(TEMPLATES_FOLDER)) { while (false !== ($j1f769=readdir($de1260))) { if(is_dir(TEMPLATES_FOLDER. $j1f769) and $j1f769!='.' and $j1f769!='..'){ if(is_file(TEMPLATES_FOLDER.$j1f769 .'/theme-info.php')) { $uccf6b[$j1f769]=TEMPLATES_FOLDER.$j1f769 .'/'; } } } closedir($de1260); } $w10ae9=array(); $p2e3a2=1000; foreach ($uccf6b as $ib0689 => $j85114){ $i38226=include $j85114 .'theme-info.php'; $tc2657=@$i38226['display_name']; if (!$tc2657) continue; if(is_array($tc2657)) { if(array_key_exists($settings['language'],$tc2657)) { $tc2657=$tc2657[$settings['language']]; } else { $tc2657=array_shift($tc2657); } } $b6a992=@$i38226['index'] or $b6a992=$p2e3a2 ++; $s62848=@$i38226['colors']; if (!$s62848)$s62848=array ( 'background' => 'transparent', 'headings' => 'rgba(128,128,128,.2)', 'text' => 'rgba(128,128,128,.2)', 'link' => 'rgba(128,128,128,.2)', ); $k16e25=(bool) ($ib0689==$_template['name']); if ($k16e25){ $dcd143=y83c8('e2m_theme_preview', array ('theme' => '')); } else { $dcd143=y83c8('e2m_theme_preview', array ('theme' => $ib0689)); } $w10ae9[$b6a992] = array ( 'name' => $ib0689, 'display-name' => $tc2657, 'colors' => $s62848, 'current?' => $k16e25, 'preview-url' => $dcd143, ); } ksort($w10ae9); return $w10ae9; } function b1492($n435ed){ return e2o__usable_file_with_basename_('images/'. $n435ed); } function cf42c($qb1197){ return file_get_contents(e2o__usable_file_with_basename_('images/'. $qb1197 .'.svg')); } function i576f($t45ac4){ global$_template; $r954eb='styles/'. $t45ac4 .'.css'; $l95aa1=array(); foreach($_template['stack'] as $q620f7){ if(is_file($n435ed=$q620f7.$r954eb)) { $l95aa1[] = $n435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$q620f7]) and in_array($t45ac4,$_template['infos'][$q620f7]['reset_styles']) ) { break; } } $l95aa1=array_reverse($l95aa1); } function c37ca(){ global$_olba_used_stylesheets,$_template; if (!isset ($_olba_used_stylesheets)) return; $_olba_used_stylesheets=array_unique($_olba_used_stylesheets); $ec7f50=array(); foreach($_olba_used_stylesheets as $t45ac4){ if(is_file($t45ac4)) { $ec7f50[] = $t45ac4; continue; } if(is_file($n435ed=USER_FOLDER .'js/'. $t45ac4)) { $ec7f50[] = $n435ed; } $r954eb='styles/'. $t45ac4; $l95aa1=array(); foreach($_template['stack'] as $q620f7){ if(is_file($n435ed=$q620f7.$r954eb)) { $l95aa1[] = $n435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$q620f7]) and in_array($t45ac4,$_template['infos'][$q620f7]['reset_styles']) ) { break; } } $l95aa1=array_reverse($l95aa1); $ec7f50=array_merge($ec7f50,$l95aa1); } foreach ($ec7f50 as $c8ce4b => $l9e366){ $gbc7b3=stat($l9e366); $ec7f50[$c8ce4b].='?'. $gbc7b3['mtime']; } return $ec7f50; } function e4753(){ global$_olba_used_scripts; if (!isset ($_olba_used_scripts)) return; $_olba_used_scripts=array_unique($_olba_used_scripts); $vd6c58=array(); foreach($_olba_used_scripts as $d3205c){ if ( substr($d3205c,0,7)=='http://' or substr($d3205c,0,8)=='https://' or substr($d3205c,0,2)=='//' ){ $vd6c58[] = $d3205c; continue; } if(is_file($d3205c)) { $vd6c58[] = $d3205c; continue; } if(is_file($o9d679=USER_FOLDER .'js/'. $d3205c)) { $vd6c58[] = $o9d679; } $r954eb='js/'. $d3205c; if ($o9d679=e2o__usable_file_with_basename_($r954eb)) { $vd6c58[] = $o9d679; } } foreach ($vd6c58 as $c8ce4b => $l9e366){ $gbc7b3=stat($l9e366); if ($gbc7b3['mtime']) { $vd6c58[$c8ce4b].='?'. $gbc7b3['mtime']; } } return $vd6c58; } function gf1da($g2063c,$of1f71){ if (!isset ($GLOBALS[$of1f71])) { $GLOBALS[$of1f71] = array ($g2063c); } else { $GLOBALS[$of1f71][] = $g2063c; } } function e2o__usable_file_with_basename_($r954eb){ global$_template; foreach($_template['stack'] as $q620f7){ if(is_file($n435ed=$q620f7.$r954eb)) { return $n435ed; } } return ''; } function e2m_theme_preview($parameters){ global$_lang,$_strings,$_superconfig,$_template; if (@$_superconfig['disallow_themes_preview']) { return e2_error404_mode(); } if($parameters['theme']==$_template['name']) { e2_go_to(y83c8('e2m_theme_preview', array ('theme' => ''))); } if($parameters['theme']) { u4e27($parameters['theme']); } $f75725=$_lang; if (!is_file($m8c7dd='system/preview/'. $f75725 .'.php')) { $f75725=$_strings['--secondary-language']; $m8c7dd='system/preview/'. $f75725 .'.php'; } if (!is_file($m8c7dd='system/preview/'. $f75725 .'.php')) { $m8c7dd='system/preview/'. DEFAULT_LANGUAGE .'.php'; } $ze70c4=include $m8c7dd; return $ze70c4; } define('SEARCH_EXTRA_PREFIX','Rose'); define('SEARCH_LIMIT',20); define('SEARCH_SNIPPETS_LIMIT',20); define('SEARCH_USE_ROSE',1); define('SEARCH_USE_MYSQL',1); use S2\Rose\Storage\Exception\EmptyIndexException; use S2\Rose\Storage\Database\PdoStorage; use S2\Rose\Stemmer\PorterStemmerRussian; use S2\Rose\Indexer; use S2\Rose\Entity\Indexable; use S2\Rose\Entity\Query; use S2\Rose\Finder; use S2\Rose\SnippetBuilder; function e2m_found($parameters=array ()) { global$_strings,$_config,$settings,$full_blog_url; $parameters['query']=trim($parameters['query']); $q1b1cc=$parameters['query']; if (!$q1b1cc){ return array ( 'title' => $_strings['pt--search-query-empty'], 'heading' => $_strings['pt--search'], 'nothing' => $_strings['gs--search-query-empty'], ); } $kf79b1="AND `IsVisible`=1 "; if (ve852())$kf79b1=''; $c11128=false; if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `Keyword`='". u7928($q1b1cc)."'" )) { $wfa816=r0d6b(); if (isset ($wfa816[0]['ID'])) { $c11128=array ( 'href' => y83c8('e2m_tag', array ('*tag' => $wfa816[0])), 'name' => htmlspecialchars($q1b1cc,ENT_NOQUOTES,HSC_ENC), ); } } $a4dd42=v163d(' ',$parameters['query']); $hfce9c=new PorterStemmerRussian(); foreach ($a4dd42 as $c8ce4b => $l9e366){ $a4dd42[$c8ce4b]=$hfce9c -> stemWord($a4dd42[$c8ce4b]); } $z8e830=array(); if(SEARCH_USE_ROSE){ try { $uddece=f476c(); $j5b9bd=new Finder($uddece,$hfce9c); $j5b9bd -> setHighlightTemplate('<mark>%s</mark>'); $yf7de9=new Query($q1b1cc); $yf7de9 -> setLimit(SEARCH_LIMIT); $resultSet=$j5b9bd -> find($yf7de9); foreach($resultSet -> getFoundExternalIds() as $h0e684){ if ($h0e684[0]=='n'){ $y21158=substr($h0e684,1); $uaad65=j4627($y21158); if ($uaad65['IsFavourite']) { $resultSet->setRelevanceRatio($h0e684, @$_config['search_favourites_boost']); } } } $snippetBuilder=new SnippetBuilder($hfce9c); $snippetBuilder -> setSnippetLineSeparator(' · '); $snippetBuilder -> attachSnippets($resultSet, function (array $gbf516){ $result=array(); foreach(array_slice($gbf516,0,SEARCH_SNIPPETS_LIMIT) as $h0e684){ if ($h0e684[0]=='n'){ $y21158=substr($h0e684,1); $f39a37=@j4627($y21158); if ($f39a37){ $f39a37['_']['_id']=$y21158; $uaad65=j6791($f39a37); $result[$h0e684]=$uaad65['text']; } } } return$result; }); foreach($resultSet -> getItems() as $h0e684 => $f447b7){ if ($h0e684[0]=='n'){ $y21158=substr($h0e684,1); $uaad65=j4627($y21158); $uaad65['_']['_id']=$y21158; $uaad65['_']['_srprovider']='rose'; $uaad65['_']['_rose_relevance']=$f447b7 -> getRelevance(); $uaad65['_']['_rose_title']=$f447b7 -> getHighlightedTitle($hfce9c); $uaad65['_']['_rose_snippet']=$f447b7 -> getSnippet(); if ($uaad65['IsPublished'] and ($uaad65['IsVisible'] or ve852())) { $z8e830[] = $uaad65; } } } if($_config['rose_debug_info']) { $y1e441=print_r($resultSet -> getTrace(),true); } } catch (EmptyIndexException $e){} } if(1 and SEARCH_USE_MYSQL){ $l36a38=u7928(preg_quote($q1b1cc)); $reb31b=( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND MATCH (`Title`, `Text`) AGAINST ('". $l36a38 ."')". $kf79b1 ." ". "LIMIT ". SEARCH_LIMIT ); if (o0738($reb31b)) { $result=r0d6b(); foreach($result as $c8ce4b => $uaad65){ $uaad65['_']['_id']=$uaad65['ID']; $uaad65['_']['_srprovider']='mysql'; $z8e830[] = $uaad65; } } } $lfbdf2=array(); $o4358b=array(); $q865c0=0; foreach ($z8e830 as $f39a37){ if (!in_array($f39a37['ID'],$lfbdf2)) { $uaad65=j6791($f39a37); if (@$uaad65['_']['_rose_title']) { $uaad65['title']=$uaad65['_']['_rose_title']; } else { $uaad65['title']=j4c2d($uaad65['title'],$a4dd42); } $uaad65['title']=g6f10($uaad65['title']); if (@$uaad65['_']['_rose_snippet']) { $uaad65['text']='<p>'. $uaad65['_']['_rose_snippet'] .'</p>'; } else { $h1cb25=$uaad65['text']; $h1cb25=preg_replace('/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/i','',$h1cb25); $h1cb25=preg_replace('/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/i','',$h1cb25); $h1cb25=str_replace( array ( '<br>', '<br/>', '<br />', '</h1>', '</h2>', '</h3>', '</h4>', '</h5>', '</h6>', '</p>', '</pre>', '</blockquote>', '</li>', ), ' ', $h1cb25 ); $h1cb25=strip_tags($h1cb25); $xad7ba=array(); $g9cc49=preg_split('/[\\n\(\)\[\]]|[.:;?!](\s|$)/uis',$h1cb25); $g363b1=0; $x02db3=''; foreach ($g9cc49 as $hd866f){ $hd866f=trim($hd866f); if (!$hd866f) continue; if (!$x02db3)$x02db3=$hd866f; $h870c2=$hd866f; $h870c2=j4c2d($h870c2,$a4dd42); if ($h870c2!=$hd866f){ $xad7ba[] = v48d8($h870c2); $g363b1 ++; if ($g363b1 > 3) break; } } if(count($xad7ba)) { $uaad65['text']='<p>'. implode(' · ',$xad7ba) .'</p>'; } else { $uaad65['text']='<p>'. $x02db3 .'</p>'; } } $uaad65['has-highlighed-thumbs?']=false; if ($o55b55=@$uaad65['format-info']['resources-detected']) { $k750fa=g2e82($o55b55); foreach ($k750fa as $c8ce4b => $l9e366){ $k750fa[$c8ce4b]['highlighted?'] = ( strstr($l9e366['original-filename'],$q1b1cc)!==false ); if ($k750fa[$c8ce4b]['highlighted?']) { $uaad65['has-highlighted-thumbs?']=true; } } $uaad65['thumbs']=$k750fa; } $o4358b[] = $uaad65; $lfbdf2[] = $f39a37['ID']; $q865c0 ++; if ($q865c0 >= SEARCH_LIMIT) break; } } $ffbb44=count($o4358b); if ($ffbb44){ $x5cde2=e2l_get_string( 'pt--n-posts', array ('number' => $ffbb44) ); } else { $x5cde2=$_strings['pt--no-posts']; $i2cb9d['nothing']=$_strings['gs--nothing-found']; } if ($q865c0 >= SEARCH_LIMIT){ $x5cde2=$_strings['gs--many-posts']; } if ($c11128){ $i2cb9d['search-related-tag']=$c11128; } $i2cb9d['notes']=$o4358b; $i2cb9d['pages'] = array (); $i2cb9d['title']=$x5cde2 .' '. $_strings['gs--found-for-query'] .': '. htmlspecialchars($q1b1cc,ENT_NOQUOTES,HSC_ENC); $i2cb9d['superheading']=$x5cde2 .' '. $_strings['gs--found-for-query']; $i2cb9d['heading']=$q1b1cc; if (@$y1e441){ $i2cb9d['rose-debug-info']=$y1e441; } return $i2cb9d; } function e2s_search(){ $q1b1cc=@$_POST['query']; $q1b1cc=str_replace('?',urlencode('?'),$q1b1cc); $q1b1cc=str_replace('/',' ',$q1b1cc); $q1b1cc=trim($q1b1cc); $q1b1cc=str_replace(' ','+',$q1b1cc); e2_go_to(y83c8('e2m_found', array ('query' => $q1b1cc))); die; } function e2s_bsi_status(){ global$_db,$_config; echo '<pre>'; echo '/@bsi/step/ — Make one step of indexing<br />'; echo '/@bsi/drop/ — Drop indexes<br /><br />'; $ze1fab=@unserialize(file_get_contents(USER_FOLDER.'indexing.psa')); if (!is_array($ze1fab))$ze1fab=array ('spent' => '?'); if (u0f7c() and $_db['link']) { $g34421=$ie0d69='?'; if (o0738( "SELECT count(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 " )) { $c9b207=r0d6b(); $g34421=$c9b207[0]['c']; } if (o0738( "SELECT count(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsIndexed`=1 AND `IsPublished`=1 " )) { $c9b207=r0d6b(); $ie0d69=$c9b207[0]['c']; } $rd1647=round($ie0d69/$g34421*100); echo 'Indexed '. $ie0d69 .' notes of '. $g34421 .' ('. $rd1647 .'%)<br />'; echo 'Spent '. $ze1fab['spent'] .' s (or more)'; } else { echo 'DB unaccessible'; } die ('</pre>'); } function e2s_bsi_step(){ global$_db,$_config,$_strings; if(__LOG)__log('BSI step'); if (!g3b97()) { die ('Not indexing</pre>'); } $ze1fab=@unserialize(file_get_contents(USER_FOLDER.'indexing.psa')); if (!is_array($ze1fab))$ze1fab=array ('spent' => '?'); if ( !isset ($ze1fab['lock']) or $ze1fab['lock'] < time() - (BSI_GIVE_UP_TIMEOUT+BSI_UNLOCK_TIMEOUT) ) { if (isset ($ze1fab['lock'])) { echo 'Old lock: '. $ze1fab['lock'] .'<br />'; } else { echo 'No old lock<br />'; } $ze1fab['lock']=time(); if (!@t6e52(USER_FOLDER.'indexing.psa',serialize($ze1fab))) { echo 'Can’t get a new lock<br />'; die; } echo 'New lock: '. $ze1fab['lock'] .'<br /><br />'; if (u0f7c() and $_db['link']) { $q865c0=0; $d680a2=0; $ice2fc=w7f78(); $v30d94=false; while ($d680a2 < BSI_GIVE_UP_TIMEOUT){ if (o0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsIndexed`=0 AND `IsPublished`=1 ". "ORDER BY `Stamp` DESC ". "LIMIT ". BSI_SELECT_PORTION )) { $c9b207=r0d6b(); } if(count($c9b207)) { echo 'Portion '. ++$q865c0 .'<br />'; foreach ($c9b207 as $bea59a){ echo 'Indexing: '. $bea59a['Title'] .'<br />'; $bea59a['IsIndexed']='1'; if (eaa79('Notes',$bea59a)) { pd2e1($bea59a); if($_config['broadcast_on_indexing']) { ieb3b($bea59a); } } } $d680a2=round(w7f78()-$ice2fc,3); echo 'Done '. count($c9b207) .', spent '. $d680a2 .' ms so far<br /><br />'; } else { $v30d94=true; break; } } if ($v30d94){ echo 'Indexing done<br /><br />'; @unlink(USER_FOLDER.'indexing.psa'); } else { echo 'Time out<br />'; unset ($ze1fab['lock']); $ze1fab['done']=count($c9b207); if ($ze1fab['spent']!='?')$ze1fab['spent']+=$d680a2; @t6e52(USER_FOLDER.'indexing.psa',serialize($ze1fab)); } } else { echo 'DB unaccessible<br />'; } } else { echo 'Locked<br />'; } die ('</pre>'); } function e2s_bsi_drop(){ global$_db,$_config; if (u0f7c() and $_db['link']) { echo '<pre>'; if (ya521()) { echo 'All notes marked for reindexing<br />'; $uddece=f476c(); $uddece -> erase(); echo 'Indexes dropped<br />'; } else { echo 'DB error: '. mysqli_error($_db['link']).'<br />'; } g198f(); die ('</pre>'); } die ('<pre>DB unaccessible</pre>'); } define('BSI_SELECT_PORTION',10); define('BSI_GIVE_UP_TIMEOUT',10); define('BSI_UNLOCK_TIMEOUT',10); function g198f(){ $ze1fab=array(); @t6e52(USER_FOLDER.'indexing.psa',serialize($ze1fab)); } function g3b97(){ return (is_file(USER_FOLDER.'indexing.psa')); } function pd2e1($f39a37){ static $nf4540=null; try { if ($nf4540===null){ $hfce9c=new PorterStemmerRussian(); $nf4540=new Indexer(f476c(),$hfce9c); } $m2bfe4=a154e($f39a37['FormatterID'], @$f39a37['Text'],'full-rss'); hfc4d($f39a37,$m2bfe4); $h1cb25=strip_tags($m2bfe4['text-final']); $f3e961=new Indexable( 'n'. $f39a37['ID'], $f39a37['Title'], $h1cb25 ); return $nf4540 -> index($f3e961); } catch (Exception $e){ return false; } } function j10fe($xb80bb){ static $nf4540=null; try { if ($nf4540===null){ $hfce9c=new PorterStemmerRussian(); $nf4540=new Indexer(f476c(),$hfce9c); } return $nf4540 -> removeById('n'. $xb80bb); } catch (Exception $e){ return false; } } function u713e($ia2f2e){ $k851f5='S2\\Rose\\'; $k32fcc=__DIR__.'/library/rose/'; $ef5a8e=strlen($k851f5); if(strncmp($k851f5,$ia2f2e,$ef5a8e)!==0) return; $ae1cb9=substr($ia2f2e,$ef5a8e); $m8c7dd=$k32fcc.str_replace('\\','/',$ae1cb9).'.php'; if(file_exists($m8c7dd)) require $m8c7dd; } function f476c(){ global$_config,$settings; static $u88131=null; if ($u88131===null){ $ucf66e=new \PDO( 'mysql:'. 'host='. $settings['db']['server'] .';'. 'dbname='. $settings['db']['name']. ';'. 'charset=utf8', $settings['db']['user_name'], uee85($settings['db']['passw']) ); $ucf66e -> setAttribute(\PDO::ATTR_ERRMODE, \PDO::ERRMODE_EXCEPTION); $u88131=new PdoStorage( $ucf66e, $_config['db_table_prefix'].SEARCH_EXTRA_PREFIX, array ( PdoStorage::TOC => 'Contents', PdoStorage::WORD => 'Word', PdoStorage::FULLTEXT_INDEX => 'Fulltext', PdoStorage::KEYWORD_INDEX => 'Keyword', PdoStorage::KEYWORD_MULTIPLE_INDEX => 'KeywordMultiple', ) ); } return $u88131; } function j4c2d($h1cb25,$a4dd42){ foreach ($a4dd42 as $y2510c){ if ($y2510c=='-') continue; $y2510c=preg_quote($y2510c,'/'); $y2510c=str_replace('е','[её]',$y2510c); $y2510c=str_replace('Е','[ЕЁ]',$y2510c); $h1cb25=preg_replace('/(?<=^|\W)('.$y2510c.'[\w\p{M}]*)/iu','<mark>$1</mark>',$h1cb25); } $h1cb25=str_replace('</mark> <mark>',' ',$h1cb25); $h1cb25=str_replace('</mark> <mark>',' ',$h1cb25); return $h1cb25; } function v48d8($d341be){ $ie05fe=mb_strtoupper(mb_substr($d341be,0,1)); return $ie05fe.mb_substr($d341be,1); } function ya521(){ global$_config; return o0738( "UPDATE `". $_config['db_table_prefix']."Notes` ". "SET `IsIndexed`=0" ); } function e2_check_timeout(){ static $t90272; if(is_null($t90272)) { $kf48ef=ini_get('max_execution_time'); if ($kf48ef){ $t90272=time()+$kf48ef-5; } else { $t90272=0; } } return ($t90272==0)?true:$t90272 >= time(); } function e2_write_dump_header($m8c7dd){ $i099fb=( 'SET SQL_MODE="NO_AUTO_VALUE_ON_ZERO";' .PHP_EOL. 'SET AUTOCOMMIT=0;' .PHP_EOL. 'START TRANSACTION;' .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;" .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;" .PHP_EOL. "/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;" .PHP_EOL. "/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;" .PHP_EOL. "/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;" .PHP_EOL. "/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=NO_AUTO_VALUE_ON_ZERO */;" .PHP_EOL. "/*!40101 SET NAMES utf8 */;" .PHP_EOL. '' ); fwrite($m8c7dd,$i099fb); return true; } function e2_write_dump_footer($m8c7dd){ $u251d1='COMMIT;' .PHP_EOL; $u251d1 .= "/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;" .PHP_EOL ."/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;" .PHP_EOL ."/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;".PHP_EOL ."/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;" .PHP_EOL; fwrite($m8c7dd,$u251d1); return true; } function e2_get_table_definition($t0c1d0,$paab9e){ $d5c286=null; $result=mysqli_query($t0c1d0,"SHOW CREATE TABLE `{$paab9e}`"); if($result){ $h47c80=mysqli_fetch_array($result); $d5c286=$h47c80['Create Table']; } return $d5c286; } function e2_write_table_definition($m8c7dd,$t0c1d0,$paab9e){ $a30618=e2_get_table_definition($t0c1d0,$paab9e); if(e2_check_timeout() && $a30618){ fwrite($m8c7dd,$a30618); fwrite($m8c7dd,';'); fwrite($m8c7dd,PHP_EOL.PHP_EOL); return true; } return false; } function e2_get_table_data($t0c1d0,$paab9e,$m7a86c,$gaa9f7){ $q1b1cc="SELECT * FROM `{$paab9e}` LIMIT {$m7a86c}, {$gaa9f7}"; $result=mysqli_query($t0c1d0,$q1b1cc); if (!$result){ return false; } $z66e9c=''; $b3c41a="INSERT INTO `{$paab9e}` VALUES"; while ($zf1965=mysqli_fetch_assoc($result)) { $e691d5=array(); foreach($zf1965 as $g2063c){ $e691d5[] = is_null($g2063c)?"NULL":"'".mysqli_real_escape_string($t0c1d0,$g2063c)."'"; } $z66e9c.=$b3c41a.'('.join(', ',$e691d5).');'.PHP_EOL; } return $z66e9c; } function e2_table_disable_keys($paab9e){ return "ALTER TABLE `{$paab9e}` DISABLE KEYS;".PHP_EOL; } function e2_table_enable_keys($paab9e){ return "ALTER TABLE `{$paab9e}` ENABLE KEYS;".PHP_EOL; } function e2_get_total_records($t0c1d0,$paab9e){ $c8ce4b=mysqli_fetch_row(mysqli_query($t0c1d0,"SELECT COUNT(*) FROM `{$paab9e}`")); return $c8ce4b[0]; } function e2_write_table_data($m8c7dd,$t0c1d0,$paab9e){ $ffbb44=e2_get_total_records($t0c1d0,$paab9e); $m7a86c=0; $gaa9f7=1000; $result=true; $n47495=20000; $f80fc1=30; if ($ffbb44){ $yfbda5=e2_table_disable_keys($paab9e); fwrite($m8c7dd,$yfbda5); } $z66e9c="INSERT INTO `{$paab9e}` VALUES"; $wde57a=$ffbb44; while ($wde57a > 0){ $q1b1cc="SELECT * FROM `{$paab9e}` LIMIT {$m7a86c}, {$gaa9f7}"; $result=mysqli_query($t0c1d0,$q1b1cc); $bb428d=mysqli_num_rows($result); if (!$result || !e2_check_timeout()) { $result=false; break; } $ydf347=array(); $u4b3a6=0; $fb6539=0; while ($zf1965=mysqli_fetch_assoc($result)) { if (!e2_check_timeout()) { $result=false; break; } $bb428d--; $a54ca8=array(); foreach($zf1965 as $g2063c){ $a54ca8[] = is_null($g2063c)?"NULL":"'".mysqli_real_escape_string($t0c1d0,$g2063c)."'"; } $p8d777='('.join(', ',$a54ca8).')'; $u4b3a6+=strlen($p8d777); $ydf347[] = $p8d777; $fb6539++; if ( ($u4b3a6 >= $n47495) || ($fb6539 >= $f80fc1) || ($bb428d==0)) { $q1b1cc=$z66e9c.join(', ',$ydf347).';'; fwrite($m8c7dd,$q1b1cc); fwrite($m8c7dd,PHP_EOL); $u4b3a6=0; $fb6539=0; $ydf347=array(); } } $m7a86c+=$gaa9f7; $wde57a -= $gaa9f7; } if ($ffbb44){ $r6bfc4=e2_table_enable_keys($paab9e); fwrite($m8c7dd,$r6bfc4); } return$result; } function e2_backup($t0c1d0,$a9ab2e,$ga9745,$y93da6=array()) { mysqli_query($t0c1d0,"SET NAMES utf8"); $w2beda=tmpfile(); e2_write_dump_header($w2beda); if(__LOG)__log('DB Backup: wrote header'); $g75101=true; foreach($a9ab2e as $paab9e){ if(__LOG)__log('DB Backup: table '. $paab9e); $i91e7e=e2_write_table_definition($w2beda,$t0c1d0,$paab9e); if(__LOG)__log('DB Backup: wrote table definition with result '. (int)$i91e7e); $g35285=e2_write_table_data($w2beda,$t0c1d0,$paab9e); if(__LOG)__log('DB Backup: wrote table data with result '. (int)$g35285); $g75101=$i91e7e && $g35285; if ($g75101===false){ break; } } if(__LOG)__log('DB Backup: wrote data with running == '. (int)$g75101); if ($g75101){ e2_write_dump_footer($w2beda); fseek($w2beda,0); $m8c7dd=fopen($ga9745,'w+'); while ($g75101 && ($p8d777=fread($w2beda,1024))) { if(e2_check_timeout()) { fwrite($m8c7dd,$p8d777); } else { $g75101=false; } } fclose($m8c7dd); } fclose($w2beda); return $g75101; } function u3e5c($x0c426,$content){ $k52766=MTMPL_FOLDER.$x0c426 .'.mtmpl.php'; if(is_file($k52766)) { ob_start(); include $k52766; $zde7a3=ob_get_contents(); ob_end_clean(); return trim($zde7a3); } } function oaed2(){ global$_config,$_superconfig; $v9e35a=$_config['mail_from']; if (@$_superconfig['mail_from']) { $v9e35a=$_superconfig['mail_from']; } if ($v9e35a[strlen($v9e35a)-1]=='@'){ $v9e35a.=$_SERVER['HTTP_HOST']; } return $v9e35a; } function aa41b($z01b6e,$subject,$s78e73,$b145a2=''){ global$_superconfig; if (@$_superconfig['mail_debug']) { $b8fa14=tempnam('mail-debug',''); $h1cb25=( 'To:       '.$z01b6e ."\n". 'Subject:  '.$subject ."\n". $b145a2 ."\n". "--------------------------------------------------\n". $s78e73 ); t6e52($b8fa14,$h1cb25); chmod($b8fa14,NEW_FILES_RIGHTS); rename($b8fa14,$b8fa14.'.txt'); } $subject='=?UTF-8?B?'. base64_encode($subject) .'?='; $b145a2.="\r\nContent-Type: text/plain; charset=utf-8"; mail($z01b6e,$subject,$s78e73,trim($b145a2)); } function _A($h1cb25){ global$_candy,$_protocol,$x57de2,$aa57c1,$_current_url; if ( preg_match('/\<a href\=\"(.*?)\"[^>]*\>(.*?)\<\/a\>/si',$h1cb25,$b9c28d) and ( $b9c28d[1]=='' or $b9c28d[1]==$_current_url or $_protocol .'://'. $x57de2.$b9c28d[1]==$_current_url or $_protocol .'://'. $x57de2.$aa57c1 .'/'. $b9c28d[1]==$_current_url or $_candy=='e2m_install' ) ) { return $b9c28d[2]; } else { return $h1cb25; } } function _AT($qe8fab){ global$_candy,$x57de2,$aa57c1,$_current_url; return ( $qe8fab=='' or $qe8fab==$_current_url or $_protocol .'://'. $x57de2.$qe8fab==$_current_url or $_protocol .'://'. $x57de2.$aa57c1 .'/'. $qe8fab==$_current_url ); } function _IMGSRC($n435ed){ return b1492($n435ed); } function _SVG($n435ed){ return cf42c($n435ed); } function _COLOR($xf97c5,$hb8a9f,$gcc321,$f4efa2=1){ if(strlen($xf97c5)!=3 and strlen($xf97c5)!=6) return 'f0f'; if(strlen($hb8a9f)!=3 and strlen($hb8a9f)!=6) return 'f0f'; if(strlen($xf97c5)==3)$xf97c5=$xf97c5{0}.$xf97c5{0}.$xf97c5{1}.$xf97c5{1}.$xf97c5{2}.$xf97c5{2}; if(strlen($hb8a9f)==3)$hb8a9f=$hb8a9f{0}.$hb8a9f{0}.$hb8a9f{1}.$hb8a9f{1}.$hb8a9f{2}.$hb8a9f{2}; $cf09cc=array ( $xf97c5{0}.$xf97c5{1}, $xf97c5{2}.$xf97c5{3}, $xf97c5{4}.$xf97c5{5}, $hb8a9f{0}.$hb8a9f{1}, $hb8a9f{2}.$hb8a9f{3}, $hb8a9f{4}.$hb8a9f{5}, ); foreach ($cf09cc as $c8ce4b => $l9e366){ $cf09cc[$c8ce4b]=hexdec($l9e366); } $f22af6=array ( $cf09cc[0]+pow($gcc321,$f4efa2) * ($cf09cc[3]-$cf09cc[0]), $cf09cc[1]+pow($gcc321,$f4efa2) * ($cf09cc[4]-$cf09cc[1]), $cf09cc[2]+pow($gcc321,$f4efa2) * ($cf09cc[5]-$cf09cc[2]), ); $y70dda=''; foreach ($f22af6 as $c8ce4b => $l9e366){ $y70dda.=str_pad(dechex($l9e366),2,'0',STR_PAD_LEFT); } return $y70dda; } function _DT($t1ddcb,$yb35c6){ if (!$yb35c6) return ''; list ($e96b8c,$eb2c6c)=$yb35c6; $i2cb9d=$t1ddcb; $t7436f=a5a2f('m',$e96b8c,$eb2c6c); $i2cb9d=str_replace('{zone}',e2__escape_all(k9515($eb2c6c['offset'])), $i2cb9d); $i2cb9d=str_replace('{month}',e2__escape_all(e2l_get_string('um--month', array ('month' => $t7436f))), $i2cb9d); $i2cb9d=str_replace('{month-short}',e2__escape_all(e2l_get_string('um--month-short', array ('month' => $t7436f))), $i2cb9d); $i2cb9d=str_replace('{month-g}',e2__escape_all(e2l_get_string('um--month-g', array ('month' => $t7436f))), $i2cb9d); $i2cb9d=a5a2f($i2cb9d,$e96b8c,$eb2c6c); return $i2cb9d; } function _AGO($yb35c6){ return i7a0b($yb35c6[0], array ('offset' => $yb35c6[1]['offset'],'is_dst' => $yb35c6[1]['is_dst']) ); } function _NUM($h1cb25){ return e2_decline_for_number($h1cb25); } function _FIRST($s437b9){ return ($s437b9['_']['_ord']==0); } function _LAST($s437b9){ return ($s437b9['_']['_ord']==$s437b9['_']['_ord_max']); } function _CSS($ec7a62){ return sd4c1($ec7a62); } function _CSS_HREF($ec7a62){ return i576f($ec7a62); } function _JS($r32981){ return ld00a($r32981); } function _LIB($ue8acc){ return w16f0($ue8acc); } function _T($m52678){ return u166b($m52678); } function _X($m52678){ return r6a97($m52678); } function _T_FOR($m52678,$zd5566=null){ global$content; if ($zd5566===null)$zd5566=$m52678; if(array_key_exists($zd5566,$content)) { u166b($m52678); } else { return ''; } } function _GUIDES($xeca07=false){ global$_olba_guides; if(is_array($xeca07))$_olba_guides=$xeca07; if (!is_array($_olba_guides)) return; $t88408='<div style="position: fixed; width: 100%; height: 100%; z-index: -100">'; $l1d623=0; $m07d43=$_olba_guides; $m07d43[] = 100; foreach ($m07d43 as $q865c0 => $kd89e2){ if ($kd89e2==100) break; $l1d623+=$kd89e2; $t88408.='<div style="position: fixed; left: '. $kd89e2 .'%; width: 0; height: 100%; border-left: 1px #000 dotted; opacity: .2; -webkit-opacity: .2; -moz-opacity: .2"></div>'; $sa1b01='position: absolute; padding: 2px 3px; top: 0; font-size: 9px; background: #ccc; color: #000; font-family: "Verdana", sans-serif; opacity: .8; -webkit-opacity: .8; -moz-opacity: .8'; if ($m07d43[$q865c0+1]-$m07d43[$q865c0] < 4){ $t88408.='<div style="'. $sa1b01.'; right: '. (100-$kd89e2) .'%; border-bottom-left-radius: .5em; -webkit-border-bottom-left-radius: .5em; -moz-border-bottom-left-radius: .5em;">'. $kd89e2 .'%</div>'; } else { $t88408.='<div style="'. $sa1b01.'; left: '. $kd89e2 .'%; border-bottom-right-radius: .5em; -webkit-border-bottom-right-radius: .5em; -moz-border-bottom-right-radius: .5em;">'. $kd89e2 .'%</div>'; } } $t88408.='</div>'; $_olba_current_col=0; return $t88408; } function _S($jb45cf){ global$_strings; return$_strings[$jb45cf]; } function _SHORTCUT($ib0689){ return kbb8d($ib0689); } function e2__escape_all($jb45cf){ $i2cb9d=''; for ($q865c0=0; $q865c0 < mb_strlen($jb45cf); ++ $q865c0){ $i2cb9d.='\\'. mb_substr($jb45cf,$q865c0,1); } return $i2cb9d; } function e2l_get_string($ofa206,$p8d777){ global$_strings; $ib0689=$_strings[$ofa206]; if(preg_match_all('/\$\[(.+?)\]/u',$ib0689,$b9c28d,PREG_SET_ORDER)) { foreach ($b9c28d as $be3cc9){ $mb2145=$be3cc9[1]; $vf2ffc=''; if(strstr($mb2145,'.')) list ($mb2145,$vf2ffc)=explode('.',$mb2145,2); if(array_key_exists($mb2145,$p8d777)) { if ($vf2ffc){ $ib0689=str_replace($be3cc9[0],e2l__format_value($vf2ffc,$p8d777[$mb2145],$ofa206),$ib0689); } else { $ib0689=str_replace($be3cc9[0],$p8d777[$mb2145],$ib0689); } } } } return $ib0689; } function e2l_transliterate($jb45cf){ $ye358e=array(); if(is_file(DEFAULTS_FOLDER.'translit.txt')) { $ye358e=file(DEFAULTS_FOLDER.'translit.txt'); } $jd98a0=$z01b6e=''; foreach ($ye358e as $q865c0 => $q6438c){ if (!($q865c0%2))$jd98a0.=rtrim($q6438c) .' '; else $z01b6e.=rtrim($q6438c) .' '; if ($q865c0%2){ while (mb_strlen($z01b6e) < mb_strlen($jd98a0))$z01b6e.=' '; while (mb_strlen($z01b6e) > mb_strlen($jd98a0))$jd98a0.=' '; } } $m60ae1=''; $ade2e7=-1; for ($q865c0=0; $q865c0 < mb_strlen($jd98a0); ++ $q865c0){ $y4a8a0=mb_substr($jd98a0,$q865c0,1); if ($y4a8a0!=' '){ $m60ae1.=$y4a8a0; if ($ade2e7 == -1)$ade2e7=$q865c0; } elseif ($m60ae1){ $n52ac1=trim(mb_substr($z01b6e,$ade2e7,mb_strpos($z01b6e,' ',$ade2e7+1)-$ade2e7)); $e33c9b=array ($m60ae1,$n52ac1); $sce83f[mb_strlen($m60ae1)][] = $e33c9b; $m60ae1=''; $ade2e7=-1; } } $o1d78d=array(); for ($q865c0=count($sce83f); $q865c0 > 0; -- $q865c0){ foreach ($sce83f[$q865c0] as $e33c9b)$o1d78d[$e33c9b[0]] = $e33c9b[1]; } return strtr($jb45cf,$o1d78d); } function e2l__format_value($vf2ffc,$g2063c,$ofa206){ list ($vf2ffc,$p3ad73)=explode('.',$vf2ffc,2); $be6875='e2lstr_'. $vf2ffc; if(function_exists($be6875)) { return call_user_func($be6875,$g2063c,$p3ad73,$ofa206); } else { return $g2063c; } return $g2063c; } spl_autoload_register(u713e); if($_config['write_log_reset'])__log(null); if(__LOG)__log('System: loaded'); if(is_file($u2d354=LANGUAGES_FOLDER.$settings['language'] .'.php')) { $_lang=$settings['language']; include $u2d354; } elseif(is_file($u2d354=LANGUAGES_FOLDER.DEFAULT_LANGUAGE .'.php')) { $_lang=DEFAULT_LANGUAGE; include $u2d354; } else { die ('Language file missing: '. $u2d354); } $_strings=e2l_load_strings(); if(!$f589b3) @include 'builder.php'; function e2(){ global $x57de2,$settings,$errors,$content, $aa57c1,$full_blog_url,$stopwatch,$p11755, $_current_url, $_newsfeeds, $_instance, $_candy, $_config, $_superconfig, $_route, $_strings, $_lang, $_candies_installer, $_candies_public, $_candies_indexable, $_candies_indexable_conditionally, $_candies_ajax, $_candies_to_disallow_in_read_only, $_user_folder_name, $_template, $_olba_includes, $_diagnose; x269a(); if(__LOG)__log('System: go'); $errors=array(); header('Content-type: text/html; charset='. OUTPUT_CHARSET); $_instance=false; if (@is_file(USER_FOLDER.'instance.psa')) { $b0d149=@file_get_contents(USER_FOLDER.'instance.psa') or $b0d149=false; if ($b0d149){ $b0d149=@unserialize($b0d149) or $b0d149=false; if ($b0d149){ $_instance=$b0d149; } } } $v66f61=@$settings['template'] or $v66f61=DEFAULT_TEMPLATE; u4e27($v66f61); $j572d4=urldecode($_GET['go']); if(__LOG)__log('System: Resolve <'. $j572d4 .'> {'); w7059(); list ($zc48ba,$parameters)=gb7e9($j572d4); foreach($_GET as $r3c6e0 => $g2063c){ $parameters[$r3c6e0]=$g2063c; } if(__LOG)__log('} // Resolve'); if(__LOG)__log( 'System: Candy <'. $zc48ba .'> {' ); if(__LOG)__log('Parameters: <'. print_r($parameters,true).'>'); $_candy=$zc48ba; $content=array(); if ( @$_config['debug_slow_ajax'] and ( in_array($zc48ba,$_candies_ajax) ) ) { sleep(1+2 * (rand()/getrandmax())); } if (!in_array($zc48ba,$_candies_installer)) { e2_make_sure_that_installed(); } if (@$_superconfig['read_only'] and in_array($zc48ba,$_candies_to_disallow_in_read_only)) { $zc48ba='e2m_error404'; } $b58387=(bool)ve852(); $a0b448=!in_array($zc48ba,$_candies_public); $i49ecc=$a0b448 && !$b58387; if(__LOG)__log('System: signed in? '. (int)$b58387); $ic1f6f=array ( 'done?' => $b58387, 'required?' => $a0b448, 'necessary?' => $i49ecc, ); $_newsfeeds=false; f3010('rss',s6f51(),y83c8('e2m_rss')); f3010('json',s6f51(),y83c8('e2m_json')); if(is_callable($zc48ba)) { if ($i49ecc){ if(substr($zc48ba,0,4)=='e2s_'){ $content=call_user_func('e2s_sign_in_necessary'); } else { $content['title']=$_strings['pt--sign-in']; } } else { if(__LOG)__log('System: candy call'); $content=call_user_func($zc48ba,$parameters); if(__LOG)__log('System: candy return'); } } else { $ic1f6f['required?']=false; $ic1f6f['necessary?']=false; $content=e2_error404_mode(); } if(__LOG)__log('} // Candy'); if (!array_key_exists('notes',$content))$content['notes'] = array (); if (!array_key_exists('drafts',$content))$content['drafts'] = array (); if (!array_key_exists('comments',$content))$content['comments'] = array (); if (!array_key_exists('notes-list',$content))$content['notes-list'] = array (); if (!array_key_exists('tags',$content))$content['tags'] = array (); $content['class']=str_replace('_','-',str_replace('e2m_','',$zc48ba)); $content['sign-in']=$ic1f6f; $content['sign-in-prompt']=$_strings['gs--need-password']; if(e2_is_installed()) { if(__LOG)__log('System: nav and pages'); $content['navigation-links'] = array (array ( 'rel' => 'index', 'href' => y83c8('e2m_frontpage', array ('page' => 1)), 'id' => 'link-index', )); if(array_key_exists('pages',$content)) { foreach (array ('prev','next','earlier','later') as $gc47d1){ if(array_key_exists($gc47d1 .'-href',$content['pages'])) { $b7ffc4=$gc47d1; if ($gc47d1=='earlier')$b7ffc4='prev'; if ($gc47d1=='later')$b7ffc4='next'; $content['navigation-links'][] = array ( 'rel' => $b7ffc4, 'href' => $content['pages'][$gc47d1 .'-href'], 'id' => 'link-'. $gc47d1, ); } } } if(__LOG)__log('System: search form'); if(array_key_exists('query',$parameters)) { $q1b1cc=trim($parameters['query']); } else { $q1b1cc=''; } $content['search'] = array ( 'form-action' => y83c8('e2s_search'), 'query' => htmlspecialchars(@$q1b1cc,ENT_COMPAT,HSC_ENC), ); if(__LOG)__log('System: blog information'); $content['blog']['author']=htmlspecialchars(z2640(),ENT_NOQUOTES,HSC_ENC); if(array_key_exists('description',$settings)) { $m2bfe4=pb7f1($settings['description'],'full'); $c67daf=$m2bfe4['text-final']; $content['blog']['description']=$c67daf; $content['blog']['description-format-info']=$m2bfe4['meta']; } $content['blog']['title']=htmlspecialchars(s6f51(),ENT_NOQUOTES,HSC_ENC); $content['blog']['userpic-set?']=false; if($content['blog']['userpic-href']=i2461()) { $content['blog']['userpic-set?']=true; } else { $content['blog']['userpic-href']=DEFAULT_USERPIC_FILENAME; if (ve852()) { $content['blog']['userpic-href']=DEFAULT_USERPIC_PLACEHOLDER_FILENAME; } } $content['blog']['favicon-type']='image/x-icon'; $content['blog']['favicon-href']='favicon.ico'; if (ve852()) { $content['blog']['userpic-upload-action']=y83c8('e2j_userpic_upload'); } $content['blog']['href']=y83c8('e2m_frontpage', array ('page' => 1)); $content['blog']['rss-href']=y83c8('e2m_rss'); $content['blog']['jsonfeed-href']=y83c8('e2m_json'); $content['blog']['language']=$_lang; $content['blog']['show-subscribe-button?']=false; $content['template']['use-likely-light?']=$_template['use_likely_light']; if(__LOG)__log('System: edge timeinfo'); $b97bc5=array (time(),s5c05()); $b5f36b=da846('Y',$b97bc5[0]); $content['blog']['now']=$b97bc5; $maa103=$b5f36b; $l33b09=pcc02('start'); if(array_key_exists('stamp',$l33b09)) { $maa103=da846('Y',$l33b09['stamp']); $content['blog']['start-time'] = array ((int)$l33b09['stamp'],$l33b09['timezone']); } $o40d73=(int)c8ca0(true,true); if (ve852()) { if(__LOG)__log('System: stuff for logged in user'); $content['blog']['drafts-count'] = (int)c8ca0(false,true); $content['admin-hrefs'] = array ( 'new-note' => y83c8('e2m_write'), 'drafts' => y83c8('e2m_drafts'), 'settings' => y83c8('e2m_settings'), 'theme-preview' => y83c8('e2m_theme_preview', array ('theme' => '')), 'password' => y83c8('e2m_password'), 'database' => y83c8('e2m_database'), 'timezone' => y83c8('e2m_timezone'), 'logout' => y83c8('e2m_sign_out'), ); if (sda67()) { $content['admin-hrefs']['get-backup']=y83c8('e2m_get_backup'); } if (@$_superconfig['read_only']) { unset($content['admin-hrefs']['new-note']); unset($content['admin-hrefs']['settings']); unset($content['admin-hrefs']['timezone']); } if (@$_superconfig['disallow_themes_preview']) { unset($content['admin-hrefs']['theme-preview']); } if (@$_superconfig['disallow_db_config']) { unset($content['admin-hrefs']['database']); } list ($ife9e2,$w85ee4,$u20699)=e2a6b(); if ($ife9e2)$content['new-comments'] = array ( 'count' => $ife9e2, 'href' => $u20699, ); } else { if(__LOG)__log('System: login form'); $content['form-login']['form-action']=y83c8('e2s_sign_in'); $content['form-login']['form-check-password-action']=y83c8('e2j_check_password'); $content['form-login']['login-name'] = @$settings['author']; $content['form-login']['public-pc?']=false; if(array_key_exists('_login_request_message',$content)) { $content['form-login']['request']=$content['_login_request_message']; } } if (ve852()) { $rd0a87=(($o40d73 + (int)c8ca0(true,false)) == 0); } else { $rd0a87=($o40d73==0); } if($_db_error){ $rd0a87=false; } $n9fbfe=$_config['years_range_separator']? $_config['years_range_separator']:'&mdash;'; $content['blog']['years-range']=$maa103 . (($maa103==$b5f36b)? '':($n9fbfe.$b5f36b)); $content['blog']['notes-count']=$o40d73; $content['blog']['virgin?']=$rd0a87; if ($aa57c1){ $content['blog']['parent-site-href']=substr($aa57c1, (int)strpos('/',$aa57c1)); } $content['hrefs'] = array ( 'sign-in' => y83c8('e2m_sign_in'), 'tags' => y83c8('e2m_tags'), 'everything' => y83c8('e2m_everything'), ); } $z1e2ad='noindex, follow'; if (@$_config['index_follow_everything']) { $z1e2ad='index, follow'; } if(in_array($zc48ba,$_candies_indexable)) { $content['robots']='index, follow'; } if(in_array($zc48ba,$_candies_indexable_conditionally)) { $content['robots']=$z1e2ad; } $content['output-charset']=OUTPUT_CHARSET; $content['base-href']=$full_blog_url. '/'; $content['current-href']=$_current_url; if (!array_key_exists('summary',$content)) { $content['summary']=strip_tags($content['blog']['description']); } $content['title']=strip_tags(g6f10(htmlspecialchars($content['title'],ENT_NOQUOTES,HSC_ENC))); if (@$content['heading']) { $content['heading']=strip_tags(g6f10(htmlspecialchars($content['heading'],ENT_NOQUOTES,HSC_ENC))); } if(__LOG)__log('System: e2_modes {'); e2_modes($parameters); if(__LOG)__log('} // e2_modes'); if (@$_config['request_logging']) { $b8fa14=fopen(USER_FOLDER. 'log-'. date('Y-m-d') .'.txt','a'); fwrite($b8fa14,date('d.m.Y H:i:s') ."\tT = ". $content['pgt'] ."\tQ = ". $content['total_queries'] ."\tIP = ". $_SERVER['REMOTE_ADDR'] ."\tRequest = ". $_SERVER['REQUEST_URI'] ."\r\n"); fclose($b8fa14); } $content['misc']['sape-link']='http://www.sape.ru/r.206a4276c2.php'; $hc8542=round(w7f78()-$stopwatch,3); $ueccd7='http://'. $_strings['e2--website-host'] .'/'; $content['engine']['pgt']=str_replace('.',',',$hc8542); if(function_exists('memory_get_peak_usage')) { $content['engine']['mp']=str_replace('.',',',round((memory_get_peak_usage()/1024/1024)*100)/100); } $content['engine']['qc'] = (int) @$p11755; $content['engine']['built?']=$f589b3; $content['engine']['installed?']=e2_is_installed(); $content['engine']['version']='v'. E2_VERSION; $s68966='('. $_strings['e2--release'] .' '. E2_RELEASE .', v'. E2_VERSION .')'; $content['engine']['version-description']=$_strings['e2--vname-aegea'] .' '. $s68966; $content['engine']['user-folder-name']=$_user_folder_name; $content['engine']['cookie-prefix']=e8c3b(); $content['engine']['href']=$ueccd7; $content['engine']['about']='<span title="E2 '.$s68966 .'">'. $_strings['e2--powered-by'] .' <a href="'. $ueccd7 .'" class="nu"><u>'. $_strings['e2--vname-aegea'] .'</u> <span class="e2-svgi">'. _SVG('aegea') .'</span></a></span>'; $content['meta-viewport']=$_template['meta_viewport']; $content['stylesheets']=c37ca(); $content['scripts']=e4753(); if (!@isset ($_diagnose['ok?'])) { if (@$_COOKIE[e8c3b('diagnose')] or @$_diagnose['need?']) { y8739(); } } if ($be1671=fec07()) { $content['message']=$be1671; } if (ve852()) { $content['last-modifieds-by-id']='{}'; if (@$_COOKIE[e8c3b('local_copies')]) { $content['last-modifieds-by-id'] = ( sa2d8($_COOKIE[e8c3b('local_copies')]) ); } } $content['og-images'] = array (); if(is_array($content['notes']['only']['og-images'])) { $content['og-images']=$content['notes']['only']['og-images']; $content['twitter-card']='summary_large_image'; } if(is_array($content['tag']['og-images'])) { $content['og-images']=$content['tag']['og-images']; $content['twitter-card']='summary_large_image'; } if (!count($content['og-images'])) { $content['twitter-card']='summary'; $content['og-images'] = array ($content['blog']['userpic-href']); } ob_start(); obc21(); $a78e62=ob_get_contents(); ob_end_clean(); if(is_array($content['notes'])) { foreach($content['notes'] as $uaad65){ if(is_array($uaad65['format-info']['links-required'])) { foreach ($uaad65['format-info']['links-required'] as $f2a304){ if(substr($f2a304, -3)=='.js'){ ld00a(substr($f2a304,0, -3)); } if(substr($f2a304, -4)=='.css'){ sd4c1(substr($f2a304,0, -4)); } } } } } $content['stylesheets']=c37ca(); $content['scripts']=e4753(); if($_newsfeeds)$content['newsfeeds']=$_newsfeeds; ob_start(); u166b('head'); $v61ef8=ob_get_contents(); ob_end_clean(); ob_start(); u166b('scripts'); $mee59b=ob_get_contents(); ob_end_clean(); $a78e62=str_replace('<e2:head-data />',$v61ef8,$a78e62); $a78e62=str_replace('<e2:scripts-data />',$mee59b,$a78e62); $vfa6a9=false; if (g3b97()) { if(is_writable(USER_FOLDER.'indexing.psa')) { $vfa6a9=true; } else { $_diagnose['need?']=true; nc64a('diagnose','1'); } } if ( $xa0856=be655() and !$_config['ignore_missing_template_files'] ) { echo '<h1>Templates missing</h1>'; echo '<ul>'; foreach ($xa0856 as $h380ec){ echo '<li>'. $h380ec.' </li>'; } echo '</ul>'; echo '<pre>'; print_r($content); echo '</pre>'; } else { echo $a78e62; } if ($vfa6a9){ if(__LOG)__log('System: spawn BSI step'); ucc38(y83c8('e2s_bsi_step', array ())); } if(__LOG)__log('} // System'); if(DEV_TRACK_TIME and $x57de2==DEV_HOST){ $f06bc4=str_replace('.',',',round(w7f78()-$stopwatch,3)-$hc8542); echo '<div style="font-size: 300%; text-align: center; position: fixed; bottom: 0; width: 100%; background: #ffc; opacity: .88">'. '<span style="color: #f80">'. $content['engine']['pgt'] .' '. '<small>'. $content['engine']['qc'] .'q</small></span>'. '<span style="color: #08f"> + '. $f06bc4.' '. '<small>'. $_olba_includes .'i</small></span>'. '</div>'; } } if(__LOG)__log(''); ?>